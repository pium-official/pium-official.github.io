{"componentChunkName":"component---src-templates-post-jsx","path":"/dont-stop-deploy/","result":{"data":{"site":{"siteMetadata":{"title":"pium.log"}},"markdownRemark":{"id":"216f4636-4125-5765-83d8-a6a610692a41","excerpt":"이 글은 우테코 피움팀 크루 '주노', '그레이', '조이', '하마드'가 작성했습니다. 서론 다음 discussion으로부터 시작된 안건입니다.\ndiscussion - 무중단 배포 환경 구성 우리가 서버 한 대로 서비스를 운영한다고 가정해보자. 새로운 기능이 추가되고 배포되기 위해서는 애플리케이션을 빌드한 뒤 구동이 완료되어야한다. 이 과정에서 기존의 …","html":"<blockquote>\n<p>이 글은 우테코 피움팀 크루 '<a href=\"https://github.com/Choi-JJunho\">주노</a>', '<a href=\"https://github.com/kim0914\">그레이</a>', '<a href=\"https://github.com/yeonkkk\">조이</a>', '<a href=\"https://github.com/rawfishthelgh\">하마드</a>'가 작성했습니다.</p>\n</blockquote>\n<h2>서론</h2>\n<blockquote>\n<p>다음 discussion으로부터 시작된 안건입니다.\n<a href=\"https://github.com/woowacourse-teams/2023-pium/discussions/358\">discussion - 무중단 배포 환경 구성</a></p>\n</blockquote>\n<p>우리가 서버 한 대로 서비스를 운영한다고 가정해보자.</p>\n<p>새로운 기능이 추가되고 배포되기 위해서는 애플리케이션을 빌드한 뒤 구동이 완료되어야한다.</p>\n<p>이 과정에서 기존의 실행 중인 서버 프로세스를 종료한 후 새롭게 실행해야 한다.</p>\n<p>이 때 서비스를 이용 중인 사용자는 그 시간 동안 서비스를 이용할 수 없게 된다.</p>\n<p>V1 버전이 종료되고 V2 버전이 실행되는 그 사이, 즉 유저가 서비스를 이용할 수 없는 시간을 <strong>다운타임(downtime)</strong> 이라고 한다.</p>\n<h3>고가용성</h3>\n<p>다음 자료는 페이지 로드 속도가 늦어짐에 따라 사용자의 이탈률이 증가한다는 지표다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 70%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACNElEQVR42o2TW0/cMBCF+f+/oW+t1MIKXnjZggorWtQ+FNEq0KUF9hKWTTbO2kkcX3Lxnk5ciLQSqkj0ZZxJcnLGY+80TYMgCLBkESaTCay16HJ1XaOqqq34PO5o2xYvHTtaaewO9hCEY4zORhBCIM9zMMaQpik4554sy5AkiY+ZyGCMeVmwu2zcBq51cM71sXPwjM8/s3FoXNNjWnLs6m3BCzHGYfQZw9U3JCLFmqVIWIIoihDHsXftHVM+FgzjbIqA/8F1doff+RQLtdoW/FXMcMoucb4OIBvtHzhs/Ok2/+JrDy/YWa/Jti+jatASjaUGKItKW1hjoZSC1hqlKZFYjpWhKgxHTJFX+bbgOfuJ3fAYB4sRThffcTz9iiNieHeO4f0XhOslZF74ZgiZYV4ucS9DTOXCjxOz3hZcGEZlz3EjHxBImp9yhiviWs/9OG9K//JrSveCWSXByH6HVQaVNLCFgRISJaGK0rvrWBfcO7slA/dkoHM4ziZoqfu94ElygTfTQ7wNhxjMT/Dh7sjz/inuTo9xtryELlU/h5FmiHWKoi6RWuGXUy9oqCGyMSiJvFWewmlPTghXQjn7+i4z+mNMf3xQEbiiXZCTE1EgTwV4ksJIDUn3BaemCI6ZfMQNrb9A3CKkb27yCVKarl7wjP3Au/Aj9hYnGDyc4iAcYTD71LM/H2H/KfcoV7C0O0Rd+OWiW+Opn3aLFywpwWtJL0kfebPNuimw7gRoXG+a/5b8F7uNKPPMmziIAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='7e6334be' title='' src='/static/c5bfdadd5723b6580e00ceecb5b977db/ca1dc/7e6334be.png' srcset='/static/c5bfdadd5723b6580e00ceecb5b977db/e7570/7e6334be.png 170w,\n/static/c5bfdadd5723b6580e00ceecb5b977db/f46e7/7e6334be.png 340w,\n/static/c5bfdadd5723b6580e00ceecb5b977db/ca1dc/7e6334be.png 680w,\n/static/c5bfdadd5723b6580e00ceecb5b977db/1263b/7e6334be.png 1000w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n    </span>\n<a href=\"https://www.thinkwithgoogle.com/marketing-strategies/app-and-mobile/mobile-page-speed-new-industry-benchmarks/\">출처 - Think with Google</a></p>\n<p>애플리케이션이 아닌 배포 과정이 이러한 다운타임에 대한 영향을 미치는 것이 올바르지 못한 상황이라고 여겨진다.</p>\n<h3>무중단 배포 방식</h3>\n<p>무중단 배포는 말 그대로 <strong>서비스가 중단되지 않은 상태</strong>로, 새로운 버전을 사용자들에게 다운 타임 없이 배포하는 것을 의미한다. 무중단 배포를 하기 위해서는 최소 서버 2대 이상을 확보해야한다.</p>\n<p>무중단 배포에는 크게 3가지 방식이 있다.</p>\n<ol>\n<li>롤링(Rolling) 배포</li>\n<li>블루/그린 배포</li>\n<li>카나리(Canary) 배포</li>\n</ol>\n<h4>롤링 배포</h4>\n<ul>\n<li>트래픽을 점진적으로 구버전에서 새로운 버전으로 옮기는 방식이다.</li>\n<li>\n<p>점진적으로 트래픽을 어떻게 새로운 버전으로 옮길 수 있을까?</p>\n<ul>\n<li>\n<p>방식 1</p>\n<ul>\n<li>기존에 V1 서버를 3대 운영 중이라고 하자.</li>\n<li>우선 V2 인스턴스를 하나 추가한다. 로드 밸런서에 이 인스턴스를 연결한 후 기존 3대의 V1 서버를 하나씩 삭제한다.</li>\n<li>서버 개수를 유연하게 조절할 수 있는 클라우드를 기반으로 서비스를 운영할 때 적합할 것 같다.</li>\n</ul>\n</li>\n<li>\n<p>방식 2</p>\n<ul>\n<li>V1이 실행되고 있는 서버 하나를 로드 밸런서에서 떼어낸다.</li>\n<li>해당 서버에는 트래픽이 도달하지 않으므로 이 상태에서 해당 서버의 어플리케이션을 V2로 교체한다.</li>\n<li>이 과정을 반복하며 모든 서버를 V2로 교체한다.</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>장점</p>\n<ul>\n<li>롤링 배포 방식은 k8s, elastic beanstalk과 같은 많은 오케스트레이션 도구에서 지원하여 간편하다.</li>\n<li>또한 많은 서버 자원을 확보하지 않아도 무중단 배포가 가능하다.</li>\n</ul>\n</li>\n<li>\n<p>단점</p>\n<ul>\n<li>방식 2와 같은 경우 <strong>배포 도중 서비스 중인 인스턴스의 수가 줄어드게 되어 각각의 서버가 부담하는 트래픽의 양이 늘어날 수 있다.</strong></li>\n<li>구버전과 신버전의 어플리케이션이 동시에 서비스 되기 때문에 <strong>호환성 문제</strong>가 발생할 수 있다.</li>\n</ul>\n</li>\n</ul>\n<hr>\n<h4>블루/그린 배포</h4>\n<ul>\n<li>트래픽을 한 번에 구버전에서 신버전으로 옮기는 방법이다.</li>\n<li>현재 운영 중인 서비스 환경을 블루라고 부르고, 새롭게 배포할 환경을 그린.</li>\n<li>블루와 그린의 서버를 동시에 나란히 구성해둔 상태로 배포 시점에 로드 밸런서가 트래픽을 블루에서 그린으로 일제히 전환시킨다.</li>\n<li>그린 버전 배포가 성공적으로 완료 되었고, 문제가 없다고 판단할 때 블루 서버를 제거할 수 있다.</li>\n<li>\n<p>장점</p>\n<ul>\n<li>롤링 배포와 달리 한번에 트래픽을 모두 새로운 버전으로 옮기기 때문에 호환성 문제가 발생하지 않는다.</li>\n</ul>\n</li>\n<li>\n<p>단점</p>\n<ul>\n<li>실제 운영에 필요한 서버 리소스 대비 2배의 리소스를 확보해야 한다.</li>\n</ul>\n</li>\n</ul>\n<h4>카나리(Canary) 배포</h4>\n<ul>\n<li>점진적으로 구버전에 대한 트래픽을 신버전으로 옮기는 것은 롤링 배포 방식과 동일</li>\n<li>하지만 카나리 배포의 핵심은 새로운 버전에 대한 <strong>오류를 조기에 감지</strong>하는 것이다.</li>\n<li>소수 인원에 대해서만 트래픽을 새로운 버전에 옮겨둔 상태에서 서비스를 운영한다.</li>\n<li>A/B 테스트를 진행할 수 있다.</li>\n<li>\n<p>장점</p>\n<ul>\n<li>새로운 버전으로 인한 위험을 최소화할 수 있다.</li>\n</ul>\n</li>\n<li>\n<p>단점</p>\n<ul>\n<li>롤링 배포와 마찬가지로 호환성 문제가 발생할 수 있다.</li>\n</ul>\n</li>\n</ul>\n<p>롤링 배포와 카나리 배포의 경우 서버의 자원을 많이 필요로 한다는 점이 적용하기 어려운 부분으로 다가왔다.</p>\n<p>따라서 현재 사용할 수 있는 자원을 고려해봤을 때 합당하다고 생각되는 <strong>블루/그린 배포</strong> 방식을 채택한다.</p>\n<h3>서버 사양 확인</h3>\n<p>무중단 배포 환경을 구성하기 이전에 서버 사용중인 리소스를 먼저 확인해보자.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/fd7bede15dde249e0501a31735b84df6/e584c/2aa53eb9.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 14.117647058823529%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAsUlEQVR42j3O3W6DMAyGYSdAFEJAFYyqVXs80qvairp1Y6hI/Tnqxb+LYNrBI1vWZ8uSZhmiFErrf6I0iVaR/NWFjrnKV5hVg1nv8S8t5WaHabeIqIX1hsTGBRuP5AttMlyuKIqUwmmcFbwT6sbQtBVZmWNqj20q8vWKtLTxEUElgoThSDedOEwfhLGnG4+E4X3uD7cnYRrphjdef3rCJc6uMXf/orueo89ZuJ0Jj+/ZLxgWUt5OPvgsAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='2aa53eb9' title='' src='/static/fd7bede15dde249e0501a31735b84df6/ca1dc/2aa53eb9.png' srcset='/static/fd7bede15dde249e0501a31735b84df6/e7570/2aa53eb9.png 170w,\n/static/fd7bede15dde249e0501a31735b84df6/f46e7/2aa53eb9.png 340w,\n/static/fd7bede15dde249e0501a31735b84df6/ca1dc/2aa53eb9.png 680w,\n/static/fd7bede15dde249e0501a31735b84df6/02d09/2aa53eb9.png 1020w,\n/static/fd7bede15dde249e0501a31735b84df6/9d567/2aa53eb9.png 1360w,\n/static/fd7bede15dde249e0501a31735b84df6/e584c/2aa53eb9.png 2070w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>메모리는 (스왑메모리 제외) 총 1.8 GB 중 742MB를 상시 사용중이고 이 중 애플리케이션은 534MB만큼의 메모리를 사용중이다.</p>\n<p>여유있게 애플리케이션은 상시 약 600MB 정도의 메모리를 사용한다고 생각해볼 수 있다.</p>\n<p>이에 새로운 애플리케이션을 서버에 한 대 더 띄울경우 약 600MB를 더 사용하게되어 1.4GB 메모리를 상시 사용할 것으로 예상된다.</p>\n<h3>무중단 배포 시나리오 구성</h3>\n<blockquote>\n<p><code class=\"language-text\">[블루, 그린 배포방식으로 진행한다]</code></p>\n</blockquote>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/88177c9517381a6512b67d0e1e06d486/f97d7/4cfcbb80.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 43.529411764705884%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABdklEQVR42n2S3W6CQBCFff9Hab0xvTBRbNI0Jm1SbFKjVSz+gRSkyrIgVdjldFaoSmo6yYRdMvnmnJmtRVEExhjCMPybnCP0fbDlEpHjwBoM0O92YQ2H4CsbzLIQ2jaCxQJZEOC+00ENFHme42pkGYisCgAhiu9lrTpKCaHqKJ41jYD7PbI8RbL/xi5Lq8DDASAHedlUljDde8AweIGbWPRfElMWwFYLNfvtFj0IvDZv0OvUC2Gi6DhhFozNHL8uchRAk/fRHWmwt7PjXUhxBvodDfWeCbbZQCScYAKpUko12kzH3fQJSCV4xLFarSgdxDwmq9RE5iWwVNhuo7ZzXIwWNkGyiltV5BFgTUPfk/U0TcFChjjaYejpmEfv8BPnqFpeAiUpCrab60tRM4yjcgH5aRE9mqFuPcLly6K5EGfgv1s+AuMqsAylNMtE1bLask/vzHVdeJ53PU0TnmHAm0xO6U4MfE2nWH98HO+f4zE4vclmo4EfAA+sxbvOUIYAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='4cfcbb80' title='' src='/static/88177c9517381a6512b67d0e1e06d486/ca1dc/4cfcbb80.png' srcset='/static/88177c9517381a6512b67d0e1e06d486/e7570/4cfcbb80.png 170w,\n/static/88177c9517381a6512b67d0e1e06d486/f46e7/4cfcbb80.png 340w,\n/static/88177c9517381a6512b67d0e1e06d486/ca1dc/4cfcbb80.png 680w,\n/static/88177c9517381a6512b67d0e1e06d486/02d09/4cfcbb80.png 1020w,\n/static/88177c9517381a6512b67d0e1e06d486/9d567/4cfcbb80.png 1360w,\n/static/88177c9517381a6512b67d0e1e06d486/f97d7/4cfcbb80.png 2000w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<blockquote>\n<p><a href=\"https://github.com/jojoldu/springboot-webservice/blob/master/tutorial/7_NGINX_SSL_%EB%AC%B4%EC%A4%91%EB%8B%A8%EB%B0%B0%ED%8F%AC.md\">이미지 출처</a></p>\n</blockquote>\n<ul>\n<li>8080, 8081 포트에 WAS를 구성한다.</li>\n<li>새롭게 배포될 때 nginx가 가리키는 포트를 정해준다.</li>\n</ul>\n<h3>무중단 배포 스크립트 작성</h3>\n<p>무중단 배포환경을 구성하기 위해 쉘 스크립트를 작성해보자. 보통 새롭게 배포할 PORT를 GREEN, 구버전 포트를 BLUE로 지칭하는데, 조금 더 이해하기 쉽게 GREEN을 NEW PORT, BLUE를\nCURRENT PORT로 지칭하도록 하겠다.</p>\n<h4>1. CURRENT PORT, NEW PORT 설정</h4>\n<p>8080, 8081 포트가 살아있는지 확인한다.</p>\n<p>살아있는 포트를 <code class=\"language-text\">CURRENT_PORT</code>, 그렇지 않은 포트를 <code class=\"language-text\">NEW_PORT</code>로 판별한다.</p>\n<p>이 때 <code class=\"language-text\">NEW_PORT</code>로 지정하려는 포트에 이미 애플리케이션이 있으면 프로세스를 종료시켜 자리를 비워준다</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"> 현재 구동중인 Port 확인\"</span>\n\n<span class=\"token comment\"># CURRENT &amp; NEW 포트 확인</span>\n<span class=\"token keyword\">if</span> <span class=\"token function\">lsof</span> <span class=\"token parameter variable\">-Pi</span> :8080 <span class=\"token parameter variable\">-sTCP:LISTEN</span> <span class=\"token parameter variable\">-t</span> <span class=\"token operator\">></span>/dev/null<span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"현재 8080 포트가 사용 중입니다.\"</span>\n    <span class=\"token assign-left variable\">CURRENT_PORT</span><span class=\"token operator\">=</span><span class=\"token number\">8080</span>\n    <span class=\"token assign-left variable\">NEW_PORT</span><span class=\"token operator\">=</span><span class=\"token number\">8081</span>\n<span class=\"token keyword\">elif</span> <span class=\"token function\">lsof</span> <span class=\"token parameter variable\">-Pi</span> :8081 <span class=\"token parameter variable\">-sTCP:LISTEN</span> <span class=\"token parameter variable\">-t</span> <span class=\"token operator\">></span>/dev/null<span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"현재 8081 포트가 사용 중입니다.\"</span>\n    <span class=\"token assign-left variable\">CURRENT_PORT</span><span class=\"token operator\">=</span><span class=\"token number\">8081</span>\n    <span class=\"token assign-left variable\">NEW_PORT</span><span class=\"token operator\">=</span><span class=\"token number\">8080</span>\n<span class=\"token keyword\">else</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"8080과 8081 포트 모두 사용 중이지 않습니다.\"</span>\n    <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span>\n<span class=\"token keyword\">fi</span>\n<span class=\"token comment\"># NEW 포트 사용중일 경우 종료</span>\n<span class=\"token keyword\">if</span> <span class=\"token function\">lsof</span> <span class=\"token parameter variable\">-Pi</span> <span class=\"token builtin class-name\">:</span><span class=\"token variable\">$NEW_PORT</span> <span class=\"token parameter variable\">-sTCP:LISTEN</span> <span class=\"token parameter variable\">-t</span> <span class=\"token operator\">></span>/dev/null<span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"NEW_PORT가 사용중입니다.\"</span>\n  <span class=\"token assign-left variable\">PID</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">lsof</span> <span class=\"token parameter variable\">-Pi</span> :$NEW_PORT <span class=\"token parameter variable\">-sTCP:LISTEN</span> <span class=\"token parameter variable\">-t</span><span class=\"token variable\">)</span></span>\n  <span class=\"token function\">kill</span> <span class=\"token parameter variable\">-9</span> <span class=\"token variable\">$PID</span>\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"사용 중인 NEW_PORT 종료했습니다..\"</span>\n  <span class=\"token function\">sleep</span> <span class=\"token number\">3</span>\n<span class=\"token keyword\">else</span>\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"NEW_PORT가 사용 중이지 않습니다.\"</span>\n<span class=\"token keyword\">fi</span></code></pre></div>\n<h4>2. NEW PORT에 프로젝트 구동</h4>\n<p>NEW PORT에 새로운 프로젝트를 구동한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash</span>\n<span class=\"token comment\">#Spring ON</span>\n<span class=\"token function\">nohup</span> <span class=\"token function\">java</span> <span class=\"token parameter variable\">-jar</span> <span class=\"token string\">\"pium.jar\"</span> <span class=\"token parameter variable\">--spring.profiles.active</span><span class=\"token operator\">=</span>dev <span class=\"token parameter variable\">--server.port</span><span class=\"token operator\">=</span><span class=\"token variable\">$NEW_PORT</span> <span class=\"token operator\">></span> log.txt <span class=\"token operator\"><span class=\"token file-descriptor important\">2</span>></span><span class=\"token file-descriptor important\">&amp;1</span> <span class=\"token operator\">&amp;</span>\n\n<span class=\"token builtin class-name\">echo</span> 백그라운드 모드로 애플리케이션 실행 성공 <span class=\"token operator\">!</span><span class=\"token operator\">!</span></code></pre></div>\n<h3>3. Health Check 수행</h3>\n<p>애플리케이션이 구동 완료되기까지의 시간을 고려하여 15초간 sleep을 실행한다.</p>\n<p>sleep 이후, NEW PORT 애플리케이션의 정상 실행을 확인하기 위해 열 번의 health check를 수행하도록 한다.(UP 문자열이 응답되지 않으면 배포 종료)</p>\n<blockquote>\n<p><strong>health check</strong>\n프로젝트 의존성에 스프링부트 actuator를 추가하여 health check를 수행할 수 있다.\n<code class=\"language-text\">implementation('org.springframework.boot:spring-boot-starter-actuator')</code>\n<span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/779e418a2bbb5e9d03fa3bf91c24b538/f97d7/f3b48297.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 42.94117647058824%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAABLUlEQVR42qVQ20rDQBDNf+iLIlittSD1RjQPvuhHCIqtWmurtaK/auLlQUmby+ZWKzaYZI+zi4W2Cko9cJhzdmdmZ1ZRVQ2F1R3MF1XkljdQKGlY297FurYndX5lCwvFTeSIIgo/t1jC1Ewe07NL36jU65con7VwcNIkNlAhfdq4QfXiFsfn16jUWsQrlKuCTakPKW//qPYjFS/owrRcmE6AhxcbbTfEk+ki6r1DIOMAxyjG/TCU6PUNluvDCyP4YRc26bbNYDM6CyLcPT5L7/ohLMeT0WEBOqQdL0CSJEPPcCicczpMkaQpTcORphnxy2eZvBv4AUWOjHQv6kcmFEV/X+h3KIwxGIYBXdfRo/V7MYMV3U/eUPxBHMfo9/tyxYzTWtnH5A3H/+C/+AQGHHDj4MgUYwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='f3b48297' title='' src='/static/779e418a2bbb5e9d03fa3bf91c24b538/ca1dc/f3b48297.png' srcset='/static/779e418a2bbb5e9d03fa3bf91c24b538/e7570/f3b48297.png 170w,\n/static/779e418a2bbb5e9d03fa3bf91c24b538/f46e7/f3b48297.png 340w,\n/static/779e418a2bbb5e9d03fa3bf91c24b538/ca1dc/f3b48297.png 680w,\n/static/779e418a2bbb5e9d03fa3bf91c24b538/02d09/f3b48297.png 1020w,\n/static/779e418a2bbb5e9d03fa3bf91c24b538/9d567/f3b48297.png 1360w,\n/static/779e418a2bbb5e9d03fa3bf91c24b538/f97d7/f3b48297.png 2000w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n의존성만 추가하면 위와 같은 응답을 받을 수 있다.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash</span>\n\n<span class=\"token comment\"># 새로 가동하는 서버 상태 확인</span>\n<span class=\"token function\">sleep</span> <span class=\"token number\">15</span>\n\n<span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">retry_count</span> <span class=\"token keyword\">in</span> <span class=\"token punctuation\">{</span><span class=\"token number\">1</span><span class=\"token punctuation\">..</span><span class=\"token number\">10</span><span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">do</span>\n  <span class=\"token assign-left variable\">response</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> http://localhost:$NEW_PORT/actuator/health<span class=\"token variable\">)</span></span>\n  <span class=\"token assign-left variable\">up_count</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token builtin class-name\">echo</span> $response <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token string\">'UP'</span> <span class=\"token operator\">|</span> <span class=\"token function\">wc</span> <span class=\"token parameter variable\">-l</span><span class=\"token variable\">)</span></span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token variable\">$up_count</span> <span class=\"token parameter variable\">-ge</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">]</span>\n <span class=\"token keyword\">then</span> <span class=\"token comment\"># $up_count >= 1 (\"UP\" 문자열이 있는지 검증)</span>\n      <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"> Health check 성공\"</span>\n      <span class=\"token builtin class-name\">break</span>\n  <span class=\"token keyword\">else</span>\n      <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"> 새롭게 가동하는 서버의 상태가 UP이 아닙니다.\"</span>\n      <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"> Health check: <span class=\"token variable\">${response}</span>\"</span>\n  <span class=\"token keyword\">fi</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token variable\">$retry_count</span> <span class=\"token parameter variable\">-eq</span> <span class=\"token number\">10</span> <span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">then</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"> Health check 실패. \"</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"> Nginx에 연결하지 않고 배포를 종료합니다.\"</span>\n    <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span>\n  <span class=\"token keyword\">fi</span>\n\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"> Health check 연결 실패. 재시도...\"</span>\n  <span class=\"token function\">sleep</span> <span class=\"token number\">10</span>\n<span class=\"token keyword\">done</span></code></pre></div>\n<h4>3. nginx 포트 변경</h4>\n<p>nginx 포트를 변수로 변경해준다.</p>\n<p><strong>nginx 포트를 동적으로 구성하기</strong></p>\n<p>nginx 설정은 현재 8080 포트에 대해서만 프록시를 구성하고있다.</p>\n<p>8080, 8081 포트를 동적으로 변경할 수 있도록 개선해보자.</p>\n<p>쉘 스크립트로 <code class=\"language-text\">/etc/nginx/conf.d/service-url.inc;</code> 파일을 생성한다.</p>\n<p><code class=\"language-text\">sudo vim /etc/nginx/nginx.conf</code></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># service-url.inc 파일 내용</span>\n<span class=\"token builtin class-name\">set</span> <span class=\"token variable\">$service_url</span> http://127.0.0.1:8080<span class=\"token punctuation\">;</span></code></pre></div>\n<p>기존 nginx 설정에는 proxy pass 설정을 <code class=\"language-text\">http://127.0.0.1:8080</code> 로 구성했다면, 이제는 <code class=\"language-text\">$service_url</code> 환경변수가 proxy pass가 될 수 있도록 변경, 배포 시마다 이\n값이 동적으로 8080, 혹은 8081로 변경되도록 한다.</p>\n<ul>\n<li>기존 설정</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># /etc/nginx/sites-available/backend</span>\nserver <span class=\"token punctuation\">{</span>\n\n        server_name dev.api.pium.life<span class=\"token punctuation\">;</span>\n\n        location / <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$request_method</span> <span class=\"token operator\">=</span> <span class=\"token string\">'OPTIONS'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        add_header <span class=\"token string\">'Access-Control-Allow-Origin'</span> <span class=\"token string\">'https://dev.pium.life'</span><span class=\"token punctuation\">;</span>\n                        add_header <span class=\"token string\">'Access-Control-Allow-Methods'</span> <span class=\"token string\">'GET, POST, DELETE, PATCH, OPTIONS'</span><span class=\"token punctuation\">;</span>\n                        add_header <span class=\"token string\">'Access-Control-Allow-Headers'</span> <span class=\"token string\">'Content-Type, Authorization'</span><span class=\"token punctuation\">;</span>\n                        add_header <span class=\"token string\">'Access-Control-Max-Age'</span> <span class=\"token number\">86400</span><span class=\"token punctuation\">;</span>\n                        add_header <span class=\"token string\">'Access-Control-Allow-Credentials'</span> <span class=\"token string\">'true'</span><span class=\"token punctuation\">;</span>\n                        add_header <span class=\"token string\">'Access-Control-Expose-Headers'</span> <span class=\"token string\">'Set-Cookie'</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token builtin class-name\">return</span> <span class=\"token number\">204</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n                add_header <span class=\"token string\">'Access-Control-Allow-Credentials'</span> <span class=\"token string\">'true'</span> always<span class=\"token punctuation\">;</span>\n                add_header <span class=\"token string\">'Access-Control-Allow-Origin'</span> <span class=\"token string\">'https://dev.pium.life'</span> always<span class=\"token punctuation\">;</span>\n                add_header <span class=\"token string\">'Access-Control-Expose-Headers'</span> <span class=\"token string\">'Set-Cookie'</span> always<span class=\"token punctuation\">;</span>\n\n                proxy_set_header Host <span class=\"token variable\">$host</span><span class=\"token builtin class-name\">:</span><span class=\"token variable\">$server_port</span><span class=\"token punctuation\">;</span>\n                proxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span>\n                proxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span>\n\n                proxy_pass http://127.0.0.1:8080<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        location /docs <span class=\"token punctuation\">{</span>\n                proxy_pass http://127.0.0.1:8080<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        location /admin <span class=\"token punctuation\">{</span>\n                proxy_pass http://127.0.0.1:8080<span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n    listen <span class=\"token number\">443</span> ssl<span class=\"token punctuation\">;</span> <span class=\"token comment\"># managed by Certbot</span>\n    ssl_certificate /etc/letsencrypt/live/dev.pium.life/fullchain.pem<span class=\"token punctuation\">;</span> <span class=\"token comment\"># managed by Certbot</span>\n    ssl_certificate_key /etc/letsencrypt/live/dev.pium.life/privkey.pem<span class=\"token punctuation\">;</span> <span class=\"token comment\"># managed by Certbot</span>\n    include /etc/letsencrypt/options-ssl-nginx.conf<span class=\"token punctuation\">;</span> <span class=\"token comment\"># managed by Certbot</span>\n    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem<span class=\"token punctuation\">;</span> <span class=\"token comment\"># managed by Certbot</span>\n\n<span class=\"token punctuation\">}</span>\n\nserver <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$host</span> <span class=\"token operator\">=</span> dev.api.pium.life<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin class-name\">return</span> <span class=\"token number\">301</span> https://<span class=\"token variable\">$host</span><span class=\"token variable\">$request_uri</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token comment\"># managed by Certbot</span>\n\n    server_name dev.api.pium.life<span class=\"token punctuation\">;</span>\n    listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span>\n    <span class=\"token builtin class-name\">return</span> <span class=\"token number\">404</span><span class=\"token punctuation\">;</span> <span class=\"token comment\"># managed by Certbot</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>개선 설정</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># /etc/nginx/sites-available/backend</span>\nserver <span class=\"token punctuation\">{</span>\n\n        server_name dev.api.pium.life<span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\"># include 파일 추가하기</span>\n        include /etc/nginx/conf.d/service-url.inc<span class=\"token punctuation\">;</span>\n\n        location / <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$request_method</span> <span class=\"token operator\">=</span> <span class=\"token string\">'OPTIONS'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                        add_header <span class=\"token string\">'Access-Control-Allow-Origin'</span> <span class=\"token string\">'https://dev.pium.life'</span><span class=\"token punctuation\">;</span>\n                        add_header <span class=\"token string\">'Access-Control-Allow-Methods'</span> <span class=\"token string\">'GET, POST, DELETE, PATCH, OPTIONS'</span><span class=\"token punctuation\">;</span>\n                        add_header <span class=\"token string\">'Access-Control-Allow-Headers'</span> <span class=\"token string\">'Content-Type, Authorization'</span><span class=\"token punctuation\">;</span>\n                        add_header <span class=\"token string\">'Access-Control-Max-Age'</span> <span class=\"token number\">86400</span><span class=\"token punctuation\">;</span>\n                        add_header <span class=\"token string\">'Access-Control-Allow-Credentials'</span> <span class=\"token string\">'true'</span><span class=\"token punctuation\">;</span>\n                        add_header <span class=\"token string\">'Access-Control-Expose-Headers'</span> <span class=\"token string\">'Set-Cookie'</span><span class=\"token punctuation\">;</span>\n                        <span class=\"token builtin class-name\">return</span> <span class=\"token number\">204</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span>\n                add_header <span class=\"token string\">'Access-Control-Allow-Credentials'</span> <span class=\"token string\">'true'</span> always<span class=\"token punctuation\">;</span>\n                add_header <span class=\"token string\">'Access-Control-Allow-Origin'</span> <span class=\"token string\">'https://dev.pium.life'</span> always<span class=\"token punctuation\">;</span>\n                add_header <span class=\"token string\">'Access-Control-Expose-Headers'</span> <span class=\"token string\">'Set-Cookie'</span> always<span class=\"token punctuation\">;</span>\n                <span class=\"token comment\"># add_header 'Content-Type' 'application/json' always;</span>\n\n                proxy_set_header Host <span class=\"token variable\">$host</span><span class=\"token builtin class-name\">:</span><span class=\"token variable\">$server_port</span><span class=\"token punctuation\">;</span>\n                proxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span>\n                proxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span>\n\n                <span class=\"token comment\"># 이걸 변수로 지정</span>\n                <span class=\"token comment\"># proxy_pass http://127.0.0.1:8080;</span>\n                proxy_pass <span class=\"token variable\">$service_url</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        location /docs <span class=\"token punctuation\">{</span>\n                <span class=\"token comment\"># proxy_pass http://127.0.0.1:8080;</span>\n                proxy_pass <span class=\"token variable\">$service_url</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        location /admin <span class=\"token punctuation\">{</span>\n                <span class=\"token comment\"># proxy_pass http://127.0.0.1:8080;</span>\n                proxy_pass <span class=\"token variable\">$service_url</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n    listen <span class=\"token number\">443</span> ssl<span class=\"token punctuation\">;</span> <span class=\"token comment\"># managed by Certbot</span>\n    ssl_certificate /etc/letsencrypt/live/dev.pium.life/fullchain.pem<span class=\"token punctuation\">;</span> <span class=\"token comment\"># managed by Certbot</span>\n    ssl_certificate_key /etc/letsencrypt/live/dev.pium.life/privkey.pem<span class=\"token punctuation\">;</span> <span class=\"token comment\"># managed by Certbot</span>\n    include /etc/letsencrypt/options-ssl-nginx.conf<span class=\"token punctuation\">;</span> <span class=\"token comment\"># managed by Certbot</span>\n    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem<span class=\"token punctuation\">;</span> <span class=\"token comment\"># managed by Certbot</span>\n\n<span class=\"token punctuation\">}</span>\n\nserver <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$host</span> <span class=\"token operator\">=</span> dev.api.pium.life<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token builtin class-name\">return</span> <span class=\"token number\">301</span> https://<span class=\"token variable\">$host</span><span class=\"token variable\">$request_uri</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token comment\"># managed by Certbot</span>\n\n    server_name dev.api.pium.life<span class=\"token punctuation\">;</span>\n    listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span>\n    <span class=\"token builtin class-name\">return</span> <span class=\"token number\">404</span><span class=\"token punctuation\">;</span> <span class=\"token comment\"># managed by Certbot</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이제 쉘 스크립트에서 배포 시마다 해당 <code class=\"language-text\">NEW_PORT</code>에 맞춰 <code class=\"language-text\">$service_url</code> 환경변수를 변경하고, nginx를 재시작한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"> 전환할 Port: <span class=\"token variable\">$NEW_PORT</span>\"</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"> Port 전환\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"set \\<span class=\"token variable\">$service_url</span> http://127.0.0.1:<span class=\"token variable\">${NEW_PORT}</span>;\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">sudo</span> <span class=\"token function\">tee</span> /etc/nginx/conf.d/service-url.inc\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"> NGINX Reload\"</span>\n<span class=\"token function\">sudo</span> <span class=\"token function\">service</span> nginx reload</code></pre></div>\n<h4>4. CURRENT PORT 내리기</h4>\n<p>nginx reload (포트포워딩 완료)가 완료되면 <code class=\"language-text\">CURRENT_PORT</code>를 내린다.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"> CURRENT_PORT를 종료합니다\"</span>\n<span class=\"token assign-left variable\">CURRENT_PID</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">lsof</span> <span class=\"token parameter variable\">-Pi</span> :$CURRENT_PORT <span class=\"token parameter variable\">-sTCP:LISTEN</span> <span class=\"token parameter variable\">-t</span><span class=\"token variable\">)</span></span>\n<span class=\"token function\">kill</span> <span class=\"token parameter variable\">-9</span> <span class=\"token variable\">$CURRENT_PID</span></code></pre></div>\n<h3>최종 배포 스크립트 형태</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"> 현재 구동중인 Port 확인\"</span>\n\n<span class=\"token comment\"># CURRENT &amp; NEW 포트 확인</span>\n<span class=\"token keyword\">if</span> <span class=\"token function\">lsof</span> <span class=\"token parameter variable\">-Pi</span> :8080 <span class=\"token parameter variable\">-sTCP:LISTEN</span> <span class=\"token parameter variable\">-t</span> <span class=\"token operator\">></span>/dev/null<span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"현재 8080 포트가 사용 중입니다.\"</span>\n    <span class=\"token assign-left variable\">CURRENT_PORT</span><span class=\"token operator\">=</span><span class=\"token number\">8080</span>\n    <span class=\"token assign-left variable\">NEW_PORT</span><span class=\"token operator\">=</span><span class=\"token number\">8081</span>\n<span class=\"token keyword\">elif</span> <span class=\"token function\">lsof</span> <span class=\"token parameter variable\">-Pi</span> :8081 <span class=\"token parameter variable\">-sTCP:LISTEN</span> <span class=\"token parameter variable\">-t</span> <span class=\"token operator\">></span>/dev/null<span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"현재 8081 포트가 사용 중입니다.\"</span>\n    <span class=\"token assign-left variable\">CURRENT_PORT</span><span class=\"token operator\">=</span><span class=\"token number\">8081</span>\n    <span class=\"token assign-left variable\">NEW_PORT</span><span class=\"token operator\">=</span><span class=\"token number\">8080</span>\n<span class=\"token keyword\">else</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"8080과 8081 포트 모두 사용 중이지 않습니다.\"</span>\n    <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span>\n<span class=\"token keyword\">fi</span>\n<span class=\"token comment\"># NEW 포트 사용중일 경우 종료</span>\n<span class=\"token keyword\">if</span> <span class=\"token function\">lsof</span> <span class=\"token parameter variable\">-Pi</span> <span class=\"token builtin class-name\">:</span><span class=\"token variable\">$NEW_PORT</span> <span class=\"token parameter variable\">-sTCP:LISTEN</span> <span class=\"token parameter variable\">-t</span> <span class=\"token operator\">></span>/dev/null<span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"NEW_PORT가 사용중입니다.\"</span>\n  <span class=\"token assign-left variable\">PID</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">lsof</span> <span class=\"token parameter variable\">-Pi</span> :$NEW_PORT <span class=\"token parameter variable\">-sTCP:LISTEN</span> <span class=\"token parameter variable\">-t</span><span class=\"token variable\">)</span></span>\n  <span class=\"token function\">kill</span> <span class=\"token parameter variable\">-9</span> <span class=\"token variable\">$PID</span>\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"사용 중인 NEW_PORT 종료했습니다..\"</span>\n  <span class=\"token function\">sleep</span> <span class=\"token number\">3</span>\n<span class=\"token keyword\">else</span>\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"NEW_PORT가 사용 중이지 않습니다.\"</span>\n<span class=\"token keyword\">fi</span>\n\n<span class=\"token comment\">#Spring ON</span>\n<span class=\"token function\">nohup</span> <span class=\"token function\">java</span> <span class=\"token parameter variable\">-jar</span> <span class=\"token string\">\"pium.jar\"</span> <span class=\"token parameter variable\">--spring.profiles.active</span><span class=\"token operator\">=</span>dev <span class=\"token parameter variable\">--server.port</span><span class=\"token operator\">=</span><span class=\"token variable\">$NEW_PORT</span> <span class=\"token operator\">></span> log.txt <span class=\"token operator\"><span class=\"token file-descriptor important\">2</span>></span><span class=\"token file-descriptor important\">&amp;1</span> <span class=\"token operator\">&amp;</span>\n\n<span class=\"token builtin class-name\">echo</span> 백그라운드 모드로 애플리케이션 실행 성공 <span class=\"token operator\">!</span><span class=\"token operator\">!</span>\n\n<span class=\"token comment\"># 새로 가동하는 서버 상태 확인</span>\n<span class=\"token function\">sleep</span> <span class=\"token number\">15</span>\n\n<span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">retry_count</span> <span class=\"token keyword\">in</span> <span class=\"token punctuation\">{</span><span class=\"token number\">1</span><span class=\"token punctuation\">..</span><span class=\"token number\">10</span><span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">do</span>\n  <span class=\"token assign-left variable\">response</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-s</span> http://localhost:$NEW_PORT/actuator/health<span class=\"token variable\">)</span></span>\n  <span class=\"token assign-left variable\">up_count</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token builtin class-name\">echo</span> $response <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token string\">'UP'</span> <span class=\"token operator\">|</span> <span class=\"token function\">wc</span> <span class=\"token parameter variable\">-l</span><span class=\"token variable\">)</span></span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token variable\">$up_count</span> <span class=\"token parameter variable\">-ge</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">]</span>\n <span class=\"token keyword\">then</span> <span class=\"token comment\"># $up_count >= 1 (\"UP\" 문자열이 있는지 검증)</span>\n      <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"> Health check 성공\"</span>\n      <span class=\"token builtin class-name\">break</span>\n  <span class=\"token keyword\">else</span>\n      <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"> 새롭게 가동하는 서버의 상태가 UP이 아닙니다.\"</span>\n      <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"> Health check: <span class=\"token variable\">${response}</span>\"</span>\n  <span class=\"token keyword\">fi</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token variable\">$retry_count</span> <span class=\"token parameter variable\">-eq</span> <span class=\"token number\">10</span> <span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">then</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"> Health check 실패. \"</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"> Nginx에 연결하지 않고 배포를 종료합니다.\"</span>\n    <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span>\n  <span class=\"token keyword\">fi</span>\n\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"> Health check 연결 실패. 재시도...\"</span>\n  <span class=\"token function\">sleep</span> <span class=\"token number\">10</span>\n<span class=\"token keyword\">done</span>\n\n<span class=\"token comment\"># 새로 가동하는 서버로 전환</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"> 전환할 Port: <span class=\"token variable\">$NEW_PORT</span>\"</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"> Port 전환\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"set \\<span class=\"token variable\">$service_url</span> http://127.0.0.1:<span class=\"token variable\">${NEW_PORT}</span>;\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">sudo</span> <span class=\"token function\">tee</span> /etc/nginx/conf.d/service-url.inc\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"> NGINX Reload\"</span>\n<span class=\"token function\">sudo</span> <span class=\"token function\">service</span> nginx reload\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"> CURRENT_PORT를 종료합니다\"</span>\n<span class=\"token assign-left variable\">CURRENT_PID</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">lsof</span> <span class=\"token parameter variable\">-Pi</span> :$CURRENT_PORT <span class=\"token parameter variable\">-sTCP:LISTEN</span> <span class=\"token parameter variable\">-t</span><span class=\"token variable\">)</span></span>\n<span class=\"token function\">kill</span> <span class=\"token parameter variable\">-9</span> <span class=\"token variable\">$CURRENT_PID</span></code></pre></div>\n<h3>시나리오 정리</h3>\n<ol>\n<li>현재 구동중인 포트(CURRENT)와 새롭게 배포할 포트(NEW)를 확인한다.</li>\n<li>NEW를 점유중인 프로세스가 있을 시 강제 종료한다.</li>\n<li>NEW에 애플리케이션을 구동한다</li>\n<li>애플리케이션의 정상 작동을 확인한다(health check)</li>\n<li>nginx의 포트 포워딩 설정을 NEW PORT로 변경 후, nginx를 재가동한다.</li>\n<li>기존 사용하전 구버전 포트(CURRENT)를 내린다.</li>\n</ol>","frontmatter":{"title":"무중단 배포 환경 구성하기","date":"October 19, 2023","update":"October 19, 2023","tags":["무중단배포"],"series":null},"fields":{"slug":"/dont-stop-deploy/","readingTime":{"minutes":16.68}}},"seriesList":{"edges":[{"node":{"id":"28f1d87e-d3fc-5567-8531-57649652864f","fields":{"slug":"/sprint-idea/"},"frontmatter":{"title":"구글 스프린트 기반 아이디어 도출"}}},{"node":{"id":"4a9246fb-171b-5973-88fc-864034e78afd","fields":{"slug":"/blog-starter/"},"frontmatter":{"title":"피움 블로그 생성과정"}}},{"node":{"id":"c826ce0e-1ea7-517c-8d19-84e90a59a798","fields":{"slug":"/jenkins-setting/"},"frontmatter":{"title":"젠킨스 설치하기"}}},{"node":{"id":"a387bf4f-567f-50e7-b6a7-99a1a1c8971b","fields":{"slug":"/jpa-notnull-nullable/"},"frontmatter":{"title":"@NotNull과 nullable = false는 어떤 차이가 있을까?"}}},{"node":{"id":"a78e224b-b711-5071-8e90-013d6f4bebc3","fields":{"slug":"/pium-deploy-step/"},"frontmatter":{"title":"피움의 배포과정"}}},{"node":{"id":"ce07fbab-1ed5-5f1e-8e2f-eb430879b56a","fields":{"slug":"/fe-tanstack-query/"},"frontmatter":{"title":"프론트엔드: Tanstack Query 사용에 대하여"}}},{"node":{"id":"159c943b-1a50-57dd-aa71-7557364752a5","fields":{"slug":"/ci-cd-setting/"},"frontmatter":{"title":"Jenkins와 Github Webhook을 이용해 CI/CD 구축하기"}}},{"node":{"id":"dea45a4a-bfde-5fbb-8a97-42d3a3e77a0b","fields":{"slug":"/jenkins-hook-by-label/"},"frontmatter":{"title":"PR 라벨로 젠킨스 빌드유발을 구분하기"}}},{"node":{"id":"1a03734e-d413-553f-9152-1dad2fc4acca","fields":{"slug":"/apply-https/"},"frontmatter":{"title":"내 서버에 HTTPS 설정하기"}}},{"node":{"id":"cecbc8b9-db00-562b-aa0b-06c406cfc44a","fields":{"slug":"/bundle-analyze/"},"frontmatter":{"title":"bundle-analyze를 통한 bundle 크기 분석"}}},{"node":{"id":"707f8ffb-1409-5c27-b15a-5661b235c226","fields":{"slug":"/db-drop-stop/"},"frontmatter":{"title":"Table Drop 못하게 막아버리기"}}},{"node":{"id":"fe4b591a-4dd5-5dd2-b18a-b318afd1e9e3","fields":{"slug":"/transactional-not-in-restassured/"},"frontmatter":{"title":"[트러블슈팅] @SpringbootTest의 RANDOM_PORT 환경에서 @Transactional 어노테이션을 사용했을 때, RestAssured GET 요청이 수행되지 않는 경우(트랜잭션 격리 이해하기)"}}},{"node":{"id":"80aa708e-ef8a-5c79-9644-cb8c04d55a63","fields":{"slug":"/acceptance-test-resolve/"},"frontmatter":{"title":"인수테스트 데이터 초기화하기"}}},{"node":{"id":"15def1d5-c20f-5d07-b46e-24a14661365f","fields":{"slug":"/react-setting-without-cra/"},"frontmatter":{"title":"webpack으로만 React 설정하기 (without CRA)"}}},{"node":{"id":"66383c86-e2c8-533a-90e0-2effae572742","fields":{"slug":"/stylelint-and-husky/"},"frontmatter":{"title":"stylelint와 husky를 통해 컨벤션 통일하기"}}},{"node":{"id":"ed5951d5-beda-5a8f-adb2-07c2fcb38d5e","fields":{"slug":"/OAuth2.0/"},"frontmatter":{"title":"내가 이해한 OAuth2.0"}}},{"node":{"id":"45eeb9a3-557d-5704-8fd9-925283e1e27b","fields":{"slug":"/restdocs-start/"},"frontmatter":{"title":"RestDocs로 API 문서화하기"}}},{"node":{"id":"663b560a-734d-51a9-a6dc-3c4f50716c74","fields":{"slug":"/spring-event-apply/"},"frontmatter":{"title":"Spring Event 적용하기"}}},{"node":{"id":"503e9e71-eda3-53d7-8142-7c309faf213e","fields":{"slug":"/why_we_applied_querydsl/"},"frontmatter":{"title":"피움 서비스의 Querydsl 도입 이유"}}},{"node":{"id":"55ae8038-3f65-5a59-8db3-c7405e7fc125","fields":{"slug":"/github-actions-cypress/"},"frontmatter":{"title":"피움 Cypress 자동화 구축기"}}},{"node":{"id":"5c865dcb-cefd-58be-8968-b5edf6c8080c","fields":{"slug":"/server-logging/"},"frontmatter":{"title":"Logback을 이용해 운영 환경 별 로그 남기기"}}},{"node":{"id":"709124d0-5b05-5530-804d-e90ec9856a13","fields":{"slug":"/querydsl_apply_procedure/"},"frontmatter":{"title":"피움 서비스의 Querydsl 적용 과정"}}},{"node":{"id":"8269f166-d041-533c-9d44-332d8d8c3dca","fields":{"slug":"/server-monitoring/"},"frontmatter":{"title":"CloudWatch를 이용한 모니터링 환경 구성"}}},{"node":{"id":"0faec7ad-3bd1-5f5e-9222-115f771df8ed","fields":{"slug":"/tanstack-query-cache-trouble-shooting/"},"frontmatter":{"title":"InfinityQuery에서 fetch가 제대로 이루어지지 않는다?!?!"}}},{"node":{"id":"c77f7199-7fc6-53a3-a1fb-0792e05655a7","fields":{"slug":"/OAuth2.0-backend/"},"frontmatter":{"title":"OAuth 2.0 로그인 구현하기 (카카오)"}}},{"node":{"id":"12e4480d-386b-5d0e-bd69-4209fed36066","fields":{"slug":"/OAuth-test-backend/"},"frontmatter":{"title":"외부 API 를 의존하는 OAuth 로그인 테스트하기"}}},{"node":{"id":"ff40e109-cc92-5d83-a213-ca9d07136d95","fields":{"slug":"/aws-s3-apply/"},"frontmatter":{"title":"AWS S3로 정적 이미지 배포하기"}}},{"node":{"id":"e343af80-72dd-5173-bbb5-5069a17d1200","fields":{"slug":"/search_in_spring_data_jpa/"},"frontmatter":{"title":"Spring Data Jpa를 활용한 검색 기능 개발하기"}}},{"node":{"id":"af344dd8-ea77-5fde-9452-a97952ce60be","fields":{"slug":"/submodule-apply/"},"frontmatter":{"title":"Git submodule을 이용한 민감정보 관리"}}},{"node":{"id":"08c9daf0-2344-52a9-8c68-31ac04c24ff0","fields":{"slug":"/tomcat-thread-config/"},"frontmatter":{"title":"톰캣 스레드 설정하기"}}},{"node":{"id":"eafed74f-ff11-5af1-a589-e9dd2ccb5c8e","fields":{"slug":"/http-cache/"},"frontmatter":{"title":"CloudFront와 HTTP 캐시"}}},{"node":{"id":"dbe47289-01f4-571d-9506-fbb92016f547","fields":{"slug":"/optimize-frontend/"},"frontmatter":{"title":"피움 최적화하기"}}},{"node":{"id":"7b830fe6-e2df-564a-926e-7f7800380336","fields":{"slug":"/query-analysis/"},"frontmatter":{"title":"서비스 내에서 발생하는 쿼리를 분석하고 개선하기"}}},{"node":{"id":"37437d15-a63e-52ef-b031-6ee1bc6fa8bc","fields":{"slug":"/image-resize/"},"frontmatter":{"title":"서버에서 이미지 리사이징하기"}}},{"node":{"id":"216f4636-4125-5765-83d8-a6a610692a41","fields":{"slug":"/dont-stop-deploy/"},"frontmatter":{"title":"무중단 배포 환경 구성하기"}}},{"node":{"id":"dd095976-5a96-51b5-9686-8956dc60cd24","fields":{"slug":"/hikaricp-connection-pool-setting/"},"frontmatter":{"title":"HikariCp Connection Pool 값 설정"}}}]},"previous":{"fields":{"slug":"/image-resize/"},"frontmatter":{"title":"서버에서 이미지 리사이징하기"}},"next":{"fields":{"slug":"/hikaricp-connection-pool-setting/"},"frontmatter":{"title":"HikariCp Connection Pool 값 설정"}}},"pageContext":{"id":"216f4636-4125-5765-83d8-a6a610692a41","series":null,"previousPostId":"37437d15-a63e-52ef-b031-6ee1bc6fa8bc","nextPostId":"dd095976-5a96-51b5-9686-8956dc60cd24"}},"staticQueryHashes":[],"slicesMap":{}}