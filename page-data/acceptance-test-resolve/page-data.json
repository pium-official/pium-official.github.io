{"componentChunkName":"component---src-templates-post-jsx","path":"/acceptance-test-resolve/","result":{"data":{"site":{"siteMetadata":{"title":"pium.log"}},"markdownRemark":{"id":"80aa708e-ef8a-5c79-9644-cb8c04d55a63","excerpt":"이 글은 우테코 피움팀 크루 '주노'가 작성했습니다. 서론 인수테스트를 작성하면서 다음과 같은 문제가 발생했다. RestAssured를 사용하고 있다. 각 테스트별로 (DB)데이터가 격리된 테스트를 수행하고 싶다. 이에 다음과 같은 시행착오를 거쳤다. 최종적으로 작성된 코드를 보고싶다면 최종코드를 확인해주세요. 시행착오 JPA를 사용하고 있는 현 시점에서…","html":"<blockquote>\n<p>이 글은 우테코 피움팀 크루 '<a href=\"https://github.com/Choi-JJunho\">주노</a>'가 작성했습니다.</p>\n</blockquote>\n<h2>서론</h2>\n<p>인수테스트를 작성하면서 다음과 같은 문제가 발생했다.</p>\n<ul>\n<li>RestAssured를 사용하고 있다.</li>\n<li>각 테스트별로 (DB)데이터가 격리된 테스트를 수행하고 싶다.</li>\n</ul>\n<p>이에 다음과 같은 시행착오를 거쳤다.</p>\n<blockquote>\n<p>최종적으로 작성된 코드를 보고싶다면 최종코드를 확인해주세요.</p>\n</blockquote>\n<h2>시행착오</h2>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Transactional</span>\n<span class=\"token annotation punctuation\">@SpringBootTest</span><span class=\"token punctuation\">(</span>webEnvironment <span class=\"token operator\">=</span> <span class=\"token class-name\">SpringBootTest<span class=\"token punctuation\">.</span>WebEnvironment</span><span class=\"token punctuation\">.</span><span class=\"token constant\">RANDOM_PORT</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">DictionaryPlantApiTest</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>JPA를 사용하고 있는 현 시점에서<code class=\"language-text\">@Transactional</code>을 이용해서 하나의 테스트(트랜잭션)이 끝날 때 데이터가 롤백되는 현상을 기대했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Test</span>\n<span class=\"token keyword\">void</span> 사전_식물_상세정보_조회_시_사전_식물_정보_반환<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token comment\">// dictionaryPlantRepository.save() 에 대한 Fixture</span>\n    <span class=\"token class-name\">DictionaryPlant</span> <span class=\"token constant\">REQUEST</span> <span class=\"token operator\">=</span> dictionaryPlantSupport<span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token class-name\">DictionaryPlantResponse</span> <span class=\"token constant\">RESPONSE</span> <span class=\"token operator\">=</span> <span class=\"token class-name\">RestAssured</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">given</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">when</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/dictionary-plants/{id}\"</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">REQUEST</span><span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">statusCode</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpStatus</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OK</span><span class=\"token punctuation\">.</span><span class=\"token function\">value</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">extract</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">as</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DictionaryPlantResponse</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    \n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/6a7264de6762b8d1cca647aaf3a1fff8/06e4e/807f392f.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 33.529411764705884%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAz0lEQVR42o2QS4LEIAhEc5L4AY3amdhq7n+1moo9vZ1k8UQQCnDZi+JsBeP9Qqu0bUd/F7QjY9BP0cG55yxtT0jlQAwOSQ1q8Mgq9D+IZ6L3zwVLjnASoaoIRKyDMRaWj9ZarMZgXVfGzPTvJ6wJrbXJljhtzujjRC5lxvoY6OeJo9YZEzZ1/wgvOSl6/xPcNliuKIFF4mfxNbmGMO8iAn+z/mK54rXSRXAeI2zo+mEXijDpi3/yh9cxu5KNAo1CVePkID/kpYE2QJljbwR/AcR4xxodFiVIAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='807f392f' title='' src='/static/6a7264de6762b8d1cca647aaf3a1fff8/ca1dc/807f392f.png' srcset='/static/6a7264de6762b8d1cca647aaf3a1fff8/e7570/807f392f.png 170w,\n/static/6a7264de6762b8d1cca647aaf3a1fff8/f46e7/807f392f.png 340w,\n/static/6a7264de6762b8d1cca647aaf3a1fff8/ca1dc/807f392f.png 680w,\n/static/6a7264de6762b8d1cca647aaf3a1fff8/02d09/807f392f.png 1020w,\n/static/6a7264de6762b8d1cca647aaf3a1fff8/9d567/807f392f.png 1360w,\n/static/6a7264de6762b8d1cca647aaf3a1fff8/06e4e/807f392f.png 2054w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>하지만 테스트를 수행할 때 JPARepository로 save한 값을 RestAssured를 이용해 조회하면 데이터가 반영되지 않는 문제가 발생했다.</p>\n<h3>문제 인식</h3>\n<p><a href=\"https://stackoverflow.com/questions/41763417/api-test-transactional-rollback\">Stack Overflow</a>의 다음 글을 읽어본 뒤 다음과 같은 지식을 얻었다.</p>\n<blockquote>\n<p>@Transactional only works within the same thread, and as such the rollback provided by Spring will only work on the objects that were persisted on the thread where the transaction was started.\nYour rest-assured test will perform an integration test and will hit your Spring context on another thread. So although your rest-assured test would be able to see the objects persisted in your test setup, Spring will never be able to cleanup resources persisted in your rest-assured test automatically.\nThe only way to tackle this is to delete the entities yourself in your test (Using an Junit Rule, or cleaning up any state in your test setup).</p>\n</blockquote>\n<p>요약하면 다음과 같다.</p>\n<blockquote>\n<p>트랜잭션은 동일한 스레드 내에서 동작한다.\nSpring에서 제공하는 롤백은 트랜잭션이 시작된 스레드 내에서 생긴 객체에 대해서만 동작한다.\nRestAssured는 별도의 스레드를 통해 Spring 컨텍스트를 이용한다.\n이 때문에 RestAssured는 전역적으로 설정된 데이터 (Data.sql과 같은 설정으로 생긴 데이터)에는 접근할 수 있으나 Transaction과 같이 별도의 스레드에서만 제공되는 값에 대해서는 접근할 수 없다.\n... (해결방법 후략)</p>\n</blockquote>\n<p>위와 같이 별도의 RestAssured의 요청이 스레드로 동작하기 때문에 하나의 트랜잭션에서 별개로 저장한 값에 접근할 수 없다는 결론이 나왔다.</p>\n<blockquote>\n<p>자세한 내용은 <a href=\"https://pium-official.github.io/transactional-not-in-restassured/\">하마드의 트러블슈팅 글</a>을 참고해주세요~</p>\n</blockquote>\n<h2>해결방법</h2>\n<p>이 문제에 대해서 다양한 해결방법이 존재하고 각각의 장단점을 비교한 뒤 최종적으로 어떤 방식을 선택할지 고민해보자.</p>\n<h3>1️⃣ DirtiesContext 사용하기</h3>\n<p>매 테스트마다 Context를 새롭게 띄워서 데이터를 매번 초기화하는 방법을 생각해볼 수 있다.</p>\n<h4>장점</h4>\n<p>컨텍스트를 다시 로드하면서 테스트간 격리 환경을 명확하게 구분할 수 있다.</p>\n<h4>단점</h4>\n<ul>\n<li>매 테스트마다 컨텍스트를 다시 로드하기 때문에 속도가 상대적으로 느리다.</li>\n<li>@Nested 내부에 정의되어있는 테스트에 대해 DirtiesContext가 적용되지 않는 문제가 있다.\n<a href=\"https://docs.spring.io/spring-framework/reference/testing/testcontext-framework/support-classes.html#testcontext-junit-jupiter-nested-test-configuration\">Spring @Nested 관련 공식 문서</a>\n@Nested 내부에 정의된 테스트에 DirtiesContext를 전파하기 위해 아래 설정을 추가해줘야한다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// 클래스레벨에 다음 어노테이션을 추가해주거나</span>\n<span class=\"token annotation punctuation\">@NestedTestConfiguration</span><span class=\"token punctuation\">(</span>value <span class=\"token operator\">=</span> <span class=\"token class-name\">NestedTestConfiguration<span class=\"token punctuation\">.</span>EnclosingConfiguration</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OVERRIDE</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>혹은 properteis 설정을 변경해주는 방식도 존재한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"properties\"><pre class=\"language-properties\"><code class=\"language-properties\"><span class=\"token comment\"># properties 파일에 다음 설정을 추가해주어 전역적으로 @Nested 기본 전략을 설정할 수 있다.</span>\n<span class=\"token key attr-name\">spring.test.enclosing.configuration</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">OVERRIDE</span></code></pre></div>\n<blockquote>\n<p>참고 문서 : <a href=\"https://docs.spring.io/spring-framework/reference/testing/annotations/integration-junit-jupiter.html#integration-testing-annotations-nestedtestconfiguration\">Changing the default enclosing configuration inheritance mode</a></p>\n</blockquote>\n<h3>2️⃣ @SQL 사용하기</h3>\n<p>@SQL 어노테이션을 사용하여 매 테스트 실행 전 SQL 스크립트를 실행하여 테이블을 다시 만들 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Sql</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"classpath:init.sql\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@SpringBootTest</span><span class=\"token punctuation\">(</span>webEnvironment <span class=\"token operator\">=</span> <span class=\"token class-name\">SpringBootTest<span class=\"token punctuation\">.</span>WebEnvironment</span><span class=\"token punctuation\">.</span><span class=\"token constant\">RANDOM_PORT</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">DictionaryPlantApiTest</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>장점</h4>\n<ul>\n<li>여러 스크립트를 수행할 수 있다.</li>\n<li>스키마 초기화 후 테이터도 함께 넣을 수 있다.</li>\n</ul>\n<h4>단점</h4>\n<ul>\n<li>테스트에 사용하는 DB가 변경되었을 때 해당 벤더사의 Dialect에 맞게 SQL문을 고쳐줘야한다.</li>\n<li>쿼리를 텍스트로 관리하다보니 컴파일타임에 오류를 잡기 어렵다.</li>\n<li>테이블 연관관계가 존재하는 경우 쿼리문 작성 순서에 신경을 많이 써야한다.</li>\n</ul>\n<h3>3️⃣ InitializingBean 사용하기</h3>\n<p><code class=\"language-text\">InitializingBean</code>을 이용하여 스프링 Bean이 초기화, 소멸 될 때 행위를 추가할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// InitializingBean의 생김새</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">InitializingBean</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">void</span> <span class=\"token function\">afterPropertiesSet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이를 이용해 @Test 어노테이션으로 Bean이 등록될 때 마다 DB을 초기화하는 상황을 기대할 수 있다.</p>\n<p><strong>Entity Manager를 이용해 DB 초기화하기</strong></p>\n<p>JPA를 사용하는 입장으로 SQL문을 작성하기 보다는 EntityManager를 이용해보는것이 정적인 쿼리 관리에 들이는 소요가 적을 것이라고 생각된다.</p>\n<p>이에 EntityManager를 이용하여 DB를 초기화하는 방법을 알아보자.</p>\n<blockquote>\n<p>아래부터는 <a href=\"https://ttl-blog.tistory.com/1407\">https://ttl-blog.tistory.com/1407</a> 를 참고하여 진행된 글입니다.</p>\n</blockquote>\n<h4>table 이름 조회하기</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token annotation punctuation\">@Profile</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"test\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">DatabaseCleaner</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">InitializingBean</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token comment\">// 테이블 이름들을 저장할 List</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> tables <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token comment\">// 엔티티 매니저를 선언한다</span>\n    <span class=\"token annotation punctuation\">@PersistenceContext</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">EntityManager</span> entityManager<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@SuppressWarnings</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"unchecked\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@PostConstruct</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">findDatabaseTableNames</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">List</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span> tableInfos <span class=\"token operator\">=</span> entityManager<span class=\"token punctuation\">.</span><span class=\"token function\">createNativeQuery</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SHOW TABLES\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getResultList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> tableInfo <span class=\"token operator\">:</span> tableInfos<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">String</span> tableName <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span> tableInfo<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n            tableNames<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>tableName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>EntityManager를 이용하여 모든 테이블의 이름을 가져온다.</p>\n<h4>테이블 초기화하기 &#x26; 실행하기</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token annotation punctuation\">@Profile</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"test\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">DatabaseCleaner</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">InitializingBean</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token comment\">// 테이블 이름들을 저장할 List</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> tables <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t<span class=\"token comment\">// 엔티티 매니저를 선언한다</span>\n    <span class=\"token annotation punctuation\">@PersistenceContext</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">EntityManager</span> entityManager<span class=\"token punctuation\">;</span>\n\n\t<span class=\"token comment\">// 테이블 이름을 조회한다</span>\n    <span class=\"token annotation punctuation\">@SuppressWarnings</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"unchecked\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@PostConstruct</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">findDatabaseTableNames</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token comment\">// 테이블을 초기화한다</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">truncate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        entityManager<span class=\"token punctuation\">.</span><span class=\"token function\">createNativeQuery</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SET FOREIGN_KEY_CHECKS %d\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">executeUpdate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> tableName <span class=\"token operator\">:</span> tableNames<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            entityManager<span class=\"token punctuation\">.</span><span class=\"token function\">createNativeQuery</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"TRUNCATE TABLE %s\"</span><span class=\"token punctuation\">,</span> tableName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">executeUpdate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        entityManager<span class=\"token punctuation\">.</span><span class=\"token function\">createNativeQuery</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SET FOREIGN_KEY_CHECKS %d\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">executeUpdate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">afterPropertiesSet</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">findDatabaseTableNames</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Transactional</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        entityManager<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">truncate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>truncate를 수행하여 모든 테이블의 데이터를 초기화하고 실행한다.</p>\n<p>결과적으로 봤을 때 다음과 같은 흐름으로 데이터베이스 초기화가 수행된다.</p>\n<ul>\n<li>Bean이 생성된 이후 Table 이름을 찾는다.</li>\n<li>영속성 컨텍스트의 1차 캐시를 비우고 테이블을 초기화한다.</li>\n</ul>\n<h4>테스트코드에 적용하기</h4>\n<p>인수테스트를 <code class=\"language-text\">AcceptanceTest</code>로 분리하고 상속받는 구조로 변경했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@SpringBootTest</span><span class=\"token punctuation\">(</span>webEnvironment <span class=\"token operator\">=</span> <span class=\"token class-name\">SpringBootTest<span class=\"token punctuation\">.</span>WebEnvironment</span><span class=\"token punctuation\">.</span><span class=\"token constant\">RANDOM_PORT</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AcceptanceTest</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@LocalServerPort</span>\n    <span class=\"token keyword\">int</span> port<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">DatabaseCleaner</span> databaseCleaner<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@BeforeEach</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">setUp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">RestAssured</span><span class=\"token punctuation\">.</span>port <span class=\"token operator\">=</span> port<span class=\"token punctuation\">;</span>\n        databaseCleaner<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>작업한 내용을 적용하면 위와 같이 코드를 작성할 수 있다.</p>\n<h4>장점</h4>\n<ul>\n<li>테스트 코드가 쿼리에 의존적이지 않다.</li>\n<li>설정을 분리하여 관리할 수 있다.</li>\n</ul>\n<h4>단점</h4>\n<ul>\n<li>JPA에 종속적인 설정이기 때문에 JPA를 사용하지 않거나 ORM을 제외하는 상황을 고려한다면 해당 방식의 도입을 생각해볼 필요가 있다.</li>\n<li>AcceptenceTest 이외에 다른 통합테스트에서 사용하려면 중복된 코드를 작성해야한다.</li>\n<li>\n<p>Bean 생성 주기에 대한 설정이기 때문에 해당 클래스를 프로덕션에 남용할 수 있는 가능성이 존재한다.</p>\n<ul>\n<li>테스트 코드지만 프로덕션에도 적용될 수 있는 설정이 그닥 마음에 들진 않는다.</li>\n</ul>\n</li>\n</ul>\n<h3>4️⃣ JUnit5 Extension 사용하기</h3>\n<p>현재 코드는 AcceptenceTest를 사용하는 코드에 대해서만 DB 초기화를 진행하고있다.</p>\n<p>RestAssured가 별도의 스레드에서 동작하기 때문에 위와같이 구성했지만 별도의 통합 테스트에서도 DB 초기화 설정이 필요할 수 있다.</p>\n<p>@BeforeEach 내부에 clear를 선언하지 않고도 간단한 설정만으로 DB 초기화 로직을 적용하도록 개선해보자.</p>\n<p>이를 위해 JUnit5의 Extension을 사용하여 해당 설정을 리팩터링해볼 것이다.</p>\n<h4>JUnit5 Extension이란?</h4>\n<p>Junit5에서 제공하는 테스트의 생명주기에 대해 각각의 환경에 대해 확장할 수 있도록 제공하는 인터페이스다.</p>\n<p>다음과 같은 생성주기에 대한 확장을 제공한다.</p>\n<ul>\n<li>BeforeAllCallback - @BeforeAll 실행 전에 실행된다.</li>\n<li>BeforeEachCallback - @BeforeEach 실행 전에 실행된다.</li>\n<li>BeforeTestExecutionCallback - 각 테스트가 실행되기 직전에 실행된다.</li>\n<li>AfterTestExecutionCallback : 각 테스트가 종료된 후 실행된다.</li>\n<li>AfterEachCallback : @AfterEach 실행 이후에 실행된다.</li>\n<li>AfterAllCallback : @AfterAll 실행 이후에 실행된다.</li>\n</ul>\n<blockquote>\n<p>Referenced By <a href=\"https://ttl-blog.tistory.com/1407\">https://ttl-blog.tistory.com/1407</a></p>\n</blockquote>\n<h4>BeforeEachCallback 이용하기</h4>\n<p>현재 <code class=\"language-text\">@BeforeEach</code>에서 DatabaseCleaner가 수행되고 있으므로 <code class=\"language-text\">@BeforeEach</code> 이전에 실행될 수 있도록 <code class=\"language-text\">BeforeEachCallback</code>을 이용해보자.</p>\n<p>Extension을 이용하기 위해 기존에 DatabaseCleaner에 붙어있던 <code class=\"language-text\">implements InitializingBean</code>은 제거해줬다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">DatabaseCleaner</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> tableNames <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@PersistenceContext</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">EntityManager</span> entityManager<span class=\"token punctuation\">;</span>\n\n\t<span class=\"token comment\">// 바뀐부분 : 의존성 주입이후 초기화 수행 시 Table을 조회한다.</span>\n    <span class=\"token annotation punctuation\">@PostConstruct</span>\n    <span class=\"token annotation punctuation\">@SuppressWarnings</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"unchecked\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">findDatabaseTableNames</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">List</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span> tableInfos <span class=\"token operator\">=</span> entityManager<span class=\"token punctuation\">.</span><span class=\"token function\">createNativeQuery</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SHOW TABLES\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getResultList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> tableInfo <span class=\"token operator\">:</span> tableInfos<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">String</span> tableName <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span> tableInfo<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n            tableNames<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>tableName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">truncate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        entityManager<span class=\"token punctuation\">.</span><span class=\"token function\">createNativeQuery</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SET FOREIGN_KEY_CHECKS %d\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">executeUpdate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> tableName <span class=\"token operator\">:</span> tableNames<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            entityManager<span class=\"token punctuation\">.</span><span class=\"token function\">createNativeQuery</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"TRUNCATE TABLE %s\"</span><span class=\"token punctuation\">,</span> tableName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">executeUpdate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        entityManager<span class=\"token punctuation\">.</span><span class=\"token function\">createNativeQuery</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SET FOREIGN_KEY_CHECKS %d\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">executeUpdate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Transactional</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        entityManager<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">truncate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이후 <code class=\"language-text\">DatabaseClearExtension</code> 클래스를 다음과 같이 생성해준다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">DatabaseClearExtension</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">BeforeEachCallback</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">beforeEach</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ExtensionContext</span> context<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">DatabaseCleaner</span> databaseCleaner <span class=\"token operator\">=</span> <span class=\"token function\">getDataCleaner</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        databaseCleaner<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">DatabaseCleaner</span> <span class=\"token function\">getDataCleaner</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ExtensionContext</span> extensionContext<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">SpringExtension</span><span class=\"token punctuation\">.</span><span class=\"token function\">getApplicationContext</span><span class=\"token punctuation\">(</span>extensionContext<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">getBean</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DatabaseCleaner</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>간결해진 테스트코드</h4>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@ExtendWith</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DatabaseClearExtension</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@SpringBootTest</span><span class=\"token punctuation\">(</span>webEnvironment <span class=\"token operator\">=</span> <span class=\"token class-name\">SpringBootTest<span class=\"token punctuation\">.</span>WebEnvironment</span><span class=\"token punctuation\">.</span><span class=\"token constant\">RANDOM_PORT</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AcceptanceTest</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@LocalServerPort</span>\n    <span class=\"token keyword\">int</span> port<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@BeforeEach</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">setUp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">RestAssured</span><span class=\"token punctuation\">.</span>port <span class=\"token operator\">=</span> port<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이제 <code class=\"language-text\">@ExtendWith(DatabaseClearExtension.class)</code> 어노테이션만 붙여주면 테스트별로 DB를 초기화할 수 있다.</p>\n<p>각 테스트별로 truncate 문도 잘 수행되는 것을 확인할 수 있다.\n<span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/88196dd40428e63ada6cbdf9a9d9b518/0ea77/086045e1.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 130.58823529411765%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAaCAYAAAC3g3x9AAAACXBIWXMAAAsTAAALEwEAmpwYAAACfklEQVR42qWVx5LiYAyE/RhDMjmazJBzThOOe5j3fw6tPpXNQC0srpmDSr8NbkvdLdlZbjayP59ls9/L/nSSQrEoqVRK0un0j8IplUpSqVSk7Ec2m/0xmAHGYjFJxOOSTCbFdV1J/6I6AxyMx9JoNiUJ2C+ALoDdXk88z7MKuUEm4PEmwgJGIxEDOH9+yun9XQ5vb3JQkSazmZw+PuSo9+bLpZTL5VBiORWtzqtWpdVuS7PVMmGKqnShUJBiqXg5I1Ymk7GHgnwXcKZv3+x2MppMrCqqiKtQsWjUsp2DaxUP4RDRTSTuA7q+GLPFQpbrtUzmc2m/vtq5NxhIfziUqd5b60sX3Ov37b/8FvB+A0j5VAXIYDSyDA0AQQHR0XtDdQNg9UZDevob+R6nzny1ku3xKGNtl0qsZW0p8vJimZYRjmsXv9Kytus+sJmTy+WU/JK1MNQKTRhVtNXpiFerSU0DwQh7SDuiq8wjURI+0XBGpfD0qt5krsfTqQVnZj2UD0f6ACR3lZ+AaFqNqqq0FrTMdShAyIV0CEcIFkU+nzf/Bbnk3wu3HHy/rbZba22tGfCzTgkW2ikNf76+zAFQ8z9TGyDkYxWCtvM6FfyQ04qyKhgTkvPzMzADxF9Yh8y08ND1NHAmm1UeTMe/LevDCwVlBNngbCAWBDZCMF623m1tSTxbEA6kE51u11SuqUj4sqF+rKoHmRoy4nF+WiFv3RwO1jZehC+m4RL+fgzOTwHhLCD85ntyLUAIMb4nRYkO8+bQgIiAsdl5qaA9Qsm//hyEBmQRsJFr9fpFBDY4wnjBWUXLhGzbCdyPTeyDrwKxCPDkTidnq9fYh9ELU+lfMu735eWYN0YAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='086045e1' title='' src='/static/88196dd40428e63ada6cbdf9a9d9b518/ca1dc/086045e1.png' srcset='/static/88196dd40428e63ada6cbdf9a9d9b518/e7570/086045e1.png 170w,\n/static/88196dd40428e63ada6cbdf9a9d9b518/f46e7/086045e1.png 340w,\n/static/88196dd40428e63ada6cbdf9a9d9b518/ca1dc/086045e1.png 680w,\n/static/88196dd40428e63ada6cbdf9a9d9b518/0ea77/086045e1.png 682w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<h2>🚀 정리</h2>\n<p>다양한 방법을 시도해보면서 결론적으로 BeforeEachCallback을 사용하는 방식까지 적용해봤다.\n깔끔하게 정리된 테스트를 보니 기분이 좋다. 👍</p>\n<h3>최종 코드</h3>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 648px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/734e673304a268069acc4801e92b549c/244f0/21f5d279.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 129.99999999999997%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAaCAYAAAC3g3x9AAAACXBIWXMAAAsTAAALEwEAmpwYAAADXUlEQVR42p1V2XbaSBTkMxIQ6kVra2eVhFgtGbBPMjPJ5NgnXuZp/v8Xam6LwYfE2HH8UOd2Q3dRfZeik6cB0osSxV+fcHdzi2o+RxRFSNMUSZK8Gfp8GIboRMqDN8mQrZfY1ZfIsgye50Ep9dvQ9zpcCAjOMHHHmCVzBJGC67pgjIFz/gOEPvsLdI4Lx3GQxAO4ftCuLctqo23b7VpHKeXbCaXgCJIp4iHlMFBtPo750TnVUZP+SmnndMPp6X6QQqUFLMqH7flwfAXb98EtG6aQMOUJ6I4Gf4lQP0kTjqMMlW+jChWqwMdM+RgKhqTfQ2IaT0i52X7u0uv4WYWkwOp38UcSYv/lGy5nIzTlBHUxwm5RYL8osZvn2C9nuF5VKEMfV6yLuTTRo7vyOaGARSq3dLCZ5mgShToJ0KQH1LFCk4VP67krccW7yInQeE4oYZt9iOUF4tsHVJaJUheD8qq6XQS9HgKjB0Ux7BuIWJ++MxEJ/kpRCDYduCSF65wUDlyCh4vUeUKduag8gcKi3iU00sCEFPbPPlkeVH6NQ3y5/hN3qwD3dYr7TYzvqwPuNgkal6HqfkBp9vC3+IiF6L+UQyoKM3FDCm/rGg+Fi4dS4S73KPptvC+8Nj7S/tvExaPdxVIYLxNKZmBN7TLbbKnKCvtViqtNimYWUaUTbKsY23mMK/p8XUa4cExMSeGzouiNKTlWToZ/VYHS4yipqSsVYEDTEVExYsM4gNbH/YD60Dlp7h8UMipI7CoUyQhSTwqZhE1R0Cwzyq/O8TEe169OCqf8DaczXH7+ijgKMRgMoGjsBCmU/7/iHF6ZZUmOY6MsfPI2Hz6RaUN4i22dJWRMYjxysG0iMswQQRC086298V2E3BRI8wCL6zF872BhGtpw30fIBEKahHKdkMKgVait/Z2EuqkN8GkDtv0HCf3XRFQY33Pph9ibCvJModAX0wzWbAGu3dn1wBwXBuXRkFbbvD+DvVoUk2aU/O7x5jN2NH57sq6NZyM3yaKMjygozmgqjqgI6sRcxc+TYpDCHY3dcrHCiAxiOswI5OBphDIfY5xEiMmyYpqOkDAWJjbkNuwsoX4WOc2Omnm7+4TFOEVNzlzPCywnA9Tk1otRhiHvYyS09ZNfksIl4ZTwP0Yo+/6QNT1iAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='21f5d279' title='' src='/static/734e673304a268069acc4801e92b549c/244f0/21f5d279.png' srcset='/static/734e673304a268069acc4801e92b549c/e7570/21f5d279.png 170w,\n/static/734e673304a268069acc4801e92b549c/f46e7/21f5d279.png 340w,\n/static/734e673304a268069acc4801e92b549c/244f0/21f5d279.png 648w' sizes='(max-width: 648px) 100vw, 648px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>패키지 구조는 위와 같이 구성되었고 각각의 코드는 다음과 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token comment\">// DatabaseCleaner.java</span>\n<span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">DatabaseCleaner</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> tableNames <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@PersistenceContext</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">EntityManager</span> entityManager<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@SuppressWarnings</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"unchecked\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token annotation punctuation\">@PostConstruct</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">findDatabaseTableNames</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">List</span><span class=\"token operator\">&lt;</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span> tableInfos <span class=\"token operator\">=</span> entityManager<span class=\"token punctuation\">.</span><span class=\"token function\">createNativeQuery</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SHOW TABLES\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getResultList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> tableInfo <span class=\"token operator\">:</span> tableInfos<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">String</span> tableName <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span> tableInfo<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n            tableNames<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>tableName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">void</span> <span class=\"token function\">truncate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        entityManager<span class=\"token punctuation\">.</span><span class=\"token function\">createNativeQuery</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SET FOREIGN_KEY_CHECKS %d\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">executeUpdate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> tableName <span class=\"token operator\">:</span> tableNames<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            entityManager<span class=\"token punctuation\">.</span><span class=\"token function\">createNativeQuery</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"TRUNCATE TABLE %s\"</span><span class=\"token punctuation\">,</span> tableName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">executeUpdate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n        entityManager<span class=\"token punctuation\">.</span><span class=\"token function\">createNativeQuery</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"SET FOREIGN_KEY_CHECKS %d\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">executeUpdate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Transactional</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        entityManager<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">truncate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// DatabaseClearExtension.java</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">DatabaseClearExtension</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">BeforeEachCallback</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">beforeEach</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ExtensionContext</span> context<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">DatabaseCleaner</span> databaseCleaner <span class=\"token operator\">=</span> <span class=\"token function\">getDataCleaner</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        databaseCleaner<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">DatabaseCleaner</span> <span class=\"token function\">getDataCleaner</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ExtensionContext</span> extensionContext<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">SpringExtension</span><span class=\"token punctuation\">.</span><span class=\"token function\">getApplicationContext</span><span class=\"token punctuation\">(</span>extensionContext<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">getBean</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DatabaseCleaner</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// AcceptanceTest.java</span>\n<span class=\"token annotation punctuation\">@ExtendWith</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DatabaseClearExtension</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@SpringBootTest</span><span class=\"token punctuation\">(</span>webEnvironment <span class=\"token operator\">=</span> <span class=\"token class-name\">SpringBootTest<span class=\"token punctuation\">.</span>WebEnvironment</span><span class=\"token punctuation\">.</span><span class=\"token constant\">RANDOM_PORT</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AcceptanceTest</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@LocalServerPort</span>\n    <span class=\"token keyword\">int</span> port<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@BeforeEach</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">setUp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">RestAssured</span><span class=\"token punctuation\">.</span>port <span class=\"token operator\">=</span> port<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n\n<span class=\"token comment\">// DictionaryPlantApiTest.java</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">DictionaryPlantApiTest</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">AcceptanceTest</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Reference</h2>\n<p><a href=\"https://ttl-blog.tistory.com/1407\">https://ttl-blog.tistory.com/1407</a>\n<a href=\"https://mangkyu.tistory.com/264\">https://mangkyu.tistory.com/264</a>\n<a href=\"https://stackoverflow.com/questions/41763417/api-test-transactional-rollback\">https://stackoverflow.com/questions/41763417/api-test-transactional-rollback</a>\n<a href=\"https://stackoverflow.com/questions/62142428/dirtiescontext-does-not-work-with-nested-tests\">https://stackoverflow.com/questions/62142428/dirtiescontext-does-not-work-with-nested-tests</a>\n<a href=\"https://unluckyjung.github.io/testcode/2021/05/08/Independent-Test-Mehod/\">https://unluckyjung.github.io/testcode/2021/05/08/Independent-Test-Mehod/</a>\n<a href=\"https://www.baeldung.com/junit-5-extensions\">https://www.baeldung.com/junit-5-extensions</a></p>","frontmatter":{"title":"인수테스트 데이터 초기화하기","date":"August 03, 2023","update":"August 03, 2023","tags":["인수테스트","RestDocs","테스트"],"series":null},"fields":{"slug":"/acceptance-test-resolve/","readingTime":{"minutes":13.81}}},"seriesList":{"edges":[{"node":{"id":"28f1d87e-d3fc-5567-8531-57649652864f","fields":{"slug":"/sprint-idea/"},"frontmatter":{"title":"구글 스프린트 기반 아이디어 도출"}}},{"node":{"id":"4a9246fb-171b-5973-88fc-864034e78afd","fields":{"slug":"/blog-starter/"},"frontmatter":{"title":"피움 블로그 생성과정"}}},{"node":{"id":"a387bf4f-567f-50e7-b6a7-99a1a1c8971b","fields":{"slug":"/jpa-notnull-nullable/"},"frontmatter":{"title":"@NotNull과 nullable = false는 어떤 차이가 있을까?"}}},{"node":{"id":"c826ce0e-1ea7-517c-8d19-84e90a59a798","fields":{"slug":"/jenkins-setting/"},"frontmatter":{"title":"젠킨스 설치하기"}}},{"node":{"id":"a78e224b-b711-5071-8e90-013d6f4bebc3","fields":{"slug":"/pium-deploy-step/"},"frontmatter":{"title":"피움의 배포과정"}}},{"node":{"id":"ce07fbab-1ed5-5f1e-8e2f-eb430879b56a","fields":{"slug":"/fe-tanstack-query/"},"frontmatter":{"title":"프론트엔드: Tanstack Query 사용에 대하여"}}},{"node":{"id":"159c943b-1a50-57dd-aa71-7557364752a5","fields":{"slug":"/ci-cd-setting/"},"frontmatter":{"title":"Jenkins와 Github Webhook을 이용해 CI/CD 구축하기"}}},{"node":{"id":"dea45a4a-bfde-5fbb-8a97-42d3a3e77a0b","fields":{"slug":"/jenkins-hook-by-label/"},"frontmatter":{"title":"PR 라벨로 젠킨스 빌드유발을 구분하기"}}},{"node":{"id":"cecbc8b9-db00-562b-aa0b-06c406cfc44a","fields":{"slug":"/bundle-analyze/"},"frontmatter":{"title":"bundle-analyze를 통한 bundle 크기 분석"}}},{"node":{"id":"1a03734e-d413-553f-9152-1dad2fc4acca","fields":{"slug":"/apply-https/"},"frontmatter":{"title":"내 서버에 HTTPS 설정하기"}}},{"node":{"id":"707f8ffb-1409-5c27-b15a-5661b235c226","fields":{"slug":"/db-drop-stop/"},"frontmatter":{"title":"Table Drop 못하게 막아버리기"}}},{"node":{"id":"fe4b591a-4dd5-5dd2-b18a-b318afd1e9e3","fields":{"slug":"/transactional-not-in-restassured/"},"frontmatter":{"title":"[트러블슈팅] @SpringbootTest의 RANDOM_PORT 환경에서 @Transactional 어노테이션을 사용했을 때, RestAssured GET 요청이 수행되지 않는 경우(트랜잭션 격리 이해하기)"}}},{"node":{"id":"80aa708e-ef8a-5c79-9644-cb8c04d55a63","fields":{"slug":"/acceptance-test-resolve/"},"frontmatter":{"title":"인수테스트 데이터 초기화하기"}}},{"node":{"id":"15def1d5-c20f-5d07-b46e-24a14661365f","fields":{"slug":"/react-setting-without-cra/"},"frontmatter":{"title":"webpack으로만 React 설정하기 (without CRA)"}}},{"node":{"id":"66383c86-e2c8-533a-90e0-2effae572742","fields":{"slug":"/stylelint-and-husky/"},"frontmatter":{"title":"stylelint와 husky를 통해 컨벤션 통일하기"}}},{"node":{"id":"ed5951d5-beda-5a8f-adb2-07c2fcb38d5e","fields":{"slug":"/OAuth2.0/"},"frontmatter":{"title":"내가 이해한 OAuth2.0"}}},{"node":{"id":"45eeb9a3-557d-5704-8fd9-925283e1e27b","fields":{"slug":"/restdocs-start/"},"frontmatter":{"title":"RestDocs로 API 문서화하기"}}}]},"previous":{"fields":{"slug":"/transactional-not-in-restassured/"},"frontmatter":{"title":"[트러블슈팅] @SpringbootTest의 RANDOM_PORT 환경에서 @Transactional 어노테이션을 사용했을 때, RestAssured GET 요청이 수행되지 않는 경우(트랜잭션 격리 이해하기)"}},"next":{"fields":{"slug":"/react-setting-without-cra/"},"frontmatter":{"title":"webpack으로만 React 설정하기 (without CRA)"}}},"pageContext":{"id":"80aa708e-ef8a-5c79-9644-cb8c04d55a63","series":null,"previousPostId":"fe4b591a-4dd5-5dd2-b18a-b318afd1e9e3","nextPostId":"15def1d5-c20f-5d07-b46e-24a14661365f"}},"staticQueryHashes":[],"slicesMap":{}}