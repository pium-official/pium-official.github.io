{"componentChunkName":"component---src-templates-post-jsx","path":"/querydsl_apply_procedure/","result":{"data":{"site":{"siteMetadata":{"title":"pium.log"}},"markdownRemark":{"id":"709124d0-5b05-5530-804d-e90ec9856a13","excerpt":"이 글은 우테코 피움팀 크루 '하마드'가 작성했습니다. 개요 우아한테크코스 5기 피움 프로젝트를 진행하면서, 필터링 기능 구현을 위해 Querydsl을 적용한 과정을 정리한다 이전글 과정 본 프로젝트는 다음과 같은 환경에서 구성되었다 Springboot 3.1.1 JAVA 17 Querydsl 설정 build.gradle에 관련 코드 추가   파일에 위 …","html":"<blockquote>\n<p>이 글은 우테코 피움팀 크루 '<a href=\"https://github.com/rawfishthelgh\">하마드</a>'가 작성했습니다.</p>\n</blockquote>\n<h2>개요</h2>\n<hr>\n<p>우아한테크코스 5기 피움 프로젝트를 진행하면서, 필터링 기능 구현을 위해 Querydsl을 적용한 과정을 정리한다</p>\n<p><a href=\"https://pium-official.github.io/why_we_applied_querydsl/\">이전글</a></p>\n<h2>과정</h2>\n<hr>\n<blockquote>\n<p>본 프로젝트는 다음과 같은 환경에서 구성되었다</p>\n<p>Springboot 3.1.1</p>\n<p>JAVA 17</p>\n</blockquote>\n<h2>Querydsl 설정</h2>\n<hr>\n<h3>build.gradle에 관련 코드 추가</h3>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/fda9bdedd608b74362b48ecab9e7ce73/5fbd7/1.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 77.05882352941177%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABYlAAAWJQFJUiTwAAACbElEQVR42m2T63LaMBCFeZY2TWLJutmWbGPA4ZIhQC6l0+ZH2+n7v8XpkQQJzfTH513vyMfS7tHEhxb9dEA/zBDaDtoYlEoyKihdknO8yFX5XlMq11mTUmJS8jHMFthsd1jdbzFf3ME1BmGoE+2sSbHpK/jIKY+EaY26c/Axtg5lWWIS/1BVDeJOGx+Y1+nPxhmiYSqdo9XQNufaqrfc2LxDIWTeYaE0d+T59ymatmceUHKRqS10pDJQ8cMm57rOWG+5TiduZAkhT4K/xSc8qlscTYEXfYsX5k/yCx4j4oKP7ySuO5Dv4jOMFEl08iyu4HyLOYcyTKdovYdWAs6xFcRyOI47jNHa07vNNU2BWx71QPFaFiii4IGC1TDHuFxjWCzJHXoOyQWXGl61H2Dd8bh1V6EOFgV7vS0uBF/UNfx8xHpzn0TH1Qbj3Rq+82gHDqurUwz9O03L2rRJuK7BsS7RcjCl1pgcLbet2WT6T7OgmWtj0+R08pd685pO6BwNBxWny/jE/vvoQ66bfFNXKCjmXAVHy1jrYPiu6Kmzwc8oIkuZLCKEgCTXPOZDcfV+5J/BoB/X6LoeTQj0okfdNMmPtnLJb5ksGgXlySLxUkTL7C6H8kybqJoiFIgi0dyREI1Of0b3nwXO5pWn2n8Fj7rANRe6eCzekHycfKSi4KLbjGAeBaQo3ijJDWv/CH5ln8b1En9+7fH64wHb7Qr73X2Kq+UM81nAYh7Qc5qKA7FVxStXpehIHOiDuOjhq77BItQ48MPdELCfRVrshxx3MZ+32NA+PXu58A0W7PHIXo/MgzV4Kj6j4k2Jgn8B68PbdTAtWFUAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='1' title='' src='/static/fda9bdedd608b74362b48ecab9e7ce73/ca1dc/1.png' srcset='/static/fda9bdedd608b74362b48ecab9e7ce73/e7570/1.png 170w,\n/static/fda9bdedd608b74362b48ecab9e7ce73/f46e7/1.png 340w,\n/static/fda9bdedd608b74362b48ecab9e7ce73/ca1dc/1.png 680w,\n/static/fda9bdedd608b74362b48ecab9e7ce73/02d09/1.png 1020w,\n/static/fda9bdedd608b74362b48ecab9e7ce73/5fbd7/1.png 1276w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">dependencies {\n    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'\n    implementation 'org.springframework.boot:spring-boot-starter-validation'\n    implementation 'org.springframework.boot:spring-boot-starter-web'\n\n    implementation 'com.github.maricn:logback-slack-appender:1.6.1'\n\n    //querydsl 추가\n    implementation 'com.querydsl:querydsl-jpa:5.0.0:jakarta'\n    annotationProcessor \"com.querydsl:querydsl-apt:5.0.0:jakarta\"\n    annotationProcessor \"jakarta.annotation:jakarta.annotation-api\"\n    annotationProcessor \"jakarta.persistence:jakarta.persistence-api\"\n}\n\n//querydsl 추가\ndef querydslSrcDir = 'src/main/generated'\n\nclean {\n    delete file(querydslSrcDir)\n}\n\ntasks.withType(JavaCompile) {\n    options.generatedSourceOutputDirectory = file(querydslSrcDir)\n}</code></pre></div>\n<p><code class=\"language-text\">build.gradle</code> 파일에 위 설정을 추가해 준다.\n<code class=\"language-text\">dependencies</code> 하부의 옵션 설정은 아래와 같은 의미를 가진다.</p>\n<p><code class=\"language-text\">def querydslSrcDir = 'src/main/generated'</code></p>\n<p>Querydsl이 생성한 소스 코드를 저장할 디렉토리를 정의한다. 여기서는 'src/main/generated'로 디렉토리 경로를 지정하고, 이를 querydslSrcDir 변수에 할당한다.</p>\n<p><code class=\"language-text\">clean { delete file(querydslSrcDir) }</code></p>\n<p>Gradle의 clean 태스크를 정의하고, 해당 태스크가 실행될 때 querydslSrcDir 디렉토리를 삭제하도록 한다. 즉, 프로젝트를 clean 하면 Querydsl이 생성한 소스 코드도 삭제된다.</p>\n<p><code class=\"language-text\">tasks.withType(JavaCompile) { options.generatedSourceOutputDirectory = file(querydslSrcDir) }</code></p>\n<p>JavaCompile 태스크 유형을 가진 모든 태스크에 대해, 컴파일 옵션 중에서 생성된 소스 코드의 출력 디렉토리를 querydslSrcDir로 설정한다. Querydsl이 생성한 소스 코드가 지정한 디렉토리에 컴파일되도록 보장한다.</p>\n<h3>build 수행 및 Q Class 생성</h3>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 610px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/c403e5c3d0be112b1ba88b848597f89e/5d5ad/2.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 70.58823529411764%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABYlAAAWJQFJUiTwAAACF0lEQVR42o2S3W7UMBCF80YItFTtxs7/f5xsEidOsil0t1CEqHgCrlCvEdzxuIdxsoUu3RYujsaxZz5NzoyRdXuo3Sd0JJYqmEk3ax21S4wpxsudjutkyTkPJaLmCsP1Z9hihC8UumGE4acVwryBn1VgfgbTS+fopcu3HRVz1LJCASvIj87BoY57CYZxglGUFdIsRxglcDwfjFtw/QBqGuB5ARrZIU4yFOUGhVQo3tzAiyO00wTX9TFOl3OerpVtB8N2PPhhgjgVCMJ4FrMcmNwGp2hTkWV7JBecxIIY3KEz1XGb3nWkPP3ej1sYDhWkYgPZb6nlLcq6mQs1hB8gM4iK5rNlH6JzdG8ReFNLGOxATwha7j5iU9UYthO8IMKaWXOnv2FPSMN07qvVGYyHl1FWoH57Q11K8kOhaiRaNZAd+T+hjDoX5PMRME5SNO9usaFBdP2ATJQEo4kH4X91+Ajo00DEdI2qG1A3LdwDSE/wPufJDsmaq93+D/DeYJPWRlTtbLD2Ug1bqH6kVQpxYfKTv750yGHT1I2/H/UaFATUPtayRad6tOSn7Ho6D8iL8iRUe2g6wWMgo3WpGvKQgIqGomhZs6IiOyKkuZhtOdkl6XL//oGHpAvqrmfn+J45+CoC3JUhfmQ2djbDijtgZPxz066pgSPgmePjw3qFn5GJLyLCnRT4xl/i9vULrNwQzjOT1pKqxy/ZQ/01dKKAJgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='2' title='' src='/static/c403e5c3d0be112b1ba88b848597f89e/5d5ad/2.png' srcset='/static/c403e5c3d0be112b1ba88b848597f89e/e7570/2.png 170w,\n/static/c403e5c3d0be112b1ba88b848597f89e/f46e7/2.png 340w,\n/static/c403e5c3d0be112b1ba88b848597f89e/5d5ad/2.png 610w' sizes='(max-width: 610px) 100vw, 610px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n<span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/2dc4a522b3257f1c773f681382f950f1/cfc60/3.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 67.05882352941177%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABYlAAAWJQFJUiTwAAABEklEQVR42qWS23KCMBRF/abWqUSEHLmEBNRh0IJTcXjr///B7jmp8lZF+rAhAzMr61wWsd4iyQxO5x51cwKlGeTb3CwifkgyY9FdBjTHTxSuwiYm3P+9khGYsmU9fKPtBxwONQM1YvoHMNYEbUrY7gv7vYKxAVy1AiUxw2cAfbjM3Do0XQvjFJeuYMuAs+JzwJcof85MyJckE4CSSCMqdiA2rao3bynJzRoREbfhN9MMPZBLNDvorkdZvntDsbu/H8EeAomBzi09KM03t//0Yg9HYAXdXuDKJQpvpnz/xFCGNN9QgDIYF9x6+QG91fOBMhQpWewE9Az2tGQZiphJqWGU/Lkq0wzP13FtZPfyIpy02D8v/soDs0ql4wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='3' title='' src='/static/2dc4a522b3257f1c773f681382f950f1/ca1dc/3.png' srcset='/static/2dc4a522b3257f1c773f681382f950f1/e7570/3.png 170w,\n/static/2dc4a522b3257f1c773f681382f950f1/f46e7/3.png 340w,\n/static/2dc4a522b3257f1c773f681382f950f1/ca1dc/3.png 680w,\n/static/2dc4a522b3257f1c773f681382f950f1/cfc60/3.png 776w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>이제 바뀐 설정 파일로 <code class=\"language-text\">build</code>를 수행하면 우리가 지정한<code class=\"language-text\">src/main/generated</code> 경로에 위와 같은 Q Class가 생성된다.</p>\n<p>QueryDsl은 빌드 시점에 애플리케이션의 도메인 중 <code class=\"language-text\">@Entity</code>와 <code class=\"language-text\">@Embeddable</code> 어노테이션이 포함된 클래스를 찾아 Q Class를 생성한다. 이 Q class를 가지고 애플리케이션 내부에서 QueryDsl 관련 로직을 적용해야 한다.</p>\n<h2>적용</h2>\n<hr>\n<h3>JPAQueryFactory Bean 등록</h3>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/4d3053434736eb33e9f1a587f870c838/5c9dd/4.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 70%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB30lEQVR42qWTyZKjMBBE/TdGG4hFEmI1dndP+Dz//y3ZKYHbExMT9mEODykQkarKLE5xUBhGjT4qhKDQ9wp1XUAKCSkFhNhJe6UkUS85bRS8Ro2JQhvXlQxjhA8R/TAe64S2cyjL6q3oqS0VXKVQ8cOuJJVG6zw65+B84OozTdPCGPO+QiEVhNT82EKTc6FwPksiMkWxt763rN4LSpk8Y8tTzVZruE4ScVCwst07KXdE8vXFBblCT5FtkrgMEstU4rI5rGuL2y1gWT3qpoEtazS2RWu7TGMbGK3/USEf1lCU3kWr0FQWLkz0jcH0M+KwcB+ySGh7wpDciJ770mjIvwXTQyqdfZTaHClKaK2g016ro2Xx0+6DFx6WnL+WBFQcDWtrdF2XcUy7qqrDP16eQ3zy8PbpoWC7TuH+JRF9qsxQwDL1MqM5KgnDSmurYWmNLZ+rOc4f83lSNLbhLK6txtzyr4k9bp9fWJYV63bD5fqBcd6wDA6/7wPuV4/75vGLYd0vHvM4soueF5qnh5qiBcsPdRJNAy4w8vcLrsOyfXCcZgzTgjhd4CMDCTM6y3C6GaPnmZsZVKRdBqckZuuaiZkjjDQK5BiJ5M/+bg/q4ZXOheyBqeM8V5hm7E9T/5dvW3qycq74yzIAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='4' title='' src='/static/4d3053434736eb33e9f1a587f870c838/ca1dc/4.png' srcset='/static/4d3053434736eb33e9f1a587f870c838/e7570/4.png 170w,\n/static/4d3053434736eb33e9f1a587f870c838/f46e7/4.png 340w,\n/static/4d3053434736eb33e9f1a587f870c838/ca1dc/4.png 680w,\n/static/4d3053434736eb33e9f1a587f870c838/5c9dd/4.png 836w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Configuration</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">QueryDslConfig</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@PersistenceContext</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">EntityManager</span> entityManager<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Bean</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">JPAQueryFactory</span> <span class=\"token function\">jpaQueryFactory</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">JPAQueryFactory</span><span class=\"token punctuation\">(</span>entityManager<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>JPAQueryFactory는 Querydsl을 사용하여 JPA 쿼리를 생성하고 실행하기 위한 클래스다. <code class=\"language-text\">EntityManager</code>를 주입해 JPAQueryFactory가 db 상호 작용을 수행할 수 있도록 해주는 Config 파일을 작성한다.</p>\n<h3>Querydsl 질의용 Repository 생성 및 적용</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">HistoryCustomRepository</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token class-name\">Page</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">History</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findAllByPetPlantIdAndHistoryTypes</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> petPlantId<span class=\"token punctuation\">,</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">HistoryType</span><span class=\"token punctuation\">></span></span> historyTypes<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Pageable</span> pageable<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>먼저 해당 기능을 추상화한 Repository 인터페이스를 정의한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">import</span> <span class=\"token keyword\">static</span> <span class=\"token import static\"><span class=\"token namespace\">com<span class=\"token punctuation\">.</span>official<span class=\"token punctuation\">.</span>pium<span class=\"token punctuation\">.</span>domain<span class=\"token punctuation\">.</span></span><span class=\"token class-name\">QHistory</span><span class=\"token punctuation\">.</span><span class=\"token static\">history</span></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token annotation punctuation\">@Repository</span>\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">HistoryCustomRepositoryImpl</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">HistoryCustomRepository</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">JPAQueryFactory</span> jpaQueryFactory<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Page</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">History</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">findAllByPetPlantIdAndHistoryTypes</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> petPlantId<span class=\"token punctuation\">,</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">HistoryType</span><span class=\"token punctuation\">></span></span> historyTypes<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Pageable</span> pageable<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">History</span><span class=\"token punctuation\">></span></span> histories <span class=\"token operator\">=</span> jpaQueryFactory<span class=\"token punctuation\">.</span><span class=\"token function\">selectFrom</span><span class=\"token punctuation\">(</span>history<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">where</span><span class=\"token punctuation\">(</span>history<span class=\"token punctuation\">.</span>petPlant<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">.</span><span class=\"token function\">eq</span><span class=\"token punctuation\">(</span>petPlantId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">inHistoryType</span><span class=\"token punctuation\">(</span>historyTypes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">orderBy</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">OrderSpecifier</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Order</span><span class=\"token punctuation\">.</span><span class=\"token constant\">DESC</span><span class=\"token punctuation\">,</span> history<span class=\"token punctuation\">.</span>createdAt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">OrderSpecifier</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Order</span><span class=\"token punctuation\">.</span><span class=\"token constant\">DESC</span><span class=\"token punctuation\">,</span> history<span class=\"token punctuation\">.</span>date<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">offset</span><span class=\"token punctuation\">(</span>pageable<span class=\"token punctuation\">.</span><span class=\"token function\">getOffset</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">limit</span><span class=\"token punctuation\">(</span>pageable<span class=\"token punctuation\">.</span><span class=\"token function\">getPageSize</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">PageImpl</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">History</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>histories<span class=\"token punctuation\">,</span> pageable<span class=\"token punctuation\">,</span> <span class=\"token function\">getCount</span><span class=\"token punctuation\">(</span>petPlantId<span class=\"token punctuation\">,</span> historyTypes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> <span class=\"token function\">getCount</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> petPlantId<span class=\"token punctuation\">,</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">HistoryType</span><span class=\"token punctuation\">></span></span> historyTypes<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> jpaQueryFactory<span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span>history<span class=\"token punctuation\">.</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>history<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">where</span><span class=\"token punctuation\">(</span>history<span class=\"token punctuation\">.</span>petPlant<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">.</span><span class=\"token function\">eq</span><span class=\"token punctuation\">(</span>petPlantId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">inHistoryType</span><span class=\"token punctuation\">(</span>historyTypes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">fetchOne</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">BooleanExpression</span> <span class=\"token function\">inHistoryType</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">HistoryType</span><span class=\"token punctuation\">></span></span> historyTypes<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>historyTypes <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">||</span> historyTypes<span class=\"token punctuation\">.</span><span class=\"token function\">isEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">return</span> history<span class=\"token punctuation\">.</span>historyCategory<span class=\"token punctuation\">.</span>historyType<span class=\"token punctuation\">.</span><span class=\"token function\">in</span><span class=\"token punctuation\">(</span>historyTypes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>가장 중요한 부분이다. HistoryCustomRepository를 implements한 HistoryCustomRepositoryImpl를 작성한다.</p>\n<p>여기서 <strong>인터페이스명+impl 네이밍 규약을 반드시 지켜야</strong> 향후 HistoryRepository에 extends 할 시 해당 구현체가 주입될 수 있다.</p>\n<p>또 여기서 사용하려는 Q class(QHistory)를 위와 같이 static import하여 사용한다.</p>\n<p><code class=\"language-text\">import static com.official.pium.domain.QHistory.history;</code></p>\n<p>먼저, 우리가 수행하려는 동작과 도출하고자 하는 쿼리 형태는 아래와 같다.</p>\n<blockquote>\n<ul>\n<li>기능 : 리스트로 받은 히스토리 타입들에 해당하는 히스토리를 시간순으로 조회하고, 페이징 정보(size, page)에 해당하는 만큼 데이터를 가져온다.</li>\n</ul>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">select *\n    from\n        history h1_0 \n    join\n        history_category h2_0 \n            on h2_0.id=h1_0.history_category_id \n    where\n        h1_0.pet_plant_id=(반려식물_id) \n        and h2_0.history_type in (타입1,타입2...) \n    order by\n        h1_0.created_at desc,\n        h1_0.event_date desc \n        offset (페이지번호 * 페이지사이즈) rows fetch first (페이지사이즈) rows only</code></pre></div>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/7c2c065972391c9a85d2001b1e8b5c13/7b3ec/5.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 34.11764705882353%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABFklEQVR42m2RWXaEIBBF3U0UlEFQBBHUJPtf0ktR6e6PpD/eqRkuRWeMxew8tDGYlIKxMwz54zhBK0sy0JOGmhT32FbXlnOtZxh6iGFgDaTOzg4zKZeKct7YY0UMOzafkJYDgeyxn9hz4XpMifyKvFNfyvAhYFk3rCFi3SI6ISTf4pYFiYZmIm40TKENlNJEbZnOtLiRUk5pzfXZOrKa+1quk1KiSYiG/YHiJdNen984768XWak38loQXEAOlegzSrzg3YqR5wWrk49gCRsT1uvmA/ej4KgX+Sec93zpOI40/BDtr8Vt9gnV1D2TG+3jSdT2sawBISb220fIP4O/+p97PXmi3Sit+Lf6vucfG5olibeHvdcPyCvchkMbUOgAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='5' title='' src='/static/7c2c065972391c9a85d2001b1e8b5c13/ca1dc/5.png' srcset='/static/7c2c065972391c9a85d2001b1e8b5c13/e7570/5.png 170w,\n/static/7c2c065972391c9a85d2001b1e8b5c13/f46e7/5.png 340w,\n/static/7c2c065972391c9a85d2001b1e8b5c13/ca1dc/5.png 680w,\n/static/7c2c065972391c9a85d2001b1e8b5c13/02d09/5.png 1020w,\n/static/7c2c065972391c9a85d2001b1e8b5c13/7b3ec/5.png 1284w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>이제 위 코드를 천천히 파악해보자.</p>\n<blockquote>\n<p><strong><code class=\"language-text\">jpaQueryFactory.selectFrom(history)</code></strong></p>\n</blockquote>\n<p>history를 대상으로 select 질의를 수행함을 의미한다</p>\n<blockquote>\n<p><strong><code class=\"language-text\">.where(history.petPlant.id.eq(petPlantId), inHistoryType(historyTypes))</code></strong></p>\n</blockquote>\n<p>where 조건문을 사용하는 코드이다. <code class=\"language-text\">eq</code> 메소드를 통해 파라미터로 주입받은 <code class=\"language-text\">petPlantId</code>와의 비교를 수행한다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/1805e041feeb92ebaea1a0c8c6377069/98b00/6.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 30.58823529411765%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAABBklEQVR42kWRW3aDMAxEWQ74KVsGl8RQ0ux/TdOxk7Qf90hIYtCISVNELRk5Z2y1opKsihAFEj00eaToiEcIkXUSAmJ4RZGEKJxNCd4HTCoOrVi0+x3teuL4/sHeTuz7DWcVPNqGx1nxvO64sd5p54XjfKCsG0ohW8X2tQ/xyVgLR2pJOLaMVnXkwTlEZ2D51SgZkpUulJvQjZaxkePMsix/GGMwdTHH1S2jNQuZ2eAAm2bAwfHC/Ib5PA9Gr8+8l+oaY8MULFbpd0rIoowZKoXoeJZRL/+9dR12tTAS7/1roS7YjxzdSzT6CAmJAjxykCHUBWLPWe+xk2g78Sd22/0MntY/gr8a2buaPBT/wwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='6' title='' src='/static/1805e041feeb92ebaea1a0c8c6377069/ca1dc/6.png' srcset='/static/1805e041feeb92ebaea1a0c8c6377069/e7570/6.png 170w,\n/static/1805e041feeb92ebaea1a0c8c6377069/f46e7/6.png 340w,\n/static/1805e041feeb92ebaea1a0c8c6377069/ca1dc/6.png 680w,\n/static/1805e041feeb92ebaea1a0c8c6377069/02d09/6.png 1020w,\n/static/1805e041feeb92ebaea1a0c8c6377069/98b00/6.png 1202w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>위는 <code class=\"language-text\">in</code> 절을 수행하는 <code class=\"language-text\">inHistoryType</code> 메소드다. 여기서 반환 타입을 <code class=\"language-text\">BooleanExpression</code>으로 사용한 것에 주목하자. <strong><code class=\"language-text\">BooleanExpression</code> 의 반환값이 null일 경우, 자동으로 조건절에서 제외된다.</strong> 따라서 우리는 <code class=\"language-text\">historyTypes</code>가 들어오지 않았을 경우, in 절을 수행하지 않도록 지정했다.</p>\n<blockquote>\n<p><strong><code class=\"language-text\">.orderBy(new OrderSpecifier&lt;>(Order.DESC, history.createdAt), new OrderSpecifier&lt;>(Order.DESC, history.date))</code></strong></p>\n</blockquote>\n<p><code class=\"language-text\">order by</code>의 Sorting 조건을 지정하기 위한 부분이다.\n<strong>Sorting 조건은 <code class=\"language-text\">OrderSpecifier</code> 클래스로 정의해 지정해야 한다.</strong></p>\n<p>첫 인자에 Sorting 방향 Enum(Order.DESC)을, 두 번째 인자에 Sorting 대상 필드(history.createdAt)를 지정한다. 우리는 Sorting 조건이 두 가지이므로, 두 개의 <code class=\"language-text\">OrderSpecifier</code> 를 정의해 정렬 순서대로 넣어주었다.</p>\n<blockquote>\n<p><strong><code class=\"language-text\">.offset(pageable.getOffset().limit(pageable.getPageSize())</code></strong></p>\n</blockquote>\n<p>페이징 처리를 위한 offset, limit을 지정하는 부분이다. 이 부분은 그냥 Long 타입을 넣어주면 된다. 넘길 부분을 지정하는 offset 값과, 가져올 양을 지정하는 limit 값을 넣어준다.(해당 애플리케이션에서 offset 값은 Pageable 객체에 미리 계산되어 있다)</p>\n<blockquote>\n<p><strong><code class=\"language-text\">.fetch()</code></strong></p>\n</blockquote>\n<p><code class=\"language-text\">.fetch()</code> 를 활용하면 결과를 리스트로 반환할 수 있다. </p>\n<p>여기서 주의할 점은 <strong><code class=\"language-text\">.fetch()</code>를 사용한다고 <code class=\"language-text\">fetch join</code>을 수행하는 것이 아니다</strong>. 결과 반환 방법은 아래 블로그에 자세히 설명되어 있어 첨부하겠다.\n<a href=\"https://devocean.sk.com/blog/techBoardDetail.do?ID=163915\">참고</a></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token class-name\">Long</span> <span class=\"token function\">getCount</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> petPlantId<span class=\"token punctuation\">,</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">HistoryType</span><span class=\"token punctuation\">></span></span> historyTypes<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token keyword\">return</span> jpaQueryFactory<span class=\"token punctuation\">.</span><span class=\"token function\">select</span><span class=\"token punctuation\">(</span>history<span class=\"token punctuation\">.</span><span class=\"token function\">count</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token function\">from</span><span class=\"token punctuation\">(</span>history<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token function\">where</span><span class=\"token punctuation\">(</span>history<span class=\"token punctuation\">.</span>petPlant<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">.</span><span class=\"token function\">eq</span><span class=\"token punctuation\">(</span>petPlantId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">inHistoryType</span><span class=\"token punctuation\">(</span>historyTypes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">.</span><span class=\"token function\">fetchOne</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>조건에 해당하는 레코드의 총 개수를 전달하는 Count 쿼리를 날리는 메소드다. 간단하게 <code class=\"language-text\">.select()</code> 메소드의 Qclass에 <code class=\"language-text\">.count()</code> 만 추가하면 count 쿼리를 생성해준다.\n<code class=\"language-text\">.fetchOne()</code> 을 통해 단건으로 <code class=\"language-text\">Long</code>을 반환할 수 있다.</p>\n<h3>생성한 CustomRepository를 기존 사용하던 Repository에 extends</h3>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/1374af122469ae78b798f58986f85d4c/44982/7.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 31.176470588235293%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA7ElEQVR42k2Qa47EMAiDe53mAQRIMqO9/7m8hM6O9scnYqS6xpdLh1KBcYEOxjCH+YIMi32NfYPPBTV7UIXIwBgjtfnEXDsnx/5qvadQmzBTbBf46MmIHxBLGnBMZo6PjpbUtVaUWlBKyffhaq2FkYehh0GYKT0cQzkGmmmP8d97qGWact9p9nAnV4+Ea294xPY4YRtFSsaK+XLCO9jW8Z6c+uWR3kaazm8VUZPNnHFyJIxe3C07tDyXYlJq1ehVCML9CzOh06mD0TuBDnR2hOs8XBp+9nhYkmnm+cHpde6oQj9n1S/1c2r9x9G/zA67UCF53jQAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='7' title='' src='/static/1374af122469ae78b798f58986f85d4c/ca1dc/7.png' srcset='/static/1374af122469ae78b798f58986f85d4c/e7570/7.png 170w,\n/static/1374af122469ae78b798f58986f85d4c/f46e7/7.png 340w,\n/static/1374af122469ae78b798f58986f85d4c/ca1dc/7.png 680w,\n/static/1374af122469ae78b798f58986f85d4c/02d09/7.png 1020w,\n/static/1374af122469ae78b798f58986f85d4c/9d567/7.png 1360w,\n/static/1374af122469ae78b798f58986f85d4c/44982/7.png 1592w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>  이제 만든 CustomRepository를 기존 사용하던 Repository에 extends 하기만 하면 기존 Service에 새로운 인터페이스 필드를 선언하지 않고도 사용할 수 있다.</p>\n<p><strong>HistoryService.java</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Service</span>\n<span class=\"token annotation punctuation\">@Transactional</span><span class=\"token punctuation\">(</span>readOnly <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">HistoryService</span> <span class=\"token punctuation\">{</span>\n\n   <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">HistoryRepository</span> historyRepository<span class=\"token punctuation\">;</span>\n   <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">PetPlantRepository</span> petPlantRepository<span class=\"token punctuation\">;</span>\n\n   <span class=\"token keyword\">public</span> <span class=\"token class-name\">HistoryResponse</span> <span class=\"token function\">read</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Long</span> petPlantId<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Pageable</span> pageable<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Member</span> member<span class=\"token punctuation\">,</span> <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> filters<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n       <span class=\"token class-name\">PetPlant</span> petPlant <span class=\"token operator\">=</span> petPlantRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findById</span><span class=\"token punctuation\">(</span>petPlantId<span class=\"token punctuation\">)</span>\n               <span class=\"token punctuation\">.</span><span class=\"token function\">orElseThrow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NoSuchElementException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"일치하는 반려 식물이 존재하지 않습니다. id :\"</span> <span class=\"token operator\">+</span> petPlantId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n       <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>petPlant<span class=\"token punctuation\">.</span><span class=\"token function\">isNotOwnerOf</span><span class=\"token punctuation\">(</span>member<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n           <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">IllegalArgumentException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"요청 사용자와 반려 식물의 사용자가 일치하지 않습니다. id :\"</span> <span class=\"token operator\">+</span> member<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n       <span class=\"token punctuation\">}</span>\n\n       <span class=\"token class-name\">List</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">HistoryType</span><span class=\"token punctuation\">></span></span> historyTypes <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ArrayList</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n       <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>filters <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n           historyTypes <span class=\"token operator\">=</span> filters<span class=\"token punctuation\">.</span><span class=\"token function\">stream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                   <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HistoryType</span><span class=\"token operator\">::</span><span class=\"token function\">from</span><span class=\"token punctuation\">)</span>\n                   <span class=\"token punctuation\">.</span><span class=\"token function\">toList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n       <span class=\"token punctuation\">}</span>\n\n       <span class=\"token class-name\">Page</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">History</span><span class=\"token punctuation\">></span></span> historyPageByPetPlantId <span class=\"token operator\">=</span> historyRepository<span class=\"token punctuation\">.</span><span class=\"token function\">findAllByPetPlantIdAndHistoryTypes</span><span class=\"token punctuation\">(</span>petPlantId<span class=\"token punctuation\">,</span> historyTypes<span class=\"token punctuation\">,</span> pageable<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n       <span class=\"token keyword\">return</span> <span class=\"token class-name\">HistoryMapper</span><span class=\"token punctuation\">.</span><span class=\"token function\">toHistoryResponse</span><span class=\"token punctuation\">(</span>historyPageByPetPlantId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n   <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>기존에 주입받은 <code class=\"language-text\">historyRepository</code>를 활용해, 새로 생성한 <code class=\"language-text\">findAllByPetPlantIdAndHistoryTypes</code> 메소드를 사용하는 것을 확인할 수 있다.</p>\n<h2>결과</h2>\n<hr>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  select\n      h1_0.id,\n      h1_0.created_at,\n      h1_0.event_date,\n      h1_0.history_category_id,\n      h1_0.curr,\n      h1_0.prev,\n      h1_0.pet_plant_id,\n      h1_0.updated_at \n  from\n      history h1_0 \n  join\n      history_category h2_0 \n          on h2_0.id=h1_0.history_category_id \n  where\n      h1_0.pet_plant_id=? \n      and h2_0.history_type in (?,?) \n  order by\n      h1_0.created_at desc,\n      h1_0.event_date desc offset ? rows fetch first ? rows only\n2023-08-16 17:10:47.907 [main] TRACE org.hibernate.orm.jdbc.bind - binding parameter [1] as [BIGINT] - [1]\n2023-08-16 17:10:47.907 [main] TRACE org.hibernate.orm.jdbc.bind - binding parameter [2] as [VARCHAR] - [FLOWERPOT]\n2023-08-16 17:10:47.907 [main] TRACE org.hibernate.orm.jdbc.bind - binding parameter [3] as [VARCHAR] - [LOCATION]\n2023-08-16 17:10:47.907 [main] TRACE org.hibernate.orm.jdbc.bind - binding parameter [4] as [INTEGER] - [0]\n2023-08-16 17:10:47.907 [main] TRACE org.hibernate.orm.jdbc.bind - binding parameter [5] as [INTEGER] - [5]\nHibernate: \n  select\n      count(h1_0.id) \n  from\n      history h1_0 \n  join\n      history_category h2_0 \n          on h2_0.id=h1_0.history_category_id \n  where\n      h1_0.pet_plant_id=? \n      and h2_0.history_type in (?,?)\n2023-08-16 17:10:47.919 [main] TRACE org.hibernate.orm.jdbc.bind - binding parameter [1] as [BIGINT] - [1]\n2023-08-16 17:10:47.919 [main] TRACE org.hibernate.orm.jdbc.bind - binding parameter [2] as [VARCHAR] - [FLOWERPOT]\n2023-08-16 17:10:47.919 [main] TRACE org.hibernate.orm.jdbc.bind - binding parameter [3] as [VARCHAR] - [LOCATION]</code></pre></div>\n<p>테스트 코드를 통해 실제 어떤 쿼리가 실행되는지 확인해 보니,\n우리가 위에서 구현하고자 했던 sql 쿼리와 정확히 일치하는 것을 볼 수 있다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/7069fcd0b567febef28cf64686154923/d5719/8.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 177.64705882352942%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAkCAYAAACJ8xqgAAAACXBIWXMAABYlAAAWJQFJUiTwAAADn0lEQVR42rVW7W7iRhTlofZXn2G1j9E36I/+X6mP0AdppVW3VaNslUjkCwgQ85GYgPkKxtgYsI2/Tu+ZZihkSVCzqaVhhjvj47n3nntmCnGS4C/PwC/2Of6YVfDr9AJXvgmkwHK5xGKxwHw+V73v+wijCGmSYRGs4Ks5X9mDIECapii48QIfGj/hXeUHvDc+4rvqj/j+7mcgA8yOiVq9houLC9RqNZycnMCZOcizHKZtod42cH52htPTU1hWD3wKiaAaKwtFv4Vz/1b1ZjgGciBcRwiiEPF6jbW0MAyRiEd5niOOY2Vji2TXtGdZhgJ/3urhhwpED2UXbHESi6e5anx6kY0b2b1a/Gg7CNhqtVRsjo+PcXt7qybSLFV9cdFCedlR40wW8wX9Yr71fweQMaD/zBLHeoLPJPYQZOv/5nKlUsHR0dEOUKlUwu+fPqPh3qMTOHiYZxgO+iiVy6jX67i8vMSZZJfjsthIL+UFk7JareC67s6XFP88H4NwinkiO4+hMs21jDl7ruGYnunEqh3uy7JOwCSe77i8HcOntg0g2f1VcPENMdy3w56wvnJZRscfYhTNMQ8AZ2rDNE3c39/DMAyQHZ1OR9mY1E0M9wH2JQEtoymAA4wjH+4qh+e56Pf7mEwmCrTb7WI8HivbQcDnYvhql7PHmNpvBah3aCciW0mEtXgUCj0cx1EUs21bNY5p0y4fBHRSH04YYDhPMB4NUa3W0Gw2cX19rQjNxFDWyMuXY/i/ubyH2M+R+kVAimcaJ3hY/0tsFgDt28Kq/29X0F5ACsbnT7+h6XZhijiMPIqDhetqFTc3NygWi5tjgWu1Sj0bw0ikP5XUPkjpLdNIzpB/vq7LlO+w6fHBHT4Xw9cnJX9jcTAaDXz58xhtr4duOIO9yDEa9lER/lEYyEGKLMeM4Y7A7gOcuTOMrAH6gVSDCOwqyiXwkTrQSWLP81SVcMwLwKsF9puJ/WaA1Ll6pYrOYiTk9rEMpa6dqdJBy7KUqN7d3aHX6ykbz5YXYzidTkWxS0pghyKw9iKD5zpKoQeDgQJst9tqTNtBQO3yw2too9m/3VJ+RG5YE6nlVRptRJdrdZU8bbpqdgB5u9KTbIlcSQhOl9ieXkEoDHxH23ZcJjB5ptX36cGvRXT7oSgwgXt5SECqB28C2+XH+aqoTEOqh2u257iBq6sr1W+Swh1xIXseidpt2rSdRybnlE4+2riGOyd12KsQJQn+BvvD56hP/V+yAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='8' title='' src='/static/7069fcd0b567febef28cf64686154923/ca1dc/8.png' srcset='/static/7069fcd0b567febef28cf64686154923/e7570/8.png 170w,\n/static/7069fcd0b567febef28cf64686154923/f46e7/8.png 340w,\n/static/7069fcd0b567febef28cf64686154923/ca1dc/8.png 680w,\n/static/7069fcd0b567febef28cf64686154923/d5719/8.png 758w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>클라이언트 화면에서도 필터링이 잘 수행 된다. 기분이 좋다.</p>\n<h3>어떻게 join이 걸렸을까?</h3>\n<p>위 예시를 보면 join을 통해 연관관계가 있는 테이블 정보를 한 번에 가져와 n+1 문제가 발생하지 않는다. 그런데, 우리는 select where 설정만 했을 뿐, join 처리를 따로 하지 않았다. 그런데 어떻게 연관관계를 파악하고 Querydsl이 join을 생성해 준 걸까?</p>\n<p><strong>Where 조건에 추가된 연관 관계 정보를 확인하고 join 쿼리 생성</strong></p>\n<p>아까 where 조건에서 사용했던 <code class=\"language-text\">inHistoryTypes</code> 메소드를 다시 파악해볼 필요가 있다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/1805e041feeb92ebaea1a0c8c6377069/98b00/9.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 30.58823529411765%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAABBklEQVR42kWRW3aDMAxEWQ74KVsGl8RQ0ux/TdOxk7Qf90hIYtCISVNELRk5Z2y1opKsihAFEj00eaToiEcIkXUSAmJ4RZGEKJxNCd4HTCoOrVi0+x3teuL4/sHeTuz7DWcVPNqGx1nxvO64sd5p54XjfKCsG0ohW8X2tQ/xyVgLR2pJOLaMVnXkwTlEZ2D51SgZkpUulJvQjZaxkePMsix/GGMwdTHH1S2jNQuZ2eAAm2bAwfHC/Ib5PA9Gr8+8l+oaY8MULFbpd0rIoowZKoXoeJZRL/+9dR12tTAS7/1roS7YjxzdSzT6CAmJAjxykCHUBWLPWe+xk2g78Sd22/0MntY/gr8a2buaPBT/wwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='9' title='' src='/static/1805e041feeb92ebaea1a0c8c6377069/ca1dc/9.png' srcset='/static/1805e041feeb92ebaea1a0c8c6377069/e7570/9.png 170w,\n/static/1805e041feeb92ebaea1a0c8c6377069/f46e7/9.png 340w,\n/static/1805e041feeb92ebaea1a0c8c6377069/ca1dc/9.png 680w,\n/static/1805e041feeb92ebaea1a0c8c6377069/02d09/9.png 1020w,\n/static/1805e041feeb92ebaea1a0c8c6377069/98b00/9.png 1202w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p><code class=\"language-text\">history.historyCategory.historyType.in(historyTypes)</code> 와 같은 형태로 객체의 연관관계를 탐색하여 <code class=\"language-text\">in</code>절을 실행시키는 모습을 볼 수 있다. 따라서 해당 연관관계 정보가 필요함을 querydsl이 파악하고 join 쿼리를 실행시켜주는 것이다.</p>\n<p><strong>Where을 생략한 경우</strong>\n<span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/46fbcfb8b96b9db480697e71fb688d4d/70841/10.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 61.1764705882353%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAAA10lEQVR42p2SRw7EMAwD/Zw0pPf+/09xMQIU7NU+MA6caExTCuu66r5vXdelqqpUFIXKskxWADAMg/Z9t7Wua4OmggOPLMvUtq3O8zRN02RwvsWCgxcBAMbVn+fR+75qmsZ+IopkIDCuj47j0LIsGscxHQiEHImBfdxFO8zzXH3f23XpuLvyHKMzxIF32qE49QyTxmaeZ+s0TlEK7HNIMQOOO2Bcl4OIInpsKOi6Ttu2mYAxh77yDbA3zw/4f/eD0dcUCskNl8iHHOfInXMITWNF7BMXgvEDwYxyfkQaXVIAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='10' title='' src='/static/46fbcfb8b96b9db480697e71fb688d4d/ca1dc/10.png' srcset='/static/46fbcfb8b96b9db480697e71fb688d4d/e7570/10.png 170w,\n/static/46fbcfb8b96b9db480697e71fb688d4d/f46e7/10.png 340w,\n/static/46fbcfb8b96b9db480697e71fb688d4d/ca1dc/10.png 680w,\n/static/46fbcfb8b96b9db480697e71fb688d4d/02d09/10.png 1020w,\n/static/46fbcfb8b96b9db480697e71fb688d4d/70841/10.png 1094w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>만약 where을 생략했을 때는 연관 관계 정보가 필요하지 않음을 파악하므로 join 쿼리가 날아가지 않는 모습을 볼 수 있다.</p>","frontmatter":{"title":"피움 서비스의 Querydsl 적용 과정","date":"August 16, 2023","update":"August 16, 2023","tags":["Querydsl"],"series":null},"fields":{"slug":"/querydsl_apply_procedure/","readingTime":{"minutes":10.975}}},"seriesList":{"edges":[{"node":{"id":"28f1d87e-d3fc-5567-8531-57649652864f","fields":{"slug":"/sprint-idea/"},"frontmatter":{"title":"구글 스프린트 기반 아이디어 도출"}}},{"node":{"id":"4a9246fb-171b-5973-88fc-864034e78afd","fields":{"slug":"/blog-starter/"},"frontmatter":{"title":"피움 블로그 생성과정"}}},{"node":{"id":"c826ce0e-1ea7-517c-8d19-84e90a59a798","fields":{"slug":"/jenkins-setting/"},"frontmatter":{"title":"젠킨스 설치하기"}}},{"node":{"id":"a387bf4f-567f-50e7-b6a7-99a1a1c8971b","fields":{"slug":"/jpa-notnull-nullable/"},"frontmatter":{"title":"@NotNull과 nullable = false는 어떤 차이가 있을까?"}}},{"node":{"id":"a78e224b-b711-5071-8e90-013d6f4bebc3","fields":{"slug":"/pium-deploy-step/"},"frontmatter":{"title":"피움의 배포과정"}}},{"node":{"id":"ce07fbab-1ed5-5f1e-8e2f-eb430879b56a","fields":{"slug":"/fe-tanstack-query/"},"frontmatter":{"title":"프론트엔드: Tanstack Query 사용에 대하여"}}},{"node":{"id":"159c943b-1a50-57dd-aa71-7557364752a5","fields":{"slug":"/ci-cd-setting/"},"frontmatter":{"title":"Jenkins와 Github Webhook을 이용해 CI/CD 구축하기"}}},{"node":{"id":"dea45a4a-bfde-5fbb-8a97-42d3a3e77a0b","fields":{"slug":"/jenkins-hook-by-label/"},"frontmatter":{"title":"PR 라벨로 젠킨스 빌드유발을 구분하기"}}},{"node":{"id":"1a03734e-d413-553f-9152-1dad2fc4acca","fields":{"slug":"/apply-https/"},"frontmatter":{"title":"내 서버에 HTTPS 설정하기"}}},{"node":{"id":"cecbc8b9-db00-562b-aa0b-06c406cfc44a","fields":{"slug":"/bundle-analyze/"},"frontmatter":{"title":"bundle-analyze를 통한 bundle 크기 분석"}}},{"node":{"id":"707f8ffb-1409-5c27-b15a-5661b235c226","fields":{"slug":"/db-drop-stop/"},"frontmatter":{"title":"Table Drop 못하게 막아버리기"}}},{"node":{"id":"fe4b591a-4dd5-5dd2-b18a-b318afd1e9e3","fields":{"slug":"/transactional-not-in-restassured/"},"frontmatter":{"title":"[트러블슈팅] @SpringbootTest의 RANDOM_PORT 환경에서 @Transactional 어노테이션을 사용했을 때, RestAssured GET 요청이 수행되지 않는 경우(트랜잭션 격리 이해하기)"}}},{"node":{"id":"80aa708e-ef8a-5c79-9644-cb8c04d55a63","fields":{"slug":"/acceptance-test-resolve/"},"frontmatter":{"title":"인수테스트 데이터 초기화하기"}}},{"node":{"id":"15def1d5-c20f-5d07-b46e-24a14661365f","fields":{"slug":"/react-setting-without-cra/"},"frontmatter":{"title":"webpack으로만 React 설정하기 (without CRA)"}}},{"node":{"id":"66383c86-e2c8-533a-90e0-2effae572742","fields":{"slug":"/stylelint-and-husky/"},"frontmatter":{"title":"stylelint와 husky를 통해 컨벤션 통일하기"}}},{"node":{"id":"ed5951d5-beda-5a8f-adb2-07c2fcb38d5e","fields":{"slug":"/OAuth2.0/"},"frontmatter":{"title":"내가 이해한 OAuth2.0"}}},{"node":{"id":"45eeb9a3-557d-5704-8fd9-925283e1e27b","fields":{"slug":"/restdocs-start/"},"frontmatter":{"title":"RestDocs로 API 문서화하기"}}},{"node":{"id":"663b560a-734d-51a9-a6dc-3c4f50716c74","fields":{"slug":"/spring-event-apply/"},"frontmatter":{"title":"Spring Event 적용하기"}}},{"node":{"id":"55ae8038-3f65-5a59-8db3-c7405e7fc125","fields":{"slug":"/github-actions-cypress/"},"frontmatter":{"title":"피움 Cypress 자동화 구축기"}}},{"node":{"id":"503e9e71-eda3-53d7-8142-7c309faf213e","fields":{"slug":"/why_we_applied_querydsl/"},"frontmatter":{"title":"피움 서비스의 Querydsl 도입 이유"}}},{"node":{"id":"709124d0-5b05-5530-804d-e90ec9856a13","fields":{"slug":"/querydsl_apply_procedure/"},"frontmatter":{"title":"피움 서비스의 Querydsl 적용 과정"}}},{"node":{"id":"5c865dcb-cefd-58be-8968-b5edf6c8080c","fields":{"slug":"/server-logging/"},"frontmatter":{"title":"Logback을 이용해 운영 환경 별 로그 남기기"}}},{"node":{"id":"8269f166-d041-533c-9d44-332d8d8c3dca","fields":{"slug":"/server-monitoring/"},"frontmatter":{"title":"CloudWatch를 이용한 모니터링 환경 구성"}}},{"node":{"id":"0faec7ad-3bd1-5f5e-9222-115f771df8ed","fields":{"slug":"/tanstack-query-cache-trouble-shooting/"},"frontmatter":{"title":"InfinityQuery에서 fetch가 제대로 이루어지지 않는다?!?!"}}},{"node":{"id":"c77f7199-7fc6-53a3-a1fb-0792e05655a7","fields":{"slug":"/OAuth2.0-backend/"},"frontmatter":{"title":"OAuth 2.0 로그인 구현하기 (카카오)"}}},{"node":{"id":"12e4480d-386b-5d0e-bd69-4209fed36066","fields":{"slug":"/OAuth-test-backend/"},"frontmatter":{"title":"외부 API 를 의존하는 OAuth 로그인 테스트하기"}}},{"node":{"id":"ff40e109-cc92-5d83-a213-ca9d07136d95","fields":{"slug":"/aws-s3-apply/"},"frontmatter":{"title":"AWS S3로 정적 이미지 배포하기"}}},{"node":{"id":"e343af80-72dd-5173-bbb5-5069a17d1200","fields":{"slug":"/search_in_spring_data_jpa/"},"frontmatter":{"title":"Spring Data Jpa를 활용한 검색 기능 개발하기"}}},{"node":{"id":"af344dd8-ea77-5fde-9452-a97952ce60be","fields":{"slug":"/submodule-apply/"},"frontmatter":{"title":"Git submodule을 이용한 민감정보 관리"}}},{"node":{"id":"08c9daf0-2344-52a9-8c68-31ac04c24ff0","fields":{"slug":"/tomcat-thread-config/"},"frontmatter":{"title":"톰캣 스레드 설정하기"}}},{"node":{"id":"eafed74f-ff11-5af1-a589-e9dd2ccb5c8e","fields":{"slug":"/http-cache/"},"frontmatter":{"title":"CloudFront와 HTTP 캐시"}}},{"node":{"id":"dbe47289-01f4-571d-9506-fbb92016f547","fields":{"slug":"/optimize-frontend/"},"frontmatter":{"title":"피움 최적화하기"}}},{"node":{"id":"7b830fe6-e2df-564a-926e-7f7800380336","fields":{"slug":"/query-analysis/"},"frontmatter":{"title":"서비스 내에서 발생하는 쿼리를 분석하고 개선하기"}}},{"node":{"id":"37437d15-a63e-52ef-b031-6ee1bc6fa8bc","fields":{"slug":"/image-resize/"},"frontmatter":{"title":"서버에서 이미지 리사이징하기"}}},{"node":{"id":"216f4636-4125-5765-83d8-a6a610692a41","fields":{"slug":"/dont-stop-deploy/"},"frontmatter":{"title":"무중단 배포 환경 구성하기"}}},{"node":{"id":"dd095976-5a96-51b5-9686-8956dc60cd24","fields":{"slug":"/hikaricp-connection-pool-setting/"},"frontmatter":{"title":"HikariCp Connection Pool 값 설정"}}},{"node":{"id":"625ad76f-acb1-56cc-9baa-3d6f1a954ac2","fields":{"slug":"/pwa/"},"frontmatter":{"title":"PWA를 도입해보자"}}},{"node":{"id":"6a12651c-e6b8-5fa6-9c57-766772d32680","fields":{"slug":"/serviceworker/"},"frontmatter":{"title":"Service Worker에 대한 대략적인 이해"}}},{"node":{"id":"b9709447-61dc-52f0-95a5-8670a3fbaaf4","fields":{"slug":"/installPrompt/"},"frontmatter":{"title":"홈화면에 추가 안내 prompt 만들기"}}}]},"previous":{"fields":{"slug":"/why_we_applied_querydsl/"},"frontmatter":{"title":"피움 서비스의 Querydsl 도입 이유"}},"next":{"fields":{"slug":"/server-logging/"},"frontmatter":{"title":"Logback을 이용해 운영 환경 별 로그 남기기"}}},"pageContext":{"id":"709124d0-5b05-5530-804d-e90ec9856a13","series":null,"previousPostId":"503e9e71-eda3-53d7-8142-7c309faf213e","nextPostId":"5c865dcb-cefd-58be-8968-b5edf6c8080c"}},"staticQueryHashes":[],"slicesMap":{}}