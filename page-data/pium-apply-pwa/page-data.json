{"componentChunkName":"component---src-templates-post-jsx","path":"/pium-apply-pwa/","result":{"data":{"site":{"siteMetadata":{"title":"pium.log"}},"markdownRemark":{"id":"09501eea-fa70-5c42-9ee1-f25a5ab08bb5","excerpt":"이 글은 우테코 피움팀 크루 '클린'가 작성했습니다. 피움의 PWA 적용기 웹 어플리케이션인 피움은 ‘식집사들의 관리 주기를 찾기 어렵다’ 라는 문제를 해결하기 위해 기획을 시작했습니다. 그리고 사용자의 문제를 해결하기 위해 식물의 관리 주기를 기록하는 ‘히스토리’와 관리 일정이 되면 알림을 주는 ‘리마인더’를 통해 해결할 수 있다고 생각했습니다. 기획 …","html":"<blockquote>\n<p>이 글은 우테코 피움팀 크루 '<a href=\"https://github.com/hozzijeong\">클린</a>'가 작성했습니다.</p>\n</blockquote>\n<h1>피움의 PWA 적용기</h1>\n<p>웹 어플리케이션인 피움은 ‘식집사들의 관리 주기를 찾기 어렵다’ 라는 문제를 해결하기 위해 기획을 시작했습니다. 그리고 사용자의 문제를 해결하기 위해 식물의 관리 주기를 기록하는 ‘히스토리’와 관리 일정이 되면 알림을 주는 ‘리마인더’를 통해 해결할 수 있다고 생각했습니다. 기획 초기에는 웹 브라우저의 한계로 인해 알림이나 어플 설치가 불가능 하다고 생각했고 오히려 AOS나 IOS와 같이 모바일에 특화된 기획이라 명백한 한계가 보였습니다. 하지만 PWA와 서비스 워커에 대해 알고 그 한계를 극복할 수 있다는 생각을 했습니다.</p>\n<p>그렇다면 피움에서는 어떻게 PWA를 적용했는지에 대해 한번 알아보겠습니다. 목차는 크게 3개로 나뉘게 됩니다.</p>\n<ul>\n<li>manifest.json</li>\n<li>Service Worker</li>\n<li>FCM</li>\n<li>Trouble Shooting</li>\n</ul>\n<h2>manifest.json</h2>\n<p><a href=\"https://blog.pium.life/pwa/\">이전 포스팅</a>에서도 언급했지만 웹 어플리케이션을 PWA로 만들기 위해서는 <code class=\"language-text\">manifest.json</code>파일을 작성해야 합니다. 이 파일에는 어플로 만들어 졌을 때 들어갈 앱 이름, 아이콘 사이즈, 바로가기 등의 설정을 할 수 있습니다. </p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"피움\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"short_name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"pium\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"icons\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"src\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/assets/android-icon-48x48.png\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"sizes\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"48x48\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"image/png\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"density\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1.0\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"purpose\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"any\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"src\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/assets/android-icon-72x72.png\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"sizes\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"72x72\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"image/png\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"density\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"1.5\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"purpose\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"any\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"src\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/assets/android-icon-96x96.png\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"sizes\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"96x96\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"image/png\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"density\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2.0\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"purpose\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"any\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"src\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/assets/android-icon-144x144.png\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"sizes\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"144x144\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"image/png\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"density\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"3.0\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"purpose\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"any\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"src\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/assets/android-icon-192x192.png\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"sizes\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"192x192\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"image/png\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"density\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"4.0\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"purpose\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"maskable\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"src\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/assets/android-icon-512x512.png\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"sizes\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"512x512\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"image/png\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"density\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"5.0\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"purpose\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"maskable\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"display\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"standalone\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"theme_color\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"#1bcc66\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"background_color\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"#ffffff\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"pium\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"description\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"피움은 여러분의 반려 식물 관리 경험을 기록할 수 있도록 도와주고 각자에게 알맞은 관리법을 빠르게 찾도록 도와주고 있어요.\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"start_url\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"dir\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"auto\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"lang\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ko\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"orientation\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"portrait\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"scope\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"/\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"categories\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"lifestyle\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"plant\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"indoor-garden\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"display_override\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"window-controls-overlay\"</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>안드로이드 아이콘에 사용될 파일들을 같은 폴더에 위치시키고 사이즈 별로 이미지 파일을 생성했습니다. 아이콘 생성 사이트는 <a href=\"https://maskable.app/editor\">maskable</a>를 통해 만들었습니다. 하지만 여기서는 144x144사이즈를 export해주지 않기 때문에 144x144는 따로 만들었습니다… <code class=\"language-text\">manifest.json</code>의 파일 설정은 <a href=\"https://developer.mozilla.org/en-US/docs/Web/Manifest\">여기</a>를 통해서 자세히 알 수 있습니다. 단, <code class=\"language-text\">name</code>, <code class=\"language-text\">icons</code>, <code class=\"language-text\">start_url</code>, <code class=\"language-text\">display</code> and/or <code class=\"language-text\">display_override</code> 는 필수로 작성해야 하는 멤버들 입니다.</p>\n<p>이렇게 작성하고자 하는 내용들을 작성하고 난 다음에 <code class=\"language-text\">link</code>태그를 통해서 <code class=\"language-text\">index.html</code>에 포함시킬 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>link</span> <span class=\"token attr-name\">rel</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>manifest<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>/assets/manifest.json<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span></code></pre></div>\n<h2>Service Worker</h2>\n<p>오프라인 환경에서 최적화된 경험을 제공하기 위해 서비스 워커를 설치했습니다. 사실 피움에서는 오프라인 환경으로 어떤 것을 제공해야 되나 라고 생각했을 때 크게 제공할 만한 것이 떠오르지 않았습니다. 오프라인 상태에서 검색을 할 수 있는 것도 아니고 값을 등록할 수 있는 것도 아니기 때문입니다. 물 주기를 기록하는 행위 역시 좀 애매했습니다. </p>\n<p><del>ps. 문득 이렇게 적다보니 오프라인 상태에서 제공할만한 서비스가 떠오르긴 합니다. 식물 검색 기능과 식물 기록은 볼 수 있지 않을까 하는 생각이 들긴 하네요.</del></p>\n<p>오프라인 상태에서 어떤 경험을 제공할지 몰라도 <code class=\"language-text\">push</code> 메세지를 받는 역할은 서비스 워커에서 가능하기 때문에 서비스 워커를 설치하고 활성화 하는 것 까지는 작성해야 했습니다. 따라서 <code class=\"language-text\">install</code>과 <code class=\"language-text\">activate</code> 관련 이벤트를 등록했습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">self<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'install'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">event</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  event<span class=\"token punctuation\">.</span><span class=\"token function\">waitUntil</span><span class=\"token punctuation\">(</span>\n    caches<span class=\"token punctuation\">.</span><span class=\"token function\">open</span><span class=\"token punctuation\">(</span>assetCacheName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">cache</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 캐시로 저장할 파일을 지정. 어떤 파일을 넣을지는 차후 얘기해 보며 좋을 듯.</span>\n\t\t\t<span class=\"token comment\">// 캐시 버스팅이 발생하는 ㅍ</span>\n      cache<span class=\"token punctuation\">.</span><span class=\"token function\">addAll</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n        <span class=\"token string\">'/main.43e3611a6c9133f38206.bundle.js'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'/vendors-node_modules_react-dom_client_js-node_modules_react-router-dom_dist_index_js-node_mod-cccd04.261f3e9fe64cb376e09d.bundle.js'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'/assets/logo.webp'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'/index.html'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 제어중인 서비스 워커가 존재해도 대기 상태 건너 뜀</span>\n  self<span class=\"token punctuation\">.</span><span class=\"token function\">skipWaiting</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 기존에 있던 cache 삭제</span>\nself<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'activate'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">event</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  event<span class=\"token punctuation\">.</span><span class=\"token function\">waitUntil</span><span class=\"token punctuation\">(</span>\n    caches<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">cacheNames</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span>\n        cacheNames<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">cacheName</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cacheName <span class=\"token operator\">!==</span> assetCacheName<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> caches<span class=\"token punctuation\">.</span><span class=\"token function\">delete</span><span class=\"token punctuation\">(</span>cacheName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// 활성화 즉시 클라이언트를 제어한다.(새로고침 불필요)</span>\n  self<span class=\"token punctuation\">.</span>clients<span class=\"token punctuation\">.</span><span class=\"token function\">claim</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// 오프라인 상태라면, 캐시에 저장되어 있는 파일들 fetch로 받아옴</span>\nself<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fetch'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">event</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>navigator<span class=\"token punctuation\">.</span>onLine<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    event<span class=\"token punctuation\">.</span><span class=\"token function\">respondWith</span><span class=\"token punctuation\">(</span>caches<span class=\"token punctuation\">.</span><span class=\"token function\">match</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">result</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> result <span class=\"token operator\">&amp;&amp;</span> result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2>FCM</h2>\n<p>기본적으로 <code class=\"language-text\">web-push</code>를 구현하는데 있어서는 <code class=\"language-text\">Notifications API</code>와 <code class=\"language-text\">Push API</code>를 사용하지만 <code class=\"language-text\">FCM</code>을 사용한다면 손쉽게(?) 구현할 수 있습니다. 정통적인 방법은 <code class=\"language-text\">permission</code>을 받은 뒤 <code class=\"language-text\">subscribe</code>를 통해 <code class=\"language-text\">pushSubscription</code>객체를 서버에 넘기는 방식으로 구현이 되어 있습니다. 하지만 <code class=\"language-text\">FCM</code>에서는 <code class=\"language-text\">token</code>을 주고 받는 형태로 변경되었습니다. 이제부터 그 과정을 한번 보겠습니다.</p>\n<p>먼저 <code class=\"language-text\">firebase</code> 패키지를 먼저 설치해 줍니다. </p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">npm</span> i firebase</code></pre></div>\n<p>그리고 <code class=\"language-text\">FCM</code> 콘솔로 이동해서 프로젝트를 설치하면서 얻은 <code class=\"language-text\">config</code> 정보가 필요합니다. 프로젝트를 처음 세팅할 때 <code class=\"language-text\">config</code>파일이 자동으로 생성됩니다. 상세 정보를 확인하기 위해서는 프로젝트 설정 > 일반 에서 확인할 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// Import the functions you need from the SDKs you need</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> initializeApp <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"firebase/app\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> getAnalytics <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">\"firebase/analytics\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// TODO: Add SDKs for Firebase products that you want to use</span>\n<span class=\"token comment\">// https://firebase.google.com/docs/web/setup#available-libraries</span>\n\n<span class=\"token comment\">// Your web app's Firebase configuration</span>\n<span class=\"token comment\">// For Firebase JS SDK v7.20.0 and later, measurementId is optional</span>\n<span class=\"token keyword\">const</span> firebaseConfig <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">apiKey</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">authDomain</span><span class=\"token operator\">:</span> <span class=\"token string\">\"pium-.firebaseapp.com\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">projectId</span><span class=\"token operator\">:</span> <span class=\"token string\">\"pium-\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">storageBucket</span><span class=\"token operator\">:</span> <span class=\"token string\">\"pium-.appspot.com\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">messagingSenderId</span><span class=\"token operator\">:</span> <span class=\"token string\">\"\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">appId</span><span class=\"token operator\">:</span> <span class=\"token string\">\"12\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">measurementId</span><span class=\"token operator\">:</span> <span class=\"token string\">\"G-\"</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Initialize Firebase</span>\n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token function\">initializeApp</span><span class=\"token punctuation\">(</span>firebaseConfig<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> analytics <span class=\"token operator\">=</span> <span class=\"token function\">getAnalytics</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>해당 코드를 <code class=\"language-text\">FCM</code>을 처음 사용할 때 작성해면 됩니다. 이제 초기화된 <code class=\"language-text\">app</code> 변수를 <code class=\"language-text\">firebase/messaging</code>에서 제공하는 메세지 관련 메서드들을 통해 푸시 알림을 구현할 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Messaging<span class=\"token punctuation\">,</span> deleteToken<span class=\"token punctuation\">,</span> getMessaging<span class=\"token punctuation\">,</span> getToken<span class=\"token punctuation\">,</span> onMessage <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'firebase/messaging'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> message <span class=\"token operator\">=</span> <span class=\"token function\">getMessaging</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>이제 모든 초기 세팅이 끝이 났습니다. 이제부터는 알림 설정과 그 단계까지 한번 보겠습니다.</p>\n<h3>토큰 받기 (Push Subscription 만들기)</h3>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>getToken<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'firebase/messaging'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>message<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./'</span>\n\n<span class=\"token comment\">// 알림 구독 메서드</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">subscribeAlert</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token comment\">// 사용자에게 권한 알림 요청 권한을 받는다.</span>\n    <span class=\"token keyword\">const</span> permission <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> Notification<span class=\"token punctuation\">.</span><span class=\"token function\">requestPermission</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token comment\">// 알림이 허락되지 않았다면 return;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>permission <span class=\"token operator\">!==</span> <span class=\"token string\">'granted'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t    <span class=\"token function\">addToast</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'info'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">message</span><span class=\"token operator\">:</span> <span class=\"token string\">'알림을 허용하지 차단했습니다'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">time</span><span class=\"token operator\">:</span> <span class=\"token number\">3000</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\t\n\t\t<span class=\"token comment\">// VAPID키를 통해 토큰을 얻는다</span>\n    <span class=\"token keyword\">const</span> token <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getToken</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">vapidKey</span><span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">VAPID_PUBLIC_KEY</span> <span class=\"token operator\">??</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>token <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token comment\">// 토큰이 있다면 서버에 해당 토큰을 전달한다.</span>\n      <span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token function\">addToast</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">message</span><span class=\"token operator\">:</span> <span class=\"token string\">'구독중에 에러가 발생했습니다'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">time</span><span class=\"token operator\">:</span> <span class=\"token number\">3000</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3>서버에 토큰 보내기</h3>\n<p>위 코드에서 생성한 (또는 기존에 존재하는) 토큰을 인자로 받아서 DB로 전달하는 코드를 한번 보겠습니다. (<code class=\"language-text\">Tanstack-Query</code>를 사용한 코드입니다) </p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> subscribe <span class=\"token operator\">=</span> <span class=\"token function\">useMutation</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token function-variable function\">mutationFn</span><span class=\"token operator\">:</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token literal-property property\">token</span><span class=\"token operator\">:</span> string</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> WebPushSubscribeAPI<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">throwOnInvalidStatus</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>사실 이게 끝입니다. 정말 간단하게 구현이 가능하고 원래는 <code class=\"language-text\">pushSubscription</code>이지만 <code class=\"language-text\">firebsae</code> 패키지를 사용한다면 token으로 대체될 수 있습니다.</p>\n<h3>메세지 수신하기</h3>\n<p>서비스 워커와 웹 워커는 서로 다른 환경이기 떄문에 <code class=\"language-text\">firebase</code> 초기화를 또다시 해줘야 합니다. 그리고 <code class=\"language-text\">firebase</code> 패키지를 사용하는 서비스 워커의 이름은 반드시 <code class=\"language-text\">firebase-messaging-sw.js</code>여야 합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// firebase-messaging-sw.js</span>\n<span class=\"token function\">importScripts</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">importScripts</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Initialize the Firebase app in the service worker by passing in</span>\n<span class=\"token comment\">// your app's Firebase config object.</span>\n<span class=\"token comment\">// https://firebase.google.com/docs/web/setup#config-object</span>\n\n<span class=\"token keyword\">const</span> firebaseConfig <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">apiKey</span><span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">authDomain</span><span class=\"token operator\">:</span> <span class=\"token string\">'pium-.firebaseapp.com'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">projectId</span><span class=\"token operator\">:</span> <span class=\"token string\">'pium-'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">storageBucket</span><span class=\"token operator\">:</span> <span class=\"token string\">'pium-.appspot.com'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">messagingSenderId</span><span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">appId</span><span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">measurementId</span><span class=\"token operator\">:</span> <span class=\"token string\">'G-8SL2D547VW'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\nfirebase<span class=\"token punctuation\">.</span><span class=\"token function\">initializeApp</span><span class=\"token punctuation\">(</span>firebaseConfig<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// Retrieve an instance of Firebase Messaging so that it can handle background</span>\n<span class=\"token comment\">// messages.</span>\n<span class=\"token keyword\">const</span> messaging <span class=\"token operator\">=</span> firebase<span class=\"token punctuation\">.</span><span class=\"token function\">messaging</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">importScripts</code>를 통해 <code class=\"language-text\">firebase-app</code>과 <code class=\"language-text\">fireabse-messaging</code> 코드를 받아옵니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// firebase-messaging-sw.js</span>\n\nmessaging<span class=\"token punctuation\">.</span><span class=\"token function\">onBackgroundMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">payload</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">notification</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> title<span class=\"token punctuation\">,</span> body <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> payload<span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// Customize notification here</span>\n  <span class=\"token keyword\">const</span> notificationTitle <span class=\"token operator\">=</span> title<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> notificationOptions <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">body</span><span class=\"token operator\">:</span> body<span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">icon</span><span class=\"token operator\">:</span> <span class=\"token string\">'./assets/favicon-32x32.png'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">badge</span><span class=\"token operator\">:</span> <span class=\"token string\">'./assets/favicon-16x16.png'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">data</span><span class=\"token operator\">:</span> <span class=\"token string\">'/reminder'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">tag</span><span class=\"token operator\">:</span> <span class=\"token string\">'reminder-alert'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">vibrate</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">200</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 짝수 인덱스는 진동 시간, 홀수 인덱스는 휴식 시간</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  self<span class=\"token punctuation\">.</span>registration<span class=\"token punctuation\">.</span><span class=\"token function\">showNotification</span><span class=\"token punctuation\">(</span>notificationTitle<span class=\"token punctuation\">,</span> notificationOptions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">onBackgroundMessage</code>메서드를 통해 <code class=\"language-text\">push</code>이벤트를 감지할 수 있습니다. 인자로 넘겨받는 <code class=\"language-text\">payload</code>에는 서버에서 보낸 정보가 들어있습니다. 이제 서버에서 보내온 정보와 사용자에게 알맞은 알림을 보내주기 위한 데이터들을 <code class=\"language-text\">options</code>에 설정하고 <code class=\"language-text\">showNotification</code>메서드를 통해 알림을 보여준다면 푸시 알림 구현이 끝나게 됩니다. <code class=\"language-text\">notificationOptions</code>에 대해서 자세히 보기는 <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/ServiceWorkerRegistration/showNotification#examples\">여기</a>에 자세히 있습니다.</p>\n<p><code class=\"language-text\">FCM</code>에서 사용자 토큰을 입력하고 테스트 알림을 날리면 다음과 같이 받을 수 있습니다.</p>\n<figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/4f358b127d45f2034c8cc15a227b0c6f/db999/notification_alert.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 51.764705882352935%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAACQUlEQVR42n2SS2sTYRSGQ2kEixSlrQqKbTLJzOSeTC6TuWVymaS5tbFW3FgotS29/QhX7gSLBVFE/5YbNyo23VhoVkJtHr9EQUX0wAuHc/ie8/Ly+VZX2nS6LVbv32Op16XVWqS33KHZXBRq0Om0WVpeprfS4+5Sm2a9Tt2r0m41ePzkKYeHz3j18gVv37zm6Og5vrxuki8YxJMZZFklLCsEgiGCUohIJIasRFCjMTGTkEISEdGHxE5WVHoPHrK2tsbW1jZ7e/ts7O/gkyQF0yqxu3vA5uY26+sb7Ozssflom3g8RSKpUal3qNSaOGWPcnURw6mQzhVRIknCaoKUViSSyGHYNr6ZmesCts+ozgZnnH45ZSj6D58/CScKC4GQANUEqDGGujWPjJ4mHJWFY3W813I6haKF65Twzc7eEHYPOD8/ZzAYMKJ95RvvPr5HlaPiQRjdLGNYVUzHI28ZyPHRXB7rznyItFYgr9tUK/Yv4KguLi7GGlW/3yccjgiXQaquNlbFzeKWUiLzIPHYbSJqAFWZp5BPYFlZPHHsL+DwJ/C4fyyAMcLSTer6BE3TT73op5qfpCzk5vw42Us4OaGsHyvjxzSSfwKHw+FvDn8AZQFsmRN03Su0StO0nGk67lU8YwpL84+BljaJKXr7f8Dj4xEwSih4i5oxR9sL021EaXoS9fICVm6ObOwyWmwKPT1NUbsmHKb/DTw5ORlnKIn/5zgGdsnGLZewXYNMPoqiSiLfAMHgPBktRdHQ0fUC3wF6RZs1f1M2zgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='알림 성공' title='' src='/static/4f358b127d45f2034c8cc15a227b0c6f/ca1dc/notification_alert.png' srcset='/static/4f358b127d45f2034c8cc15a227b0c6f/e7570/notification_alert.png 170w,\n/static/4f358b127d45f2034c8cc15a227b0c6f/f46e7/notification_alert.png 340w,\n/static/4f358b127d45f2034c8cc15a227b0c6f/ca1dc/notification_alert.png 680w,\n/static/4f358b127d45f2034c8cc15a227b0c6f/02d09/notification_alert.png 1020w,\n/static/4f358b127d45f2034c8cc15a227b0c6f/9d567/notification_alert.png 1360w,\n/static/4f358b127d45f2034c8cc15a227b0c6f/db999/notification_alert.png 2856w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>알림 성공</figcaption>\n  </figure>\n<h2>Trouble Shooting</h2>\n<h3>서비스 워커 등록이 하나밖에 안되는데요</h3>\n<p>푸시 알림을 받기 위해 서비스 워커를 등록했지만 서비스 워커 등록관련해서 문제가 터졌습니다.  바로 MSW의 서비스 워커가 먼저 등록되어 있어서 중복 등록이 되지 않는다는 것 이었습니다. MSW로 API를 모킹하고 사용자들의 행동을 확인해보려 했지만 두 개가 겹쳐서 완벽한 푸시 알림을 확인하지 못하는 문제를 직면했습니다.</p>\n<blockquote>\n<p><strong>범위당 서비스 워커 <em>하나</em>만 허용</strong>됩니다. 활성 및 실행 중인 경우 메모리에 있는 클라이언트 수 (예: PWA 창 또는 브라우저 탭)에 관계없이 일반적으로 하나의 인스턴스만 사용할 수 있습니다.</p>\n</blockquote>\n<p>따라서 구동 환경에 따라 다른 서비스 워커를 등록할까 생각을 했지만 그렇게 된다면 무의미한 PR이 너무 늘어날 것 같고 효율성 역시 떨어지기 때문에 정말 최후의 보루라고 생각을 했습니다. 옆에 있던 참새에게 물어보니 하나의 파일에 2개의 서비스 워커를 <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/WorkerGlobalScope/importScripts\">importScripts</a>로 등록해서 사용하는 방법을 얘기해 줬습니다. </p>\n<blockquote>\n<p><code class=\"language-text\">importScripts</code>는 웹 워커(WorkerGlobalScope)에서 사용되는 함수로, 웹 워커에서 다른 스크립트 코드를 가져오는 역할을 하고 있습니다. 이 함수를 통해 백그라운드 병렬 처리 및 백그라운드 계산을 하는데 사용됩니다.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// devLocalServiceWorker.js</span>\n<span class=\"token comment\">/* eslint-disable no-undef */</span>\n<span class=\"token function\">importScripts</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/firebase-messaging-sw.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">importScripts</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/mockServiceWorker.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>그리고 이 서비스 워커를 <code class=\"language-text\">local</code>환경에서만 등록하고 <code class=\"language-text\">local</code>환경이 아닌 경우에는 <code class=\"language-text\">firebase-messaging-sw</code>를 등록하도록 코드를 작성했습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// index.tsx</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NODE_ENV</span> <span class=\"token operator\">===</span> <span class=\"token string\">'development'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// eslint-disable-next-line @typescript-eslint/no-var-requires</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> worker <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./mocks/browser'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">registerServiceWork</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/devLocalServiceWorker.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  worker<span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">serviceWorker</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">url</span><span class=\"token operator\">:</span> <span class=\"token string\">'http://localhost:8282/devLocalServiceWorker.js'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">NODE_ENV</span> <span class=\"token operator\">===</span> <span class=\"token string\">'production'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">registerServiceWork</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/firebase-messaging-sw.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// registerServiceWorker.js</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">registerPwaServiceWorker</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token literal-property property\">workerPath</span><span class=\"token operator\">:</span> string</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n<span class=\"token comment\">//...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>MSW의 서비스 워커와 FCM의 서비스 워커에서 크게 충돌이 발생하는 이벤트가 없었기에 별 문제가 없다고 생각을 했고 실제로도 문제 없이 동작을 했기 때문에 일단은 넘어가긴 했습니다. </p>\n<p>(좀 더 좋은 방법이 있으시다면 알려주신다면 감사하겠습니다…ㅎ)</p>\n<h3>FCM의 가이드와 web.dev의 가이드가 다른데요?</h3>\n<p>위에서도 언급했지만 FCM을 통해 구현한 웹 푸시에는 <code class=\"language-text\">pushManager</code>나 <code class=\"language-text\">pushSubscription</code>이 존재하지 않습니다. <code class=\"language-text\">web.dev</code>를 통해 학습했을 때 분명히 푸시 서비스와 구독하는 과정이 필요한걸로 알고 있는데 그 과정에 대한 의문이 계속 머릿속에 남아있었습니다. 결론은 “<code class=\"language-text\">firebase</code> 패키지 내부에서 추상화가 잘 되어있기 때문에 필요가 없다” 라고 할 수 있습니다.</p>\n<p>firebase를 통해 알림을 구현할 때는 토큰을 받고 해당 토큰을 서버에 저장하는 방식으로 사용자 구분을 하고 있습니다. 그리고 웹 푸시 프로토콜에 필요한 VAPID키를 토큰 등록할 때 사용하는 것을 보고 거기서 부터 찾아보자 하고 방향을 잡았습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// https://github.dev/firebase/firebase-js-sdk</span>\n<span class=\"token comment\">// api.ts</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getToken</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\"><span class=\"token literal-property property\">appCheckInstance</span><span class=\"token operator\">:</span> AppCheck<span class=\"token punctuation\">,</span>\n  forceRefresh<span class=\"token operator\">?</span><span class=\"token operator\">:</span> boolean</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Promise<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">AppCheckTokenResult</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"> </span><span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getTokenInternal</span><span class=\"token punctuation\">(</span>\n    appCheckInstance <span class=\"token keyword\">as</span> AppCheckService<span class=\"token punctuation\">,</span>\n    forceRefresh\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">throw</span> result<span class=\"token punctuation\">.</span>error<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">token</span><span class=\"token operator\">:</span> result<span class=\"token punctuation\">.</span>token <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">getToken</code>이라는 메서드에서 <code class=\"language-text\">getTokenInternal</code>이라는 메서드를 호출해서, 해당 결과 값의 token을 반환하는 코드를 작성하고 있습니다. 그래서 <code class=\"language-text\">getTokenInternal</code> 메서드를 들어가 봤습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// https://github.dev/firebase/firebase-js-sdk</span>\n<span class=\"token comment\">// token-manager.ts</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getTokenInternal</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\"><span class=\"token literal-property property\">messaging</span><span class=\"token operator\">:</span> MessagingService</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Promise<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>string</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"> </span><span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> pushSubscription <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getPushSubscription</span><span class=\"token punctuation\">(</span> <span class=\"token comment\">// 여기서 pushSubscription을 얻음</span>\n    messaging<span class=\"token punctuation\">.</span>swRegistration<span class=\"token operator\">!</span><span class=\"token punctuation\">,</span>\n    messaging<span class=\"token punctuation\">.</span>vapidKey<span class=\"token operator\">!</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">//...</span>\n<span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n\nasync function getPushSubscription(\n  swRegistration: ServiceWorkerRegistration,\n  vapidKey: string\n): Promise</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">PushSubscription</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"> </span><span class=\"token punctuation\">{</span>\n\n  <span class=\"token keyword\">const</span> subscription <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> swRegistration<span class=\"token punctuation\">.</span>pushManager<span class=\"token punctuation\">.</span><span class=\"token function\">getSubscription</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>subscription<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> subscription<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n\t<span class=\"token comment\">// 이 단락에서 PushManager를 통해 subscribe를 하고 있습니다.</span>\n  <span class=\"token keyword\">return</span> swRegistration<span class=\"token punctuation\">.</span>pushManager<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">userVisibleOnly</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// Chrome &lt;= 75 doesn't support base64-encoded VAPID key. For backward compatibility, VAPID key</span>\n    <span class=\"token comment\">// submitted to pushManager#subscribe must be of type Uint8Array.</span>\n    <span class=\"token literal-property property\">applicationServerKey</span><span class=\"token operator\">:</span> <span class=\"token function\">base64ToArray</span><span class=\"token punctuation\">(</span>vapidKey<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>결론적으로 <code class=\"language-text\">getToken</code> > <code class=\"language-text\">getTokenInternal</code> > <code class=\"language-text\">getPushSubscription</code>을 통해 <code class=\"language-text\">pushSubscription</code>을 반환하는 것을 알 수 있었습니다. 즉 <code class=\"language-text\">getToken</code> = <code class=\"language-text\">pushSubscription</code> 인 것입니다.</p>\n<p>그 다음 구독을 해제하는 과정 역시 토큰을 삭제함으로써 구독 취소가 된다는 것을 알 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">deleteTokenInternal</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\"><span class=\"token literal-property property\">messaging</span><span class=\"token operator\">:</span> MessagingService</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Promise<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>boolean</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"> </span><span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> tokenDetails <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">dbGet</span><span class=\"token punctuation\">(</span>messaging<span class=\"token punctuation\">.</span>firebaseDependencies<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>tokenDetails<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">await</span> <span class=\"token function\">requestDeleteToken</span><span class=\"token punctuation\">(</span>\n      messaging<span class=\"token punctuation\">.</span>firebaseDependencies<span class=\"token punctuation\">,</span>\n      tokenDetails<span class=\"token punctuation\">.</span>token\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">await</span> <span class=\"token function\">dbRemove</span><span class=\"token punctuation\">(</span>messaging<span class=\"token punctuation\">.</span>firebaseDependencies<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// Unsubscribe from the push subscription.</span>\n  <span class=\"token keyword\">const</span> pushSubscription <span class=\"token operator\">=</span>\n    <span class=\"token keyword\">await</span> messaging<span class=\"token punctuation\">.</span>swRegistration<span class=\"token operator\">!</span><span class=\"token punctuation\">.</span>pushManager<span class=\"token punctuation\">.</span><span class=\"token function\">getSubscription</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pushSubscription<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> pushSubscription<span class=\"token punctuation\">.</span><span class=\"token function\">unsubscribe</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// If there's no SW, consider it a success.</span>\n  <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">pushSubscription</code>이 존재하는 경우, <code class=\"language-text\">unsubscribe</code>를 통해 구독 취소하는 것을 알 수 있습니다. 따라서 <code class=\"language-text\">firebase</code>패키지를 사용할 때 <code class=\"language-text\">pushManager</code>와 <code class=\"language-text\">pushSubscription</code>을 통한 푸시 서비스와의 통신은 <code class=\"language-text\">token</code>을 생성하고 삭제하는 과정에 추상화 되어 있습니다.</p>\n<p>서비스 워커에서 <code class=\"language-text\">messag.onBackgroundMessage</code> 를 통해 <code class=\"language-text\">push</code> 이벤트를 핸들링 하는 것 역시 <code class=\"language-text\">message</code> 객체 안에 이미 <code class=\"language-text\">push</code>이벤트를 추가해 놓고 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> <span class=\"token literal-property property\">SwMessagingFactory</span><span class=\"token operator\">:</span> InstanceFactory<span class=\"token operator\">&lt;</span><span class=\"token string\">'messaging'</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\"><span class=\"token literal-property property\">container</span><span class=\"token operator\">:</span> ComponentContainer</span>\n<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> messaging <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MessagingService</span><span class=\"token punctuation\">(</span>\n    container<span class=\"token punctuation\">.</span><span class=\"token function\">getProvider</span><span class=\"token punctuation\">(</span><span class=\"token string\">'app'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getImmediate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    container<span class=\"token punctuation\">.</span><span class=\"token function\">getProvider</span><span class=\"token punctuation\">(</span><span class=\"token string\">'installations-internal'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getImmediate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    container<span class=\"token punctuation\">.</span><span class=\"token function\">getProvider</span><span class=\"token punctuation\">(</span><span class=\"token string\">'analytics-internal'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  self<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'push'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">e</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    e<span class=\"token punctuation\">.</span><span class=\"token function\">waitUntil</span><span class=\"token punctuation\">(</span><span class=\"token function\">onPush</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">,</span> messaging <span class=\"token keyword\">as</span> MessagingService<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  self<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'pushsubscriptionchange'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">e</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    e<span class=\"token punctuation\">.</span><span class=\"token function\">waitUntil</span><span class=\"token punctuation\">(</span><span class=\"token function\">onSubChange</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">,</span> messaging <span class=\"token keyword\">as</span> MessagingService<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  self<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'notificationclick'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">e</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    e<span class=\"token punctuation\">.</span><span class=\"token function\">waitUntil</span><span class=\"token punctuation\">(</span><span class=\"token function\">onNotificationClick</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> messaging<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3>외부 API와 JS 코드의 분리</h3>\n<p>배포를 끝마치고 핸드폰(아이폰)으로 서비스에 접속해보니 아예 렌더링 되지 않는 문제가 있었습니다. 디버깅을 해보니 아래와 같이 에러를 던졌습니다.</p>\n<figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/2ec8f3891f64142b8e4fac087ac30714/4a7b0/notification_error.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 22.352941176470587%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA1UlEQVR42mXO3W6CQBAFYF5IjWBUKLAof4tddhfEtDc2sQu6vP8DHEcxTRovvpyZmzPjdNEa5zTEL88xiArDJ4epSvzwAt87BuEtIVYvNNcbD9rfoHkItmhJ89r1dg1HxCsq+8BwKGE7jZHYo4JtJQyVt1RQu3NIbzFxJ/Vy9s6dweniHH3GcckPMLJDryYX0ZAjvpKCLjP6JKEvkmcqShnl0KxAw0rouIAiMsrgZJnFqTLQpYXiFpKPqMk+vWGXjghZjyA0CCLzL/34Cp9dEbDb3/zIOxS1ky9T9KxFAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='알림 성공' title='' src='/static/2ec8f3891f64142b8e4fac087ac30714/ca1dc/notification_error.png' srcset='/static/2ec8f3891f64142b8e4fac087ac30714/e7570/notification_error.png 170w,\n/static/2ec8f3891f64142b8e4fac087ac30714/f46e7/notification_error.png 340w,\n/static/2ec8f3891f64142b8e4fac087ac30714/ca1dc/notification_error.png 680w,\n/static/2ec8f3891f64142b8e4fac087ac30714/02d09/notification_error.png 1020w,\n/static/2ec8f3891f64142b8e4fac087ac30714/9d567/notification_error.png 1360w,\n/static/2ec8f3891f64142b8e4fac087ac30714/4a7b0/notification_error.png 2096w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>알림 성공</figcaption>\n  </figure>\n<p>변수 <code class=\"language-text\">Notification</code>을 찾을 수 없고, 그에따라 <code class=\"language-text\">request premission</code>이 적용되지 않은 상태에서 <code class=\"language-text\">firebase message</code>에 접근하는 것 자체가 잘못된 접근이라는 이유였습니다. </p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// Example: wrapping permission request call inside a button click</span>\n<span class=\"token keyword\">const</span> myButton <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"button\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nmyButton<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"click\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> permission <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> Notification<span class=\"token punctuation\">.</span><span class=\"token function\">requestPermission</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>permission <span class=\"token operator\">===</span> <span class=\"token string\">\"granted\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Notification permission granted. Requesting for token.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> token <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> messaging<span class=\"token punctuation\">.</span><span class=\"token function\">getToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">vapidKey</span><span class=\"token operator\">:</span> <span class=\"token string\">\"&lt;YOUR_PUBLIC_VAPID_KEY_HERE>\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// do something with the FCM token</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Notification permission denied\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// Handle denied permission</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><a href=\"https://firebase.blog/posts/2023/08/fcm-for-safari/#initialize-fcm\">firebase 공식 블로그</a>에서도 <code class=\"language-text\">permission</code>이 허용된 상태에서 messaging 메서드 처리를 하라고 권장을 하고 있으니 <code class=\"language-text\">Notification</code> 을 지원하지 않는 상황에서 FCM을 사용할 수 없는 것은 당연했습니다.</p>\n<p>하지만, 분명히 블로그를 봤을 때 iSO에서 FCM을 지원한다고 했고 Mac Safari에서 확인했을 때도 알림이 잘 왔기 때문에 이해가 되지 않았습니다. (Can I Use 에서도 지원하는 범위를 확인했습니다)</p>\n<p>혹시 몰라서 다시 <a href=\"https://caniuse.com/?search=Notification\">Can I Use에 Notifications API를 검색</a>해 봤는데 다음과 같은 문장이 있었습니다.</p>\n<blockquote>\n<p><strong><em>Requires website to first be add to the Home Screen</em></strong></p>\n</blockquote>\n<p>Mac Safari에서는 완벽하게 지원을 하지만 iOS의 Safari에서는 홈 화면에 바로가기를 추가해야지만 Notifications API를 사용할 수 있었습니다.</p>\n<figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/e291d09b3db719ed2442517fc63d4d4a/1f3e9/notification_can_i_use.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 44.705882352941174%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB/ElEQVR42nWS208TQRSHV8KLQcODlO1ee9l7u9tuL2xLW0BZ01JELkbkUoIFjSEm+uD/n3yeFjXGxIcvc2bmnN+c+c0o3aZHrxXQa4dkMsZxCddRcUubeAvK6n9Z5DSiMjXPfMyXNWW7mzDMUna3m+z0Gwz7CYOsziiLGWzF9NuRFBh/Cv4VTEKbLPXxK8VHwenQ5mLsMOq6dJrBststSeg0PPJ+lU5sS6GKI8Xub+y/YmEp9itW0qjAVlwg8YpEjka4RF+S+CpBZZOgqpHW5GquIehES8wlgWPQrFVoRhXCqoHSD0I6fogfONSjKrF4ktZsGr4lB1j4rggFZXpZmyR2aSchr3oDenWHLLIYNhx2xaK9QYPRIELJWwWOM51cjM19g9fiV+5qjGUcSScLX3y5smepvHRt9hOV6ekzZnOH648OH2YG1/MKs/sqk6M1FGusYZ9oBG9MvAOd4MAgmBh4b226+ya3FZ22r1Fq6RyOy5xNN7i8f87n7yVuvrzgdLbCp282Dz9cru42RHBio49NjJZKcWqinlpoZyWKQw0vKbIn3UVBkVJmsDPRyA/WmT+YIrrO+e0ax1crzL+aXNw9Y3L2BCWum6R1m5Zr0ZQXbTaEROaBRepZ4qvMJV7sp/JFunLw+5sC1/c2l3ODo/OnjE9WmL5bJT9c5Sf3LxBwTCOBHAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='알림 성공' title='' src='/static/e291d09b3db719ed2442517fc63d4d4a/ca1dc/notification_can_i_use.png' srcset='/static/e291d09b3db719ed2442517fc63d4d4a/e7570/notification_can_i_use.png 170w,\n/static/e291d09b3db719ed2442517fc63d4d4a/f46e7/notification_can_i_use.png 340w,\n/static/e291d09b3db719ed2442517fc63d4d4a/ca1dc/notification_can_i_use.png 680w,\n/static/e291d09b3db719ed2442517fc63d4d4a/02d09/notification_can_i_use.png 1020w,\n/static/e291d09b3db719ed2442517fc63d4d4a/9d567/notification_can_i_use.png 1360w,\n/static/e291d09b3db719ed2442517fc63d4d4a/1f3e9/notification_can_i_use.png 2074w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>알림 성공</figcaption>\n  </figure>\n<p>그렇다면 문제는 무엇이었을까요? 바로 다음 코드에 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> initialPushStatus <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token literal-property property\">permission</span><span class=\"token operator\">:</span> Notification<span class=\"token punctuation\">.</span>permission\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>제일 처음에 서비스 워커를 등록할 때 pushStatus에 대한 값도 업데이트를 하면서 초기 값을 설정을 했습니다. 그 과정에서 아무런 방어 코드 없이 <code class=\"language-text\">Notifications API</code>를 사용했고 iOS입장에서는 지원하지 않는 API를 사용하려고 하니까 처음부터 에러를 던지게 된 것이었습니다. 위에서 언급했던 것처럼 처음부터 에러가 먹히니, FCM을 초기화 하는 파일에서 역시 에러가 발생하게 된 것이었습니다.</p>\n<p><strong><em>즉, 렌더링하는 React의 로직 안에 외부 API(Notifications API, FCM)가 함께 존재했던 것이고 외부 API의 에러 발생으로 인해 원래 React가 작동하지 않고 결과적으로 흰 화면만 보게 되는 최악의 상황이 나온 것이었습니다.</em></strong></p>\n<p>이를 해결하기 위해 서로 얼키고 설켜있는 React의 코드와 외부 API를 분리하는 작업을 진행했습니다. (사실 분리 라고 보기에는 좀 애매하지만…)</p>\n<p>바로 FCM을 다루는 메서드들을 하나의 클래스로 분리한 다음에 해당 클래스의 인스턴스를 전역으로 export 하는 방식을 선택했습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Analytics<span class=\"token punctuation\">,</span> getAnalytics <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'firebase/analytics'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> FirebaseApp<span class=\"token punctuation\">,</span> FirebaseOptions<span class=\"token punctuation\">,</span> initializeApp <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'firebase/app'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> Messaging<span class=\"token punctuation\">,</span> deleteToken<span class=\"token punctuation\">,</span> getMessaging<span class=\"token punctuation\">,</span> getToken<span class=\"token punctuation\">,</span> onMessage <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'firebase/messaging'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> firebaseConfig <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n<span class=\"token comment\">//... content</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">FCMMessaging</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">private</span> <span class=\"token literal-property property\">app</span><span class=\"token operator\">:</span> FirebaseApp <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">private</span> <span class=\"token literal-property property\">messaging</span><span class=\"token operator\">:</span> Messaging <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token literal-property property\">config</span><span class=\"token operator\">:</span> FirebaseOptions</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>app <span class=\"token operator\">=</span> <span class=\"token function\">initializeApp</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>analytics <span class=\"token operator\">=</span> <span class=\"token function\">getAnalytics</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">registerMessaging</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'메세지 등록을 위해서는 FCM 초기화가 필요합니다.'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>messaging <span class=\"token operator\">=</span> <span class=\"token function\">getMessaging</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>app<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">setOnMessaging</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>messaging<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">onMessage</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>messaging<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">payload</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> notification <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> payload<span class=\"token punctuation\">;</span>\n\n      <span class=\"token keyword\">const</span> notificationTitle <span class=\"token operator\">=</span> notification<span class=\"token operator\">?.</span>title <span class=\"token operator\">??</span> <span class=\"token string\">'피움 알림'</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> notificationOptions <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token literal-property property\">body</span><span class=\"token operator\">:</span> notification<span class=\"token operator\">?.</span>body <span class=\"token operator\">??</span> <span class=\"token string\">'내용이 없습니다'</span><span class=\"token punctuation\">,</span>\n        <span class=\"token literal-property property\">icon</span><span class=\"token operator\">:</span> notification<span class=\"token operator\">?.</span>icon <span class=\"token operator\">??</span> <span class=\"token string\">'./assets/favicon-32x32.png'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> foregroundNotification <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Notification</span><span class=\"token punctuation\">(</span>notificationTitle<span class=\"token punctuation\">,</span> notificationOptions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      foregroundNotification<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onclick</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">event</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        event<span class=\"token punctuation\">.</span><span class=\"token function\">preventDefault</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        foregroundNotification<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">async</span> <span class=\"token function\">getCurrentToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>messaging<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'등록된 메세지가 없어서 토큰을 반환할 수 없습니다'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> permission <span class=\"token operator\">=</span> Notification<span class=\"token punctuation\">.</span>permission<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>permission <span class=\"token operator\">!==</span> <span class=\"token string\">'granted'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getToken</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>messaging<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token literal-property property\">vapidKey</span><span class=\"token operator\">:</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">VAPID_PUBLIC_KEY</span> <span class=\"token operator\">??</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">async</span> <span class=\"token function\">deleteCurrentToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>messaging<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'등록된 메세지가 없어서 토큰을 삭제할 수 없습니다'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">await</span> <span class=\"token function\">deleteToken</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>messaging<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FCMMessaging</span><span class=\"token punctuation\">(</span>firebaseConfig<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>그리고 <code class=\"language-text\">Notification.permission</code>을 알림 구독을 하는 <code class=\"language-text\">toggle</code>의 <code class=\"language-text\">handler</code>에 추가함으로써 화면 렌더링이 끝난 다음에 에러가 발생하든, 아니면 지원하지 않는 브라우저라는 안내를 할 수 있도록 설정했습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>PushStatus<span class=\"token punctuation\">.</span><span class=\"token function\">getIsSupport</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">addToast</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'warning'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">message</span><span class=\"token operator\">:</span> <span class=\"token string\">'지원하지 않는 브라우저입니다'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">time</span><span class=\"token operator\">:</span> <span class=\"token number\">3000</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// subscribe를 하지 않으려면 해당 토큰을 제거해야 한다.</span>\n\n  <span class=\"token keyword\">const</span> permission <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> Notification<span class=\"token punctuation\">.</span><span class=\"token function\">requestPermission</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  PushStatus<span class=\"token punctuation\">.</span><span class=\"token function\">setPermission</span><span class=\"token punctuation\">(</span>permission<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 전역 pushStatus를 알 수 있는 객체</span></code></pre></div>\n<p>아쉬운 점은 React에서 <a href=\"https://react-ko.dev/reference/react/useSyncExternalStore\">useSyncExternalStore</a>를 사용하면 별도의 객체로 생성하지 않고 외부 API를 분리할 수 있다는 것을 알았습니다. 그래서 이번 포스팅 이후에 한번 적용해 볼 생각입니다. (조금만 더 일찍 알았더라면…)</p>\n<h3>너무 오래걸리는 Toggle</h3>\n<p><code class=\"language-text\">Notification.permission</code>을 전역으로 설정한 것은 <code class=\"language-text\">FCM</code>에서 <code class=\"language-text\">token</code>을 미리 받기 위함이었습니다. 하지만, 해당 방법이 구조상 불가능 하다는 것을 깨닫고 나서 <code class=\"language-text\">permission</code>이후에 <code class=\"language-text\">token</code>을 받는 방식으로 코드를 변경했는데, <code class=\"language-text\">token</code>을 새로 발급 받는데는 1~2초의 지연 시간이 있다는 것을 알게되었습니다.</p>\n<p><a href=\"https://github.com/pium-official/pium-official.github.io/assets/50974359/e5a00fb5-5055-49c8-9632-71f68ecc5e88\">https://github.com/pium-official/pium-official.github.io/assets/50974359/e5a00fb5-5055-49c8-9632-71f68ecc5e88</a></p>\n<p>사용자 경험에 매우 좋지 않을 것이라고 생각을 하고 Suspense를 통한 대체 UI를 보여줌으로써 사용자에게 이 사실을 알리는 것이 좋다고 생각했습니다. </p>\n<p>이 작업을 하기 위해서는 다음과 같은 단계가 필요했습니다.</p>\n<ul>\n<li>ReminderToggle 컴포넌트의 분리 (토글 그 자체만을 Suspense로 감싸야 하기 때문에)</li>\n<li>대체 UI 생성</li>\n<li>FCM으로 부터 token을 받을 때 promise를 throw</li>\n</ul>\n<p><strong>Toggle 컴포넌트 분리</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Suspense</span></span> <span class=\"token attr-name\">fallback</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Spinner</span></span><span class=\"token punctuation\">/></span></span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n  </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">PushToggle</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Suspense</span></span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p><strong>대체 UI 생성</strong></p>\n<p>사실 이것은 GPT에게 Spinner 작성해 달라고하면 정말 잘 짜주기 때문에… GPT에게 물어봤습니다.</p>\n<p><strong>FCM으로 부터 token을 받을 때 promise를 throw</strong></p>\n<p>핵심 기능입니다. 결국 컴포넌트를 분리하는 이유도, 대체 UI를 생성하는 이유도 전부 이 작업에서 시작됩니다.</p>\n<p>일단 <code class=\"language-text\">PushToggle</code> 내부에서 알림 구독,취소 관련 로직을 훅으로 분리했습니다. 그리고 그 훅에서 현재 <code class=\"language-text\">token</code>을 받고 있는지 아닌지를 확인하기 위해 <code class=\"language-text\">pending</code>이라는 상태 역시 추가로 받습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> currentSubscribe<span class=\"token punctuation\">,</span> subscribeAlert<span class=\"token punctuation\">,</span> unSubscribeAlert<span class=\"token punctuation\">,</span> pending <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">usePushAlert</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pending<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// eslint-disable-next-line @typescript-eslint/no-empty-function</span>\n  <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token builtin\">Promise</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>그리고 구독 과정에서 현재 토큰 여부에 따라 <code class=\"language-text\">pending</code>의 상태를 변경해줍니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>isTokenPending<span class=\"token punctuation\">,</span> setIsTokenPending<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">subscribeAlert</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n<span class=\"token comment\">//...</span>\n  <span class=\"token keyword\">const</span> permission <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> Notification<span class=\"token punctuation\">.</span><span class=\"token function\">requestPermission</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  PushStatus<span class=\"token punctuation\">.</span><span class=\"token function\">setPermission</span><span class=\"token punctuation\">(</span>permission<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>permission <span class=\"token operator\">!==</span> <span class=\"token string\">'granted'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">addToast</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'info'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">message</span><span class=\"token operator\">:</span> <span class=\"token string\">'알림이 허용되지 않았습니다'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">time</span><span class=\"token operator\">:</span> <span class=\"token number\">3000</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">const</span> token <span class=\"token operator\">=</span> PushStatus<span class=\"token punctuation\">.</span><span class=\"token function\">getCurrentToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>token <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">setIsTokenPending</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> result <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> FCMMessaging<span class=\"token punctuation\">.</span><span class=\"token function\">getCurrentToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>result <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">setIsTokenPending</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">addToast</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">type</span><span class=\"token operator\">:</span> <span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">message</span><span class=\"token operator\">:</span> <span class=\"token string\">'구독중에 에러가 발생했습니다'</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">time</span><span class=\"token operator\">:</span> <span class=\"token number\">3000</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><a href=\"https://github.com/pium-official/pium-official.github.io/assets/50974359/6a5e3cc6-7b31-4c7d-930b-e4af74e344b1\">https://github.com/pium-official/pium-official.github.io/assets/50974359/6a5e3cc6-7b31-4c7d-930b-e4af74e344b1</a></p>\n<p>토큰을 다 받고 난 다음에 좀 자연스럽게 변경이 되면 좋겠다는 생각이 있긴 합니다. </p>\n<p>이렇게 <code class=\"language-text\">Notifications API</code> 분리와 그에 따른 지연상태 문제와 해결을 할 수 있었습니다</p>\n<hr>\n<h3>참조</h3>\n<p><a href=\"https://firebase.blog/posts/2023/08/fcm-for-safari/#initialize-fcm\">https://firebase.blog/posts/2023/08/fcm-for-safari/#initialize-fcm</a></p>","frontmatter":{"title":"피움의 PWA 적용기","date":"November 03, 2023","update":"November 08, 2023","tags":["PWA","Trouble Shotting","Notifications API","Push API","FCM"],"series":null},"fields":{"slug":"/pium-apply-pwa/","readingTime":{"minutes":27.96}}},"seriesList":{"edges":[{"node":{"id":"28f1d87e-d3fc-5567-8531-57649652864f","fields":{"slug":"/sprint-idea/"},"frontmatter":{"title":"구글 스프린트 기반 아이디어 도출"}}},{"node":{"id":"4a9246fb-171b-5973-88fc-864034e78afd","fields":{"slug":"/blog-starter/"},"frontmatter":{"title":"피움 블로그 생성과정"}}},{"node":{"id":"c826ce0e-1ea7-517c-8d19-84e90a59a798","fields":{"slug":"/jenkins-setting/"},"frontmatter":{"title":"젠킨스 설치하기"}}},{"node":{"id":"a387bf4f-567f-50e7-b6a7-99a1a1c8971b","fields":{"slug":"/jpa-notnull-nullable/"},"frontmatter":{"title":"@NotNull과 nullable = false는 어떤 차이가 있을까?"}}},{"node":{"id":"a78e224b-b711-5071-8e90-013d6f4bebc3","fields":{"slug":"/pium-deploy-step/"},"frontmatter":{"title":"피움의 배포과정"}}},{"node":{"id":"ce07fbab-1ed5-5f1e-8e2f-eb430879b56a","fields":{"slug":"/fe-tanstack-query/"},"frontmatter":{"title":"프론트엔드: Tanstack Query 사용에 대하여"}}},{"node":{"id":"159c943b-1a50-57dd-aa71-7557364752a5","fields":{"slug":"/ci-cd-setting/"},"frontmatter":{"title":"Jenkins와 Github Webhook을 이용해 CI/CD 구축하기"}}},{"node":{"id":"dea45a4a-bfde-5fbb-8a97-42d3a3e77a0b","fields":{"slug":"/jenkins-hook-by-label/"},"frontmatter":{"title":"PR 라벨로 젠킨스 빌드유발을 구분하기"}}},{"node":{"id":"1a03734e-d413-553f-9152-1dad2fc4acca","fields":{"slug":"/apply-https/"},"frontmatter":{"title":"내 서버에 HTTPS 설정하기"}}},{"node":{"id":"cecbc8b9-db00-562b-aa0b-06c406cfc44a","fields":{"slug":"/bundle-analyze/"},"frontmatter":{"title":"bundle-analyze를 통한 bundle 크기 분석"}}},{"node":{"id":"707f8ffb-1409-5c27-b15a-5661b235c226","fields":{"slug":"/db-drop-stop/"},"frontmatter":{"title":"Table Drop 못하게 막아버리기"}}},{"node":{"id":"fe4b591a-4dd5-5dd2-b18a-b318afd1e9e3","fields":{"slug":"/transactional-not-in-restassured/"},"frontmatter":{"title":"[트러블슈팅] @SpringbootTest의 RANDOM_PORT 환경에서 @Transactional 어노테이션을 사용했을 때, RestAssured GET 요청이 수행되지 않는 경우(트랜잭션 격리 이해하기)"}}},{"node":{"id":"80aa708e-ef8a-5c79-9644-cb8c04d55a63","fields":{"slug":"/acceptance-test-resolve/"},"frontmatter":{"title":"인수테스트 데이터 초기화하기"}}},{"node":{"id":"15def1d5-c20f-5d07-b46e-24a14661365f","fields":{"slug":"/react-setting-without-cra/"},"frontmatter":{"title":"webpack으로만 React 설정하기 (without CRA)"}}},{"node":{"id":"66383c86-e2c8-533a-90e0-2effae572742","fields":{"slug":"/stylelint-and-husky/"},"frontmatter":{"title":"stylelint와 husky를 통해 컨벤션 통일하기"}}},{"node":{"id":"ed5951d5-beda-5a8f-adb2-07c2fcb38d5e","fields":{"slug":"/OAuth2.0/"},"frontmatter":{"title":"내가 이해한 OAuth2.0"}}},{"node":{"id":"45eeb9a3-557d-5704-8fd9-925283e1e27b","fields":{"slug":"/restdocs-start/"},"frontmatter":{"title":"RestDocs로 API 문서화하기"}}},{"node":{"id":"663b560a-734d-51a9-a6dc-3c4f50716c74","fields":{"slug":"/spring-event-apply/"},"frontmatter":{"title":"Spring Event 적용하기"}}},{"node":{"id":"503e9e71-eda3-53d7-8142-7c309faf213e","fields":{"slug":"/why_we_applied_querydsl/"},"frontmatter":{"title":"피움 서비스의 Querydsl 도입 이유"}}},{"node":{"id":"55ae8038-3f65-5a59-8db3-c7405e7fc125","fields":{"slug":"/github-actions-cypress/"},"frontmatter":{"title":"피움 Cypress 자동화 구축기"}}},{"node":{"id":"709124d0-5b05-5530-804d-e90ec9856a13","fields":{"slug":"/querydsl_apply_procedure/"},"frontmatter":{"title":"피움 서비스의 Querydsl 적용 과정"}}},{"node":{"id":"5c865dcb-cefd-58be-8968-b5edf6c8080c","fields":{"slug":"/server-logging/"},"frontmatter":{"title":"Logback을 이용해 운영 환경 별 로그 남기기"}}},{"node":{"id":"8269f166-d041-533c-9d44-332d8d8c3dca","fields":{"slug":"/server-monitoring/"},"frontmatter":{"title":"CloudWatch를 이용한 모니터링 환경 구성"}}},{"node":{"id":"0faec7ad-3bd1-5f5e-9222-115f771df8ed","fields":{"slug":"/tanstack-query-cache-trouble-shooting/"},"frontmatter":{"title":"InfinityQuery에서 fetch가 제대로 이루어지지 않는다?!?!"}}},{"node":{"id":"c77f7199-7fc6-53a3-a1fb-0792e05655a7","fields":{"slug":"/OAuth2.0-backend/"},"frontmatter":{"title":"OAuth 2.0 로그인 구현하기 (카카오)"}}},{"node":{"id":"12e4480d-386b-5d0e-bd69-4209fed36066","fields":{"slug":"/OAuth-test-backend/"},"frontmatter":{"title":"외부 API 를 의존하는 OAuth 로그인 테스트하기"}}},{"node":{"id":"ff40e109-cc92-5d83-a213-ca9d07136d95","fields":{"slug":"/aws-s3-apply/"},"frontmatter":{"title":"AWS S3로 정적 이미지 배포하기"}}},{"node":{"id":"e343af80-72dd-5173-bbb5-5069a17d1200","fields":{"slug":"/search_in_spring_data_jpa/"},"frontmatter":{"title":"Spring Data Jpa를 활용한 검색 기능 개발하기"}}},{"node":{"id":"af344dd8-ea77-5fde-9452-a97952ce60be","fields":{"slug":"/submodule-apply/"},"frontmatter":{"title":"Git submodule을 이용한 민감정보 관리"}}},{"node":{"id":"08c9daf0-2344-52a9-8c68-31ac04c24ff0","fields":{"slug":"/tomcat-thread-config/"},"frontmatter":{"title":"톰캣 스레드 설정하기"}}},{"node":{"id":"dbe47289-01f4-571d-9506-fbb92016f547","fields":{"slug":"/optimize-frontend/"},"frontmatter":{"title":"피움 최적화하기"}}},{"node":{"id":"7b830fe6-e2df-564a-926e-7f7800380336","fields":{"slug":"/query-analysis/"},"frontmatter":{"title":"서비스 내에서 발생하는 쿼리를 분석하고 개선하기"}}},{"node":{"id":"eafed74f-ff11-5af1-a589-e9dd2ccb5c8e","fields":{"slug":"/http-cache/"},"frontmatter":{"title":"CloudFront와 HTTP 캐시"}}},{"node":{"id":"37437d15-a63e-52ef-b031-6ee1bc6fa8bc","fields":{"slug":"/image-resize/"},"frontmatter":{"title":"서버에서 이미지 리사이징하기"}}},{"node":{"id":"216f4636-4125-5765-83d8-a6a610692a41","fields":{"slug":"/dont-stop-deploy/"},"frontmatter":{"title":"무중단 배포 환경 구성하기"}}},{"node":{"id":"dd095976-5a96-51b5-9686-8956dc60cd24","fields":{"slug":"/hikaricp-connection-pool-setting/"},"frontmatter":{"title":"HikariCp Connection Pool 값 설정"}}},{"node":{"id":"625ad76f-acb1-56cc-9baa-3d6f1a954ac2","fields":{"slug":"/pwa/"},"frontmatter":{"title":"PWA를 도입해보자"}}},{"node":{"id":"6a12651c-e6b8-5fa6-9c57-766772d32680","fields":{"slug":"/serviceworker/"},"frontmatter":{"title":"Service Worker에 대한 대략적인 이해"}}},{"node":{"id":"ac7012e4-5b85-5040-b65e-c068968d7979","fields":{"slug":"/web-push/"},"frontmatter":{"title":"브라우저에서 알림 구현하기"}}},{"node":{"id":"b9709447-61dc-52f0-95a5-8670a3fbaaf4","fields":{"slug":"/installPrompt/"},"frontmatter":{"title":"홈화면에 추가 안내 prompt 만들기"}}},{"node":{"id":"09501eea-fa70-5c42-9ee1-f25a5ab08bb5","fields":{"slug":"/pium-apply-pwa/"},"frontmatter":{"title":"피움의 PWA 적용기"}}},{"node":{"id":"0a47c3f5-616d-564f-b5d1-1ac2eb9bcc54","fields":{"slug":"/update-ssl/"},"frontmatter":{"title":"만료된 SSL 인증서 갱신하기"}}}]},"previous":{"fields":{"slug":"/installPrompt/"},"frontmatter":{"title":"홈화면에 추가 안내 prompt 만들기"}},"next":{"fields":{"slug":"/update-ssl/"},"frontmatter":{"title":"만료된 SSL 인증서 갱신하기"}}},"pageContext":{"id":"09501eea-fa70-5c42-9ee1-f25a5ab08bb5","series":null,"previousPostId":"b9709447-61dc-52f0-95a5-8670a3fbaaf4","nextPostId":"0a47c3f5-616d-564f-b5d1-1ac2eb9bcc54"}},"staticQueryHashes":[],"slicesMap":{}}