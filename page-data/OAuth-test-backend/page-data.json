{"componentChunkName":"component---src-templates-post-jsx","path":"/OAuth-test-backend/","result":{"data":{"site":{"siteMetadata":{"title":"pium.log"}},"markdownRemark":{"id":"12e4480d-386b-5d0e-bd69-4209fed36066","excerpt":"이 글은 우테코 피움팀 크루 '조이'가 작성했습니다.   시작하기 전에 피움 프로젝트에서는 OAuth 2.0을 이용해 로그인을 구현하였습니다. 즉, 로그인 과정이 외부 API에 의존적이라고 볼 수 있는 것이죠. 서비스를 제공할 때 문제가 되는 부분은 아니지만, 로그인에 대한 테스트 코드를 작성할 때는 문제가 될 수 있습니다. 그렇다면 어떻게 외부 API에…","html":"<blockquote>\n<p>이 글은 우테코 피움팀 크루 '<a href=\"https://github.com/yeonkkk\">조이</a>'가 작성했습니다.  </p>\n</blockquote>\n<h2>시작하기 전에</h2>\n<hr>\n<p>피움 프로젝트에서는 OAuth 2.0을 이용해 로그인을 구현하였습니다.<br>\n즉, 로그인 과정이 외부 API에 의존적이라고 볼 수 있는 것이죠.</p>\n<p>서비스를 제공할 때 문제가 되는 부분은 아니지만, 로그인에 대한 테스트 코드를 작성할 때는 문제가 될 수 있습니다.</p>\n<p>그렇다면 어떻게 외부 API에 의존하지 않고 테스트 코드를 작성할 수 있을까요?\n피움 프로젝트를 통해서 그 방법을 살펴보겠습니다.</p>\n<p>글을 읽기 전에 몇 가지 사항들을 체크해 봅시다.</p>\n<p><br><br></p>\n<h3>1.  테스트</h3>\n<blockquote>\n<p>이 글은 테스트 방법에 대해서 다루지만, 특정 테스트 종류들에 대해서 설명하지 않습니다.<br>\n특정 테스트에 대한 지식이 필요하시거나 궁금하시다면 아래 자료들을 참고해주시면 감사하겠습니다.</p>\n</blockquote>\n<ul>\n<li><a href=\"https://tecoble.techcourse.co.kr/post/2021-05-25-unit-test-vs-integration-test-vs-acceptance-test/\">단위 테스트 vs 통합 테스트 vs 인수 테스트</a></li>\n<li><a href=\"https://tecoble.techcourse.co.kr/post/2021-05-18-slice-test/\">Spring Boot 슬라이스 테스트</a></li>\n</ul>\n<p><br><br></p>\n<h3>2. 개발 환경</h3>\n<blockquote>\n<p>이 글은 아래와 같은 환경에서 진행한 내용을 다룹니다.</p>\n</blockquote>\n<ul>\n<li>spring boot 3.1.1</li>\n<li>java 17</li>\n</ul>\n<p><br><br><br><br></p>\n<h2>테스트할 코드 파악하기</h2>\n<hr>\n<blockquote>\n<p>이 글은 OAuth 2.0을 이용한 로그인 구현 방법이 아닌 테스트 방법에 대해서만 설명합니다.<br>\n그렇기 때문에 테스트 코드와 밀접한 관련이 있는 코드만 가볍게 확인하고 넘어가겠습니다.<br>\n만약 자세한 구현 과정에 대해 알고 싶다면 아래 자료를 참고해주세요!</p>\n</blockquote>\n<ul>\n<li><a href=\"https://blog.pium.life/OAuth2.0-backend/\">피움블로그 - OAuth 2.0 로그인 구현하기 (카카오)</a></li>\n<li><a href=\"https://github.com/woowacourse-teams/2023-pium\">피움 깃허브 레포지토리</a></li>\n</ul>\n<p><br><br><br><br></p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/393311a0d6c5e308c63341034af5fff8/36cec/img.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 50.588235294117645%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABEUlEQVR42o2T3U7DMAyF9+y8BA/AO3DNNdLuQGIt/aUSapOhpRtNtiQ+OMkmGKCtttxEbv3pOHEXB7Ko9YDOSFjv8NM8EYKDwwcnwjVbhMdtc4+bpzto2odaEBd68tjZHV5eV1gVGYq2wOSnecBl84yH7DEmkqJkk9OQo4BQAnIrob2eByTnOf6241KjUW1a3TxgUnZuQakhg349oJc9Np+Kj8TMB+If4MQtNu8tsjrHm+jmn+El6KnluOf1/AN/7I2O+yvAyWoMHyKGVGsYb2JtGh/CwSgoJTHyu70eOWcvA5UZkRc5yqpE1VVxjL6BHls1oK5LtG2NcSM4Zy4DHd/qyS27+33L/FMEVTHCDIPwBdIoEPZTfKVGAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='피움-로그인-테스트-이미지.png' title='' src='/static/393311a0d6c5e308c63341034af5fff8/ca1dc/img.png' srcset='/static/393311a0d6c5e308c63341034af5fff8/e7570/img.png 170w,\n/static/393311a0d6c5e308c63341034af5fff8/f46e7/img.png 340w,\n/static/393311a0d6c5e308c63341034af5fff8/ca1dc/img.png 680w,\n/static/393311a0d6c5e308c63341034af5fff8/02d09/img.png 1020w,\n/static/393311a0d6c5e308c63341034af5fff8/9d567/img.png 1360w,\n/static/393311a0d6c5e308c63341034af5fff8/36cec/img.png 1722w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>피움-로그인-테스트-이미지.png</figcaption>\n  </figure></p>\n<p>그림을 통해 코드의 흐름을 먼저 생각해보겠습니다.</p>\n<p>로그인 요청이 들어오면 <code class=\"language-text\">AuthController</code>가 요청을 확인한 후 <code class=\"language-text\">AuthService</code>를 호출합니다.</p>\n<p><code class=\"language-text\">AuthService</code>에서는 <code class=\"language-text\">OAuthProvider</code>를 호출하여 <code class=\"language-text\">Kakao server</code>로 필요한 정보를 요청합니다.</p>\n<p><code class=\"language-text\">OAuthProvider</code>는 <code class=\"language-text\">Kakao server</code>에 액세스 토큰 발급을 요청하고 사용자 정보를 요청합니다.</p>\n<p>흐름을 파악했다면 코드를 간단히 확인한 후 테스트 방법에 대해 알아봅시다!<br>\n<br><br></p>\n<h3>AuthController</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Validated</span>\n<span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AuthController</span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token comment\">// ...</span>\n    \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">AuthService</span> authService<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@PostMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/login\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Void</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">login</span><span class=\"token punctuation\">(</span>\n            <span class=\"token annotation punctuation\">@RequestParam</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">=</span> <span class=\"token string\">\"code\"</span><span class=\"token punctuation\">)</span> <span class=\"token annotation punctuation\">@NotBlank</span> <span class=\"token class-name\">String</span> code<span class=\"token punctuation\">,</span>\n            <span class=\"token class-name\">HttpServletRequest</span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">Member</span> loginMember <span class=\"token operator\">=</span> authService<span class=\"token punctuation\">.</span><span class=\"token function\">login</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t<span class=\"token comment\">// ...</span>\n    <span class=\"token punctuation\">}</span>\n\t<span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><br><br></p>\n<h3>AuthService</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Service</span>\n<span class=\"token annotation punctuation\">@Transactional</span><span class=\"token punctuation\">(</span>readOnly <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AuthService</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">MemberRepository</span> memberRepository<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">OAuthProvider</span> provider<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Transactional</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">Member</span> <span class=\"token function\">login</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> authorizationCode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">KaKaoAccessTokenResponse</span> accessTokenResponse <span class=\"token operator\">=</span> provider<span class=\"token punctuation\">.</span><span class=\"token function\">getAccessToken</span><span class=\"token punctuation\">(</span>authorizationCode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">String</span> accessToken <span class=\"token operator\">=</span> accessTokenResponse<span class=\"token punctuation\">.</span><span class=\"token function\">getAccessToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">KakaoMemberResponse</span> kakaoMemberResponse <span class=\"token operator\">=</span> provider<span class=\"token punctuation\">.</span><span class=\"token function\">getMemberInfo</span><span class=\"token punctuation\">(</span>accessToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Long</span> kakaoId <span class=\"token operator\">=</span> kakaoMemberResponse<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\n        <span class=\"token comment\">// ...</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><br><br></p>\n<h3>OAuthProvider</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token annotation punctuation\">@RequiredArgsConstructor</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OAuthProvider</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">AUTHORIZATION_HEADER</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"Authorization\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">GRANT_TYPE</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"authorization_code\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">TOKEN_TYPE</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"Bearer \"</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${auth.kakao.token-request-uri}\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> tokenRequestUri<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${auth.kakao.member-info-request-uri}\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> memberInfoRequestUri<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${auth.kakao.client-id}\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> clientId<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${auth.kakao.admin-id}\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> adminId<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${auth.kakao.redirect-uri}\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> redirectUri<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${auth.kakao.unlink-uri}\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> unLinkUri<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">RestTemplate</span> restTemplate<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">KakaoMemberResponse</span> <span class=\"token function\">getMemberInfo</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> accessToken<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">HttpHeaders</span> httpHeaders <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HttpHeaders</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            httpHeaders<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token constant\">AUTHORIZATION_HEADER</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">TOKEN_TYPE</span> <span class=\"token operator\">+</span> accessToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            httpHeaders<span class=\"token punctuation\">.</span><span class=\"token function\">setContentType</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MediaType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">APPLICATION_FORM_URLENCODED</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token class-name\">HttpEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Object</span><span class=\"token punctuation\">></span></span> request <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HttpEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>httpHeaders<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">return</span> restTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">postForEntity</span><span class=\"token punctuation\">(</span>memberInfoRequestUri<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">,</span> <span class=\"token class-name\">KakaoMemberResponse</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">getBody</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpClientErrorException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">KaKaoMemberInfoRequestException</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpServerErrorException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">KakaoServerException</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">KaKaoAccessTokenResponse</span> <span class=\"token function\">getAccessToken</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> authorizationCode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\">HttpHeaders</span> httpHeaders <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HttpHeaders</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            httpHeaders<span class=\"token punctuation\">.</span><span class=\"token function\">setContentType</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MediaType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">APPLICATION_FORM_URLENCODED</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token class-name\">MultiValueMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> body <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">LinkedMultiValueMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            body<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"grant_type\"</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">GRANT_TYPE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            body<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"client_id\"</span><span class=\"token punctuation\">,</span> clientId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            body<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"redirect_uri\"</span><span class=\"token punctuation\">,</span> redirectUri<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            body<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"code\"</span><span class=\"token punctuation\">,</span> authorizationCode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token class-name\">HttpEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">MultiValueMap</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> request <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HttpEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">,</span> httpHeaders<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">return</span> restTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">postForEntity</span><span class=\"token punctuation\">(</span>\n                    tokenRequestUri<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">,</span> <span class=\"token class-name\">KaKaoAccessTokenResponse</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getBody</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpClientErrorException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">KakaoTokenRequestException</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpServerErrorException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">KakaoServerException</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span><span class=\"token function\">getMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\t<span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><br><br><br><br></p>\n<h2>Mockito, MockMvc 이용하기</h2>\n<hr>\n<blockquote>\n<p>먼저 <code class=\"language-text\">Mockito</code>, <code class=\"language-text\">MockMvc</code> 등을 통한 mocking을 생각해볼 수 있습니다.</p>\n</blockquote>\n<p><code class=\"language-text\">AuthController</code>에 대한 슬라이스 테스트에 적용한 코드를 통해 그 방법을 알아보겠습니다.</p>\n<p><code class=\"language-text\">AuthService</code>를 <code class=\"language-text\">MockBean</code>으로 주입한 후 카카오 서버에 요청을 하는 로직이 담긴 service를 mocking 하고, 예상한 대로 작업이 수행되었는지 테스트합니다.</p>\n<p>service 레이어에서도 <code class=\"language-text\">OAuthProvider</code>를 동일한 방법으로 mocking 하여 테스트할 수 있습니다.</p>\n<h3>AuthControllerTest</h3>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@WebMvcTest</span><span class=\"token punctuation\">(</span>controllers <span class=\"token operator\">=</span> <span class=\"token class-name\">AuthController</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">AuthControllerTest</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">UITest</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">MockMvc</span> mockMvc<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@MockBean</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">AuthService</span> authService<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Nested</span>\n    <span class=\"token keyword\">class</span> 로그인_ <span class=\"token punctuation\">{</span>\n\n        <span class=\"token annotation punctuation\">@Test</span>\n        <span class=\"token keyword\">void</span> 정상_요청_시_200_반환<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">Exception</span> <span class=\"token punctuation\">{</span>\n\n           <span class=\"token function\">given</span><span class=\"token punctuation\">(</span>authService<span class=\"token punctuation\">.</span><span class=\"token function\">login</span><span class=\"token punctuation\">(</span><span class=\"token function\">anyString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">willReturn</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Member</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">kakaoId</span><span class=\"token punctuation\">(</span><span class=\"token number\">12345L</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n\n            mockMvc<span class=\"token punctuation\">.</span><span class=\"token function\">perform</span><span class=\"token punctuation\">(</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/login\"</span><span class=\"token punctuation\">)</span>\n                            <span class=\"token punctuation\">.</span><span class=\"token function\">queryParam</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"code\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"authorization code\"</span><span class=\"token punctuation\">)</span>\n                            <span class=\"token punctuation\">.</span><span class=\"token function\">contentType</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MediaType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">APPLICATION_JSON_VALUE</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">andExpect</span><span class=\"token punctuation\">(</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isOk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">andDo</span><span class=\"token punctuation\">(</span><span class=\"token function\">print</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n\t\t<span class=\"token comment\">// ...</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><br><br></p>\n<h3>한계점</h3>\n<p>이 방법은 특정 레이어에 대한 테스트를 수행하기에 적합하고 효율적일 수 있습니다.\n하지만 실제 운영 환경과 같은 조건에서 사용자 시나리오를 테스트해야하는 인수테스트를 진행하는 경우 적합하지 않을 수 있습니다.</p>\n<p><br><br><br><br></p>\n<h2>MockRestServiceServer 이용하기</h2>\n<hr>\n<blockquote>\n<p>두번째 방법으로는 Http 통신을 가능하게 하는 <code class=\"language-text\">RestTemplate</code>를 mocking 하는 방법입니다.<br>\n<code class=\"language-text\">RestTemplate</code>을 mocking하기 위해 <code class=\"language-text\">MockRestServiceServer</code>를 이용할 수 있습니다.<br>\n<a href=\"https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/test/web/client/MockRestServiceServer.html\">MockRestServiceServer</a>는 <code class=\"language-text\">RestTemplate</code>를 테스트 하기 위한 Spring에서 제공하는 테스트 라이브러리입니다.</p>\n</blockquote>\n<h3>OAuthProviderTest</h3>\n<p><code class=\"language-text\">OAuthProvider</code> 테스트를 통해 그 방법을 알아보겠습니다.<br>\n전체 코드를 확인 후 세부적인 내용을 확인해보겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@SpringBootTest</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">OAuthProviderTest</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${auth.kakao.token-request-uri}\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">TOKEN_REQUEST_URI</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Value</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"${auth.kakao.member-info-request-uri}\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">MEMBER_INFO_REQUEST_URI</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">OAuthProvider</span> supporter<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">RestTemplate</span> restTemplate<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">MockRestServiceServer</span> mockServer<span class=\"token punctuation\">;</span>\n\n    <span class=\"token annotation punctuation\">@BeforeEach</span>\n    <span class=\"token keyword\">void</span> <span class=\"token function\">setUp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        mockServer <span class=\"token operator\">=</span> <span class=\"token class-name\">MockRestServiceServer</span><span class=\"token punctuation\">.</span><span class=\"token function\">createServer</span><span class=\"token punctuation\">(</span>restTemplate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Test</span>\n    <span class=\"token keyword\">void</span> 사용자_정보_조회<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">String</span> accessToken <span class=\"token operator\">=</span> <span class=\"token string\">\"access token\"</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">Long</span> kakaoId <span class=\"token operator\">=</span> <span class=\"token number\">12345L</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">String</span> response <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{\\\"id\\\":\\\"%d\\\"}\"</span><span class=\"token punctuation\">,</span> kakaoId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        mockServer<span class=\"token punctuation\">.</span><span class=\"token function\">expect</span><span class=\"token punctuation\">(</span><span class=\"token function\">requestTo</span><span class=\"token punctuation\">(</span><span class=\"token constant\">MEMBER_INFO_REQUEST_URI</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">andExpect</span><span class=\"token punctuation\">(</span><span class=\"token function\">content</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">contentType</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"application/x-www-form-urlencoded\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">andExpect</span><span class=\"token punctuation\">(</span><span class=\"token function\">method</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpMethod</span><span class=\"token punctuation\">.</span><span class=\"token constant\">POST</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">andExpect</span><span class=\"token punctuation\">(</span><span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token constant\">AUTHORIZATION_HEADER</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">TOKEN_TYPE</span> <span class=\"token operator\">+</span> accessToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">andRespond</span><span class=\"token punctuation\">(</span><span class=\"token function\">withSuccess</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">,</span> <span class=\"token class-name\">MediaType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">APPLICATION_JSON</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">KaKaoMemberInfoResponse</span> memberInfoResponse <span class=\"token operator\">=</span> supporter<span class=\"token punctuation\">.</span><span class=\"token function\">getMemberInfo</span><span class=\"token punctuation\">(</span>accessToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>memberInfoResponse<span class=\"token punctuation\">.</span><span class=\"token function\">getId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span>kakaoId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Test</span>\n    <span class=\"token keyword\">void</span> 액세스_토큰_조회<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">String</span> authorizationCode <span class=\"token operator\">=</span> <span class=\"token string\">\"authorization code\"</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">String</span> accessToken <span class=\"token operator\">=</span> <span class=\"token string\">\"access token\"</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">String</span> response <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{\\\"access_token\\\":\\\"%s\\\"}\"</span><span class=\"token punctuation\">,</span> accessToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        mockServer<span class=\"token punctuation\">.</span><span class=\"token function\">expect</span><span class=\"token punctuation\">(</span><span class=\"token function\">requestTo</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TOKEN_REQUEST_URI</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">andExpect</span><span class=\"token punctuation\">(</span><span class=\"token function\">content</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">contentType</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"application/x-www-form-urlencoded;charset=utf-8\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">andExpect</span><span class=\"token punctuation\">(</span><span class=\"token function\">method</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpMethod</span><span class=\"token punctuation\">.</span><span class=\"token constant\">POST</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">andRespond</span><span class=\"token punctuation\">(</span><span class=\"token function\">withSuccess</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">,</span> <span class=\"token class-name\">MediaType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">APPLICATION_JSON</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">KaKaoAccessTokenResponse</span> tokenResponse <span class=\"token operator\">=</span> supporter<span class=\"token punctuation\">.</span><span class=\"token function\">getAccessToken</span><span class=\"token punctuation\">(</span>authorizationCode<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token function\">assertThat</span><span class=\"token punctuation\">(</span>tokenResponse<span class=\"token punctuation\">.</span><span class=\"token function\">getAccessToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">isEqualTo</span><span class=\"token punctuation\">(</span>accessToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><br><br></p>\n<ul>\n<li>\n<p>동일한 URL에 대한 응답 값이 다를 경우를 고려해 서버를 새로 생성해주도록 합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@SpringBootTest</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">OAuthProviderTest</span> <span class=\"token punctuation\">{</span>\n<span class=\"token comment\">// ... </span>\n<span class=\"token annotation punctuation\">@BeforeEach</span>\n<span class=\"token keyword\">void</span> <span class=\"token function\">setUp</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    mockServer <span class=\"token operator\">=</span> <span class=\"token class-name\">MockRestServiceServer</span><span class=\"token punctuation\">.</span><span class=\"token function\">createServer</span><span class=\"token punctuation\">(</span>restTemplate<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">// ... </span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n</ul>\n<p><br><br></p>\n<ul>\n<li>\n<p>요청 조건과 응답 값을 설정해줍니다.</p>\n<ul>\n<li><code class=\"language-text\">requestTo(String URI)</code> : 요청할 URI를 설정합니다.</li>\n<li><code class=\"language-text\">method(HttpMethod method)</code>: 요청할 메서드를 설정합니다. 기본 값은 <code class=\"language-text\">GET</code> 입니다.</li>\n<li><code class=\"language-text\">header()</code>: 요청 시 보내야하는 헤더를 설정합니다. key-value 순서로 작성합니다.</li>\n<li><code class=\"language-text\">andRespond()</code>: 돌아와야하는 응답 값을 설정합니다. 응답은 아래와 같이 String으로 작성합니다.</li>\n<li>이외에도 status code, contentType 등도 설정할 수 있습니다.</li>\n</ul>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@SpringBootTest</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">OAuthProviderTest</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ... </span>\n    <span class=\"token annotation punctuation\">@Test</span>\n    <span class=\"token keyword\">void</span> 사용자_정보_조회<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// ...</span>\n        \n        <span class=\"token class-name\">String</span> response <span class=\"token operator\">=</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"{\\\"id\\\":\\\"%d\\\"}\"</span><span class=\"token punctuation\">,</span> kakaoId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        mockServer<span class=\"token punctuation\">.</span><span class=\"token function\">expect</span><span class=\"token punctuation\">(</span><span class=\"token function\">requestTo</span><span class=\"token punctuation\">(</span><span class=\"token constant\">MEMBER_INFO_REQUEST_URI</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">andExpect</span><span class=\"token punctuation\">(</span><span class=\"token function\">content</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">contentType</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"application/x-www-form-urlencoded\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">andExpect</span><span class=\"token punctuation\">(</span><span class=\"token function\">method</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpMethod</span><span class=\"token punctuation\">.</span><span class=\"token constant\">POST</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">andExpect</span><span class=\"token punctuation\">(</span><span class=\"token function\">header</span><span class=\"token punctuation\">(</span><span class=\"token constant\">AUTHORIZATION_HEADER</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">TOKEN_TYPE</span> <span class=\"token operator\">+</span> accessToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">andRespond</span><span class=\"token punctuation\">(</span><span class=\"token function\">withSuccess</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">,</span> <span class=\"token class-name\">MediaType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">APPLICATION_JSON</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// ...</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// ... </span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><br><br></p>\n<p>이렇게 직접 <code class=\"language-text\">MockRestServiceServer</code>를 생성해주지 않고 <code class=\"language-text\">@RestClientTest</code>를 사용하는 방법도 있습니다.</p>\n<p>자세한 내용은 <a href=\"https://jojoldu.tistory.com/341\">기억보단 기록을(이동욱님) - Spring Boot에서 외부 API 테스트하기</a> 를 참고하시면 좋을 것 같습니다.</p>\n<p><br><br></p>\n<h3>한계점</h3>\n<p>이 방법은 mock server를 이용하기 때문에 앞선 방법과 다르게 인수테스트에서도 사용이 가능합니다.<br>\n하지만 테스트 시 <code class=\"language-text\">RestTemplate</code>과 <code class=\"language-text\">MockRestServiceServer</code>를 매번 생성해주어야 하고, 적용되는 테스트들에 다수의 중복 코드가 발생할 수 있습니다.<br>\n뿐만 아니라 응답 값을 문자열로 작성해주어야 하기 때문에 가독성이 떨어집니다.</p>\n<p><br><br><br><br></p>\n<h2>Kakao Server Mocking하기</h2>\n<hr>\n<blockquote>\n<p>마지막 방법으로 가짜 카카오 서버를 만들어서 mocking하는 방법입니다.<br>\n즉, 카카오 서버 대신 요청을 수행해줄 controller를 생성하는 것입니다.</p>\n</blockquote>\n<h3>AuthApiTest</h3>\n<p>아래와 같이 로그인 요청을 테스트하는 코드를 작성합니다.<br>\n이 때, <code class=\"language-text\">@SpringBootTest(webEnvironment = WebEnvironment.DEFINED_PORT)</code> 를 사용하여 원하는 포트에서 테스트가 진행되도록 설정해주어야 합니다.</p>\n<p>그 이유는 카카오 서버를 대신해 요청을 수행해줄 controller로 우리가 요청을 보낼 때 해당 포트를 기재해주어야 하기 때문입니다.</p>\n<p>(아래 <code class=\"language-text\">application.properties</code>의 <code class=\"language-text\">auth.kakao.token-request-uri</code>와 <code class=\"language-text\">auth.kakao.member-info-request-uri</code> 참고)</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@SpringBootTest</span><span class=\"token punctuation\">(</span>webEnvironment <span class=\"token operator\">=</span> <span class=\"token class-name\">WebEnvironment</span><span class=\"token punctuation\">.</span><span class=\"token constant\">DEFINED_PORT</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AuthApiTest</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token annotation punctuation\">@Test</span>\n    <span class=\"token keyword\">void</span> 로그인_정상_요청_시_200_반환<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">ExtractableResponse</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Response</span><span class=\"token punctuation\">></span></span> response <span class=\"token operator\">=</span> <span class=\"token class-name\">RestAssured</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">given</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">queryParam</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"code\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"authorizationCode\"</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">when</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/login\"</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">statusCode</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpStatus</span><span class=\"token punctuation\">.</span><span class=\"token constant\">OK</span><span class=\"token punctuation\">.</span><span class=\"token function\">value</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">extract</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token comment\">// ...</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><br><br></p>\n<h3>application.properties</h3>\n<p>main의 <code class=\"language-text\">application.properties</code> 와 동일하게 카카오 서버에 정보를 요청하기 위한 정보들(redirect uri, client id 등)을 test 시 사용되는 <code class=\"language-text\">application.properties</code>에 작성해줍니다.</p>\n<p>여기서 = <code class=\"language-text\">server.port</code>로 지정한 포트에서 <code class=\"language-text\">@SpringBootTest(webEnvironment = WebEnvironment.DEFINED_PORT)</code> 테스트가 진행됩니다.</p>\n<p>이 때, <code class=\"language-text\">server.port</code>로 지정한 포트와 요청 URI(<code class=\"language-text\">auth.kakao.token-request-uri</code>, <code class=\"language-text\">auth.kakao.member-info-request-uri</code>) 의 포트가 동일해야 요청이 정상적으로 수행됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"properties\"><pre class=\"language-properties\"><code class=\"language-properties\"><span class=\"token key attr-name\">server.port</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">8888</span>\n<span class=\"token key attr-name\">auth.kakao.token-request-uri</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">http://localhost:8888/oauth/token</span>\n<span class=\"token key attr-name\">auth.kakao.member-info-request-uri</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">http://localhost:8888/user/me</span>\n<span class=\"token key attr-name\">auth.kakao.redirect-uri</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">http://localhost:8888/authorization</span>\n<span class=\"token key attr-name\">auth.kakao.client-id</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">clientId</span></code></pre></div>\n<p><br><br></p>\n<h3>MockKakaoServerController</h3>\n<p>카카오 서버 대신 요청을 처리해 줄 컨트롤러를 작성하여, 요청 조건과 원하는 응답을 설정해줍니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MockKakaoServerController</span> <span class=\"token punctuation\">{</span>\n\n<span class=\"token comment\">// ...</span>\n\n    <span class=\"token annotation punctuation\">@PostMapping</span><span class=\"token punctuation\">(</span>path <span class=\"token operator\">=</span> <span class=\"token string\">\"/oauth/token\"</span><span class=\"token punctuation\">,</span> consumes <span class=\"token operator\">=</span> <span class=\"token class-name\">MediaType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">APPLICATION_FORM_URLENCODED_VALUE</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">KaKaoAccessTokenResponse</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getAccessToken</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    \n\t\t<span class=\"token comment\">// ...</span>\n        \n        <span class=\"token class-name\">KaKaoAccessTokenResponse</span> response <span class=\"token operator\">=</span> <span class=\"token class-name\">KaKaoAccessTokenResponse</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">accessToken</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"access token\"</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@PostMapping</span><span class=\"token punctuation\">(</span>path <span class=\"token operator\">=</span> <span class=\"token string\">\"/user/me\"</span><span class=\"token punctuation\">,</span> consumes <span class=\"token operator\">=</span> <span class=\"token class-name\">MediaType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">APPLICATION_FORM_URLENCODED_VALUE</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">KakaoMemberResponse</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">getMemberInfo</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@RequestHeader</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">HttpHeaders</span><span class=\"token punctuation\">.</span><span class=\"token constant\">AUTHORIZATION</span><span class=\"token punctuation\">)</span> <span class=\"token class-name\">String</span> token<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n \t\t\n        <span class=\"token comment\">// ...</span>\n\n        <span class=\"token class-name\">KakaoMemberResponse</span> response <span class=\"token operator\">=</span> <span class=\"token class-name\">KakaoMemberResponse</span><span class=\"token punctuation\">.</span><span class=\"token function\">builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">id</span><span class=\"token punctuation\">(</span><span class=\"token number\">54321L</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><br><br><br><br></p>\n<h2>참고 자료</h2>\n<hr>\n<p><a href=\"https://prolog.techcourse.co.kr/studylogs/2500\">PROLOG - OAuth를 사용하는 로직의 테스트를 외부 API에 의존하지 않게 해보자</a></p>\n<p><a href=\"https://velog.io/@jurlring/%EC%99%B8%EB%B6%80-API-Mocking%ED%95%98%EC%97%AC-%ED%85%8C%EC%8A%A4%ED%8A%B8%ED%95%98%EA%B8%B0#%EC%8B%9C%EB%8F%84-2---resttemplate-mocking\">외부 API Mocking하여 테스트하기</a>  </p>","frontmatter":{"title":"외부 API 를 의존하는 OAuth 로그인 테스트하기","date":"August 29, 2023","update":"August 29, 2023","tags":["OAuth2.0","로그인","테스트"],"series":null},"fields":{"slug":"/OAuth-test-backend/","readingTime":{"minutes":11.445}}},"seriesList":{"edges":[{"node":{"id":"28f1d87e-d3fc-5567-8531-57649652864f","fields":{"slug":"/sprint-idea/"},"frontmatter":{"title":"구글 스프린트 기반 아이디어 도출"}}},{"node":{"id":"4a9246fb-171b-5973-88fc-864034e78afd","fields":{"slug":"/blog-starter/"},"frontmatter":{"title":"피움 블로그 생성과정"}}},{"node":{"id":"c826ce0e-1ea7-517c-8d19-84e90a59a798","fields":{"slug":"/jenkins-setting/"},"frontmatter":{"title":"젠킨스 설치하기"}}},{"node":{"id":"a387bf4f-567f-50e7-b6a7-99a1a1c8971b","fields":{"slug":"/jpa-notnull-nullable/"},"frontmatter":{"title":"@NotNull과 nullable = false는 어떤 차이가 있을까?"}}},{"node":{"id":"a78e224b-b711-5071-8e90-013d6f4bebc3","fields":{"slug":"/pium-deploy-step/"},"frontmatter":{"title":"피움의 배포과정"}}},{"node":{"id":"ce07fbab-1ed5-5f1e-8e2f-eb430879b56a","fields":{"slug":"/fe-tanstack-query/"},"frontmatter":{"title":"프론트엔드: Tanstack Query 사용에 대하여"}}},{"node":{"id":"159c943b-1a50-57dd-aa71-7557364752a5","fields":{"slug":"/ci-cd-setting/"},"frontmatter":{"title":"Jenkins와 Github Webhook을 이용해 CI/CD 구축하기"}}},{"node":{"id":"dea45a4a-bfde-5fbb-8a97-42d3a3e77a0b","fields":{"slug":"/jenkins-hook-by-label/"},"frontmatter":{"title":"PR 라벨로 젠킨스 빌드유발을 구분하기"}}},{"node":{"id":"1a03734e-d413-553f-9152-1dad2fc4acca","fields":{"slug":"/apply-https/"},"frontmatter":{"title":"내 서버에 HTTPS 설정하기"}}},{"node":{"id":"cecbc8b9-db00-562b-aa0b-06c406cfc44a","fields":{"slug":"/bundle-analyze/"},"frontmatter":{"title":"bundle-analyze를 통한 bundle 크기 분석"}}},{"node":{"id":"707f8ffb-1409-5c27-b15a-5661b235c226","fields":{"slug":"/db-drop-stop/"},"frontmatter":{"title":"Table Drop 못하게 막아버리기"}}},{"node":{"id":"fe4b591a-4dd5-5dd2-b18a-b318afd1e9e3","fields":{"slug":"/transactional-not-in-restassured/"},"frontmatter":{"title":"[트러블슈팅] @SpringbootTest의 RANDOM_PORT 환경에서 @Transactional 어노테이션을 사용했을 때, RestAssured GET 요청이 수행되지 않는 경우(트랜잭션 격리 이해하기)"}}},{"node":{"id":"80aa708e-ef8a-5c79-9644-cb8c04d55a63","fields":{"slug":"/acceptance-test-resolve/"},"frontmatter":{"title":"인수테스트 데이터 초기화하기"}}},{"node":{"id":"15def1d5-c20f-5d07-b46e-24a14661365f","fields":{"slug":"/react-setting-without-cra/"},"frontmatter":{"title":"webpack으로만 React 설정하기 (without CRA)"}}},{"node":{"id":"66383c86-e2c8-533a-90e0-2effae572742","fields":{"slug":"/stylelint-and-husky/"},"frontmatter":{"title":"stylelint와 husky를 통해 컨벤션 통일하기"}}},{"node":{"id":"ed5951d5-beda-5a8f-adb2-07c2fcb38d5e","fields":{"slug":"/OAuth2.0/"},"frontmatter":{"title":"내가 이해한 OAuth2.0"}}},{"node":{"id":"45eeb9a3-557d-5704-8fd9-925283e1e27b","fields":{"slug":"/restdocs-start/"},"frontmatter":{"title":"RestDocs로 API 문서화하기"}}},{"node":{"id":"663b560a-734d-51a9-a6dc-3c4f50716c74","fields":{"slug":"/spring-event-apply/"},"frontmatter":{"title":"Spring Event 적용하기"}}},{"node":{"id":"55ae8038-3f65-5a59-8db3-c7405e7fc125","fields":{"slug":"/github-actions-cypress/"},"frontmatter":{"title":"피움 Cypress 자동화 구축기"}}},{"node":{"id":"503e9e71-eda3-53d7-8142-7c309faf213e","fields":{"slug":"/why_we_applied_querydsl/"},"frontmatter":{"title":"피움 서비스의 Querydsl 도입 이유"}}},{"node":{"id":"709124d0-5b05-5530-804d-e90ec9856a13","fields":{"slug":"/querydsl_apply_procedure/"},"frontmatter":{"title":"피움 서비스의 Querydsl 적용 과정"}}},{"node":{"id":"5c865dcb-cefd-58be-8968-b5edf6c8080c","fields":{"slug":"/server-logging/"},"frontmatter":{"title":"Logback을 이용해 운영 환경 별 로그 남기기"}}},{"node":{"id":"8269f166-d041-533c-9d44-332d8d8c3dca","fields":{"slug":"/server-monitoring/"},"frontmatter":{"title":"CloudWatch를 이용한 모니터링 환경 구성"}}},{"node":{"id":"0faec7ad-3bd1-5f5e-9222-115f771df8ed","fields":{"slug":"/tanstack-query-cache-trouble-shooting/"},"frontmatter":{"title":"InfinityQuery에서 fetch가 제대로 이루어지지 않는다?!?!"}}},{"node":{"id":"c77f7199-7fc6-53a3-a1fb-0792e05655a7","fields":{"slug":"/OAuth2.0-backend/"},"frontmatter":{"title":"OAuth 2.0 로그인 구현하기 (카카오)"}}},{"node":{"id":"12e4480d-386b-5d0e-bd69-4209fed36066","fields":{"slug":"/OAuth-test-backend/"},"frontmatter":{"title":"외부 API 를 의존하는 OAuth 로그인 테스트하기"}}},{"node":{"id":"ff40e109-cc92-5d83-a213-ca9d07136d95","fields":{"slug":"/aws-s3-apply/"},"frontmatter":{"title":"AWS S3로 정적 이미지 배포하기"}}},{"node":{"id":"e343af80-72dd-5173-bbb5-5069a17d1200","fields":{"slug":"/search_in_spring_data_jpa/"},"frontmatter":{"title":"Spring Data Jpa를 활용한 검색 기능 개발하기"}}},{"node":{"id":"af344dd8-ea77-5fde-9452-a97952ce60be","fields":{"slug":"/submodule-apply/"},"frontmatter":{"title":"Git submodule을 이용한 민감정보 관리"}}},{"node":{"id":"08c9daf0-2344-52a9-8c68-31ac04c24ff0","fields":{"slug":"/tomcat-thread-config/"},"frontmatter":{"title":"톰캣 스레드 설정하기"}}},{"node":{"id":"eafed74f-ff11-5af1-a589-e9dd2ccb5c8e","fields":{"slug":"/http-cache/"},"frontmatter":{"title":"CloudFront와 HTTP 캐시"}}},{"node":{"id":"dbe47289-01f4-571d-9506-fbb92016f547","fields":{"slug":"/optimize-frontend/"},"frontmatter":{"title":"피움 최적화하기"}}},{"node":{"id":"7b830fe6-e2df-564a-926e-7f7800380336","fields":{"slug":"/query-analysis/"},"frontmatter":{"title":"서비스 내에서 발생하는 쿼리를 분석하고 개선하기"}}},{"node":{"id":"37437d15-a63e-52ef-b031-6ee1bc6fa8bc","fields":{"slug":"/image-resize/"},"frontmatter":{"title":"서버에서 이미지 리사이징하기"}}},{"node":{"id":"216f4636-4125-5765-83d8-a6a610692a41","fields":{"slug":"/dont-stop-deploy/"},"frontmatter":{"title":"무중단 배포 환경 구성하기"}}},{"node":{"id":"dd095976-5a96-51b5-9686-8956dc60cd24","fields":{"slug":"/hikaricp-connection-pool-setting/"},"frontmatter":{"title":"HikariCp Connection Pool 값 설정"}}},{"node":{"id":"625ad76f-acb1-56cc-9baa-3d6f1a954ac2","fields":{"slug":"/pwa/"},"frontmatter":{"title":"PWA를 도입해보자"}}},{"node":{"id":"6a12651c-e6b8-5fa6-9c57-766772d32680","fields":{"slug":"/serviceworker/"},"frontmatter":{"title":"Service Worker에 대한 대략적인 이해"}}},{"node":{"id":"b9709447-61dc-52f0-95a5-8670a3fbaaf4","fields":{"slug":"/installPrompt/"},"frontmatter":{"title":"홈화면에 추가 안내 prompt 만들기"}}}]},"previous":{"fields":{"slug":"/OAuth2.0-backend/"},"frontmatter":{"title":"OAuth 2.0 로그인 구현하기 (카카오)"}},"next":{"fields":{"slug":"/aws-s3-apply/"},"frontmatter":{"title":"AWS S3로 정적 이미지 배포하기"}}},"pageContext":{"id":"12e4480d-386b-5d0e-bd69-4209fed36066","series":null,"previousPostId":"c77f7199-7fc6-53a3-a1fb-0792e05655a7","nextPostId":"ff40e109-cc92-5d83-a213-ca9d07136d95"}},"staticQueryHashes":[],"slicesMap":{}}