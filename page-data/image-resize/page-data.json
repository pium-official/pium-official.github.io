{"componentChunkName":"component---src-templates-post-jsx","path":"/image-resize/","result":{"data":{"site":{"siteMetadata":{"title":"pium.log"}},"markdownRemark":{"id":"37437d15-a63e-52ef-b031-6ee1bc6fa8bc","excerpt":"이 글은 우테코 피움팀 크루 '주노, 참새'가 작성했습니다. 서론 피움 서비스를 이용하는 과정에서 불러오는 이미지의 크기가 너무 커서 사용자가 이미지 로드할 때 시간이 오래 걸린다. \n위와 같은 환경에서 이미지 로드 시간을 책정해봤다.\n \n사용자가 인터넷 환경이 느린 경우 1.8MB 사진을 로드하는 데 9.99초 이상의 로드시간이 걸린다. 피움 서비스는 …","html":"<blockquote>\n<p>이 글은 우테코 피움팀 크루 '<a href=\"https://github.com/Choi-JJunho\">주노</a>, <a href=\"https://github.com/WaiNaat\">참새</a>'가 작성했습니다.</p>\n</blockquote>\n<h2>서론</h2>\n<p>피움 서비스를 이용하는 과정에서 불러오는 이미지의 크기가 너무 커서 사용자가 이미지 로드할 때 시간이 오래 걸린다.</p>\n<blockquote>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/2ed8271ed35b40c1ae486ed89912fb04/c4525/79ba487e.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 101.76470588235296%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAADqElEQVR42pVU3WrjRhj1RaAXe1Ecgkm6sv7/Rv/SSLZk2XKcrBM29KalLJQ+Q+lFrwuFZUO60Jh9hUJp6UUfoA9U6OW69dKwWp1+4ziU0rDtCg7fzKA5850zR+o96uvvf/x4cjWfjV7M8uy6SoJVxdNVU41XTcFX502zujhdrC6W56vT4+NVRWsTQlMUqynnqypJruucv5iO+aUnSfu9o6MjNwyTG87HCMOocx0HPMtRjSqU9QLLRydYnj/GJ2cLPDlb4qNmhmUzx2x+gmZ+ilFZd2lWgPPRRpKkoLd/eMh0w3pl2qzTDfu1abE2CJN2XNbt1Reftz9/86z98dvn7S/Xl+2Xn33aLoqi/enZ1+33V0/bH55ftt89/ep1My5hmM7vkqSHvf39faaoxo2imlA1s1MUA6blIuI5eF4iKyskdYNovICZVLCyGm42QVDMwKj6vO4cWrMDvtF16W9CItsSqqohToNmOxgaLtQkgcRLSNEUSjqDls0xjKeQkymGBCmqOz0/hurzzaDf/zehouqw3QC8qOB7AUI/BE8zRIGPcV4gzzJ45HNGB2VxjDSJO06SPcaEh/cRGrBtRoYfo541GAvJROIHIUbVBGEUwzAMOrBAHCdIirxjsxNYlkOEg/sJHcdFXZVENkFOG5M0hef5VHMiL+CyYOuzYTlUnc6wXeiG+ZYOHQ/5aEQkHpjHECcpHJcuKuHIKF6eH0G8J/ZQ7RyyyLKdzWBwj4cyeSg6WJ6dk+w5SpJcT2fIyT9BGEQpNN2CZlhQ9VvCKE7B8smm74T3d2iSBOHdaFxtvRMbXJJM+UQYZyTPhiab0IYqVFkhwgyuH236g3s8FFV0sJNzK43msqJvu6ubBRzLg5S7GOYcQzvu4pSDsWDz4EH/7YR3EHNFM6jLGHE23qZAsSx8MPsQR+VFZzuMPPY2/f7/JFR3c8P2oZvetltNFZJlqJIkPlnxMfy35H90SNL9IEY5mSHlI4oPIa8RZpOOBamI0bsRihvV6ZMUkbJsb1tt16cL9DuLOqf3KDY7QpLw5+4C3ogY3P4k9E7eQazdjWVZ64YCNJZkXYzfGKoN+qncER4yavdme6LjdeJ0h3IobpRRgEOqIsgiMv4dSHoWRVtEQdixJIftha8eDh5GvYODA9txvN+YF/7h+eFLl/lrxsI1kaw1TV9rurGWFW1t0/oWrqgevXML1/VeWszbEH49pH9rj573CCGhIOR7e3v5HtXeu0HsjQTXXxRcEowLcwtWAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='79ba487e' title='' src='/static/2ed8271ed35b40c1ae486ed89912fb04/ca1dc/79ba487e.png' srcset='/static/2ed8271ed35b40c1ae486ed89912fb04/e7570/79ba487e.png 170w,\n/static/2ed8271ed35b40c1ae486ed89912fb04/f46e7/79ba487e.png 340w,\n/static/2ed8271ed35b40c1ae486ed89912fb04/ca1dc/79ba487e.png 680w,\n/static/2ed8271ed35b40c1ae486ed89912fb04/02d09/79ba487e.png 1020w,\n/static/2ed8271ed35b40c1ae486ed89912fb04/9d567/79ba487e.png 1360w,\n/static/2ed8271ed35b40c1ae486ed89912fb04/c4525/79ba487e.png 2290w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n위와 같은 환경에서 이미지 로드 시간을 책정해봤다.\n<span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/6e4a50d6f944540f32cab7c0cdedec9a/bf436/5020cb2e.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 72.94117647058825%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAACKUlEQVR42oVUyW4TQRCdfwBFHOJZumft8eyLZzyWYwtCkFBEiOAGFw7kgiKOHPj3R1XZsYwP9uGperpfv1p7rOnHX3Tf/6D48ozg/gnxI9mHX7h6/xPN4xPabkA/rNCQ9YMYSgcIwgRah4e1orWnfPm2xtt7THef0G0+IKgGFNNbZMstVLFAPW1R1p2IlXVPlw0cVwtczxfwmgW1H5EoCabGwCQGyvUILuIwQhgE8JVCFMaIzRxZXsGkOa0zucQ4FozidJcBRWvZjoa99+gwicjHllPKywZxMpfLp4IMjjDLa+FaxweMF7K3F5wTcViuRVDOTgRtR0kGq/UWUWTOC7JloW6YUFSdROLuoz+NsKxa4Z6PkFI08wJVs0CaVQgoAtclAe//CFnoZvtOanxWkJEQicGXuJMseMxnpyE1JStqOb+YcmJyDOMaTTvQhRiuZkfUnJkNz3YIrqRclK10+2LKaVbi9u6jDLchcdvXuG5azPIlZuUS12kjQl0/XhZkG8YZymaUGsY0ixzRm81XvPr8G68fnnF1+014ddtLjS/WMEprmHKC8hPa51cRQXsK2nEFyvEk5Tk55DPLPRlWJW80POxpPxQcRubFqWD3GBzqNO8xx+La5NShutm92arpaZgr9ItJXgiPTdsv6Xwh64TSZpisRTJvkJCNTEncVn4eFg+k45IHj6Exo87xNzcjpJow+nFFoiM6cnKwww1hg6pfI0x2XMfT+AeZ6rrU+Hi07gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='5020cb2e' title='' src='/static/6e4a50d6f944540f32cab7c0cdedec9a/ca1dc/5020cb2e.png' srcset='/static/6e4a50d6f944540f32cab7c0cdedec9a/e7570/5020cb2e.png 170w,\n/static/6e4a50d6f944540f32cab7c0cdedec9a/f46e7/5020cb2e.png 340w,\n/static/6e4a50d6f944540f32cab7c0cdedec9a/ca1dc/5020cb2e.png 680w,\n/static/6e4a50d6f944540f32cab7c0cdedec9a/bf436/5020cb2e.png 745w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n사용자가 인터넷 환경이 느린 경우 1.8MB 사진을 로드하는 데 9.99초 이상의 로드시간이 걸린다.</p>\n</blockquote>\n<p>피움 서비스는 사진 업로드가 유의미할 정도로 많이 일어나지 않는다.</p>\n<p>따라서 다음과 같은 시나리오로 이미지를 압축하려고한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"markdown\"><pre class=\"language-markdown\"><code class=\"language-markdown\"><span class=\"token list punctuation\">1.</span> S3에서 이미지 불러오기\n<span class=\"token list punctuation\">2.</span> 이미지 압축\n<span class=\"token list punctuation\">3.</span> S3로 이미지 보내기</code></pre></div>\n<p>서버에서 특정 시간마다 이미지 압축을 수행하고 이를 S3에 업로드하는 과정을 통해 이미지 최적화를 진행해보자.</p>\n<h2>시작하기</h2>\n<blockquote>\n<p>WebP(웹피)는 손실/비손실 압축 이미지 파일을 위한 이미지 포맷이다.\n<a href=\"https://ko.wikipedia.org/wiki/WebP\">위키백과</a></p>\n</blockquote>\n<p>이미지 압축을 진행하기에 앞서 다음 두가지 방식을 고려했다.</p>\n<ul>\n<li><code class=\"language-text\">1. 서버에서 cwebp 프로그램을 이용해 이미지를 webp 형태로 변환하는 방법</code></li>\n<li><code class=\"language-text\">2. node, python과 같은 언어를 이용해 이미지를 변환하는 방법</code></li>\n</ul>\n<p>1번의 경우 서버에 직접 프로그램을 설치하고 관리해야하는 관리 소요가 있다</p>\n<p>현재 빌드서버에서 배치로 작업을 수행할 것이기 때문에 npm이 이미 설치되어있다는 가정하에 javascript로 개발하는 것이 적합하다고 판단하여 node.js로 이미지 최적화 코드를 작성헀다.</p>\n<p>추가로 해당 코드를 주기적으로 실행시키기 위한 쉘 스크립트도 함께 작성했다.</p>\n<h2>코드</h2>\n<p>코드를 하나씩 살펴보자.</p>\n<h3>자바스크립트</h3>\n<p>이미지 변환에는 <a href=\"https://sharp.pixelplumbing.com/\">sharp</a> 라이브러리를 사용하였다. <a href=\"https://npmtrends.com/@squoosh/lib-vs-imagemagick-vs-imagemin-vs-sharp\">npm trends</a>를 이용해 비교했을 때 다른 패키지들과의 다운로드 수 차이가 많이 나서 정보를 찾아봤었다. sharp는 <a href=\"https://github.com/libvips/libvips\">libvips</a>를 사용하기 때문에 다른 라이브러리에 비해서 속도가 훨씬 빠르고, 컴퓨터의 자원 자체를 최대한 조금만 사용하도록 설계했다는 이야기를 듣게 되었다. 이는 아마존 aws라는 굉장히 한정된 자원을 가진 서버에서 이미지 최적화를 해야 한다는 우리의 문제 해결에 가장 적합할 것이라는 생각이 들어 최종적으로 sharp를 선택하였다.</p>\n<p><figure class='gatsby-resp-image-figure' style='margin-bottom: 16px;'>\n    <span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; '>\n      <a class='gatsby-resp-image-link' href='/static/3020b6a1f4e10970d9d4588c2a251f12/671b0/npm-trends.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 39.411764705882355%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABJ0AAASdAHeZh94AAABGUlEQVR42nVSi3LDIAzL///pelvaYPMGazLtZe22klMMjixjXTYRQQgHaq3ISdFbga9phL9swohpRkwmB3OGd2vrvfO7vYAVOFLHVTJGDqhyQ6gRtxIw9p1NGxbL+YuN87yVUniTuQ73iD8NTrwRMW8gARb1H8Fn8u/CzsLBiWqBqcCOG4x2WYx3UdYvQXt4YoP+tA4aChQiJYAegwVr7+DIUL376HyKvHhYKRj1C/G4IO0f5H4ipisjczVAM/dNoF0hlhDkAsk7dCboSCizoM12YsuFxrNTawkHxfAY0Yf3Z5y7ZS7izKizLpYLuGAmPHp+83E1ZUikYBAIPREa7L+TCG8V8w808oYRh+dTYa6ytnIiRs10JuMboMt0NrGjFGwAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='npm trends로 sharp, imagemin, imagemagick, squoosh의 다운로드 수를 비교한 결과 sharp가 압도적으로 많다' title='' src='/static/3020b6a1f4e10970d9d4588c2a251f12/ca1dc/npm-trends.png' srcset='/static/3020b6a1f4e10970d9d4588c2a251f12/e7570/npm-trends.png 170w,\n/static/3020b6a1f4e10970d9d4588c2a251f12/f46e7/npm-trends.png 340w,\n/static/3020b6a1f4e10970d9d4588c2a251f12/ca1dc/npm-trends.png 680w,\n/static/3020b6a1f4e10970d9d4588c2a251f12/02d09/npm-trends.png 1020w,\n/static/3020b6a1f4e10970d9d4588c2a251f12/9d567/npm-trends.png 1360w,\n/static/3020b6a1f4e10970d9d4588c2a251f12/671b0/npm-trends.png 1627w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span>\n    <figcaption class='gatsby-resp-image-figcaption'>npm trends로 sharp, imagemin, imagemagick, squoosh의 다운로드 수를 비교한 결과 sharp가 압도적으로 많다</figcaption>\n  </figure></p>\n<p>사진은 압축률이 가장 좋은 최신 기술인 webp를 기본적으로 제공하되, 지원하지 않는 브라우저를 고려해 png 확장자로도 바꿔서 저장한다. 아래는 변환 함수 부분만 담은 코드이다. <code class=\"language-text\">outputPath</code>의 파일 이름을 정하는 방식은 피움 팀 프론트엔드의 회의를 통해 나온 규칙이며, <a href=\"https://github.com/woowacourse-teams/2023-pium/discussions/384\">Github Discussions</a>에서 확인 가능하다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> join <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'path'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> sharp <span class=\"token keyword\">from</span> <span class=\"token string\">'sharp'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">convertImageTo</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">dir<span class=\"token punctuation\">,</span> filename<span class=\"token punctuation\">,</span> width<span class=\"token punctuation\">,</span> type<span class=\"token punctuation\">,</span> format</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> filenameWithoutExt <span class=\"token operator\">=</span> filename<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> inputPath <span class=\"token operator\">=</span> <span class=\"token function\">join</span><span class=\"token punctuation\">(</span>dir<span class=\"token punctuation\">,</span> filename<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> outputPath <span class=\"token operator\">=</span> <span class=\"token function\">join</span><span class=\"token punctuation\">(</span>dir<span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>filenameWithoutExt<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">.</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>type<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">.</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>format<span class=\"token punctuation\">.</span><span class=\"token function\">toLowerCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> image <span class=\"token operator\">=</span> <span class=\"token function\">sharp</span><span class=\"token punctuation\">(</span>inputPath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">width</span><span class=\"token operator\">:</span> imageWidth <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> image<span class=\"token punctuation\">.</span><span class=\"token function\">metadata</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  \n  <span class=\"token comment\">// 이미지가 목표보다 이미 작을 경우 굳이 조정하지 않음</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>imageWidth <span class=\"token operator\">&lt;=</span> width<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">await</span> image\n      <span class=\"token punctuation\">.</span><span class=\"token function\">withMetadata</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">toFile</span><span class=\"token punctuation\">(</span>outputPath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">await</span> image\n    <span class=\"token punctuation\">.</span><span class=\"token function\">resize</span><span class=\"token punctuation\">(</span>width<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">withMetadata</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">toFormat</span><span class=\"token punctuation\">(</span>format<span class=\"token punctuation\">.</span><span class=\"token function\">toLowerCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">quality</span><span class=\"token operator\">:</span> <span class=\"token number\">100</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">toFile</span><span class=\"token punctuation\">(</span>outputPath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>변환 이후 똑바로 일어나 있던 사진이 눕는 현상이 생겼었다. 이는 사진 파일들이 <code class=\"language-text\">orientation</code>이라는 메타데이터를 갖고 있는데 변환을 하면서 해당 자료를 잃어버려 생기는 현상이었다. sharp의 <code class=\"language-text\">withMetadata()</code>를 사용하면 간단하게 해결이 가능하다.</p>\n<p>커맨드 라인에서 받은 정보들을 갖고 이 함수를 이용해 하나씩 파일을 변환하는 방식이다.</p>\n<h3>쉘 스크립트</h3>\n<p>파일을 탐색하여 자바스크립트로 작성된 함수를 수행한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># 전처리</span>\n\n<span class=\"token function-name function\">convert_image</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin class-name\">local</span> <span class=\"token assign-left variable\">count_success</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>\n    <span class=\"token builtin class-name\">local</span> <span class=\"token assign-left variable\">count_failure</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>\n    <span class=\"token builtin class-name\">local</span> <span class=\"token assign-left variable\">count_skip</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>\n\n    <span class=\"token builtin class-name\">local</span> <span class=\"token assign-left variable\">target_dir</span><span class=\"token operator\">=</span><span class=\"token variable\">$1</span>\n    <span class=\"token builtin class-name\">local</span> <span class=\"token assign-left variable\">size</span><span class=\"token operator\">=</span><span class=\"token variable\">$2</span>\n    \n    <span class=\"token builtin class-name\">local</span> <span class=\"token assign-left variable\">total_files</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> <span class=\"token string\">\"<span class=\"token variable\">$target_dir</span>\"</span> <span class=\"token parameter variable\">-type</span> f <span class=\"token parameter variable\">-iname</span> <span class=\"token string\">\"*.jpeg\"</span> <span class=\"token parameter variable\">-o</span> <span class=\"token parameter variable\">-iname</span> <span class=\"token string\">\"*.jpg\"</span> <span class=\"token parameter variable\">-o</span> <span class=\"token parameter variable\">-iname</span> <span class=\"token string\">\"*.png\"</span> <span class=\"token parameter variable\">-o</span> <span class=\"token parameter variable\">-iname</span> <span class=\"token string\">\"*.gif\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">wc</span> <span class=\"token parameter variable\">-l</span><span class=\"token variable\">)</span></span>\n\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$total_files</span> 개의 파일에 대한 작업 시작\"</span>\n\n    <span class=\"token comment\"># 대, 소문자 구분 없이 탐색 활성화</span>\n    <span class=\"token builtin class-name\">shopt</span> <span class=\"token parameter variable\">-s</span> nocaseglob\n    <span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">file</span> <span class=\"token keyword\">in</span> <span class=\"token string\">\"<span class=\"token variable\">$target_dir</span>\"</span>/*.<span class=\"token punctuation\">{</span>jpeg,jpg,png,gif<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span>\n\t    <span class=\"token comment\"># 대, 소문자 구분 없이 탐색 비활성화</span>\n\t    <span class=\"token builtin class-name\">shopt</span> <span class=\"token parameter variable\">-u</span> nocaseglob\n\n\t    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token parameter variable\">-f</span> <span class=\"token string\">\"<span class=\"token variable\">$file</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span> <span class=\"token comment\"># 파일인 경우에만 처리</span>\n\t\t    <span class=\"token assign-left variable\">filename_full</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">basename</span> <span class=\"token string\">\"<span class=\"token variable\">$file</span>\"</span><span class=\"token variable\">)</span></span>\n\t\t    <span class=\"token assign-left variable\">extension</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">${filename<span class=\"token operator\">##</span>*.}</span>\"</span> <span class=\"token comment\"># 확장자 추출</span>\n\t\t    <span class=\"token assign-left variable\">extension</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$extension</span>\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">tr</span> <span class=\"token string\">'[:upper:]'</span> <span class=\"token string\">'[:lower:]'</span><span class=\"token variable\">)</span></span>  <span class=\"token comment\"># 확장자 소문자로 변환</span>\n\t\t    <span class=\"token assign-left variable\">filename</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">${filename_full<span class=\"token operator\">%</span>.*}</span>\"</span>\n\n\t\t    <span class=\"token assign-left variable\">output_file</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$target_dir</span>/<span class=\"token variable\">${filename}</span>.<span class=\"token variable\">${nick_name}</span>.webp\"</span>\n\t\t    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">\"<span class=\"token variable\">$output_file</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span> <span class=\"token comment\"># 이미 존재하는 파일이라면 생략</span>\n\t\t\t    <span class=\"token variable\"><span class=\"token punctuation\">((</span>count_skip<span class=\"token operator\">+=</span><span class=\"token number\">1</span><span class=\"token punctuation\">))</span></span>\n\t\t    <span class=\"token keyword\">else</span>\n\t\t\t    <span class=\"token comment\"># 여기에 이미지 압축!</span>\n\t\t\t    <span class=\"token function\">node</span> resize.js <span class=\"token parameter variable\">-d</span> <span class=\"token string\">\"<span class=\"token variable\">$target_dir</span>\"</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"<span class=\"token variable\">$filename_full</span>\"</span> <span class=\"token parameter variable\">-s</span> <span class=\"token string\">\"<span class=\"token variable\">$size</span>\"</span> <span class=\"token parameter variable\">-n</span> <span class=\"token string\">\"<span class=\"token variable\">$nick_name</span>\"</span>\n\n\t\t\t    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token variable\">$?</span> <span class=\"token parameter variable\">-ne</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n\t\t\t\t    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"변환 실패: <span class=\"token variable\">$file</span> -> <span class=\"token variable\">$output_file</span>\"</span> <span class=\"token operator\">>></span> <span class=\"token string\">\"<span class=\"token variable\">$error_log</span>\"</span>\n\t\t\t\t    <span class=\"token variable\"><span class=\"token punctuation\">((</span>count_failure<span class=\"token operator\">++</span><span class=\"token punctuation\">))</span></span>\n\t\t\t    <span class=\"token keyword\">else</span>\n\t\t\t\t    <span class=\"token variable\"><span class=\"token punctuation\">((</span>count_success<span class=\"token operator\">++</span><span class=\"token punctuation\">))</span></span>\n\t\t\t    <span class=\"token keyword\">fi</span>\n\t\t    <span class=\"token keyword\">fi</span>\n\t    <span class=\"token keyword\">fi</span>\n    <span class=\"token keyword\">done</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"\"</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"SIZE <span class=\"token variable\">$width</span> 변환 실패 파일 개수: <span class=\"token variable\">$count_failure</span>\"</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"SIZE <span class=\"token variable\">$width</span> 변환 성공 파일 개수: <span class=\"token variable\">$count_success</span>\"</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"SIZE <span class=\"token variable\">$width</span> 변환 생략 파일 개수: <span class=\"token variable\">$count_skip</span>\"</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># 함수 실행</span></code></pre></div>\n<h3>crontab</h3>\n<p>아래 쉘 스크립트를 crontab에 등록하여 이미지 저장 - 압축 - 등록 과정을 수행한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token shebang important\">#!/bin/bash</span>\n\n<span class=\"token comment\"># S3에서 이미지를 받아온다</span>\naws s3 <span class=\"token function\">sync</span> s3://<span class=\"token punctuation\">{</span>S3 이미지 경로<span class=\"token punctuation\">}</span> <span class=\"token punctuation\">{</span>로컬 이미지 경로<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># 최적화를 진행한다.</span>\n/home/ubuntu/resize-image/bash.sh <span class=\"token parameter variable\">-s</span> <span class=\"token number\">512</span> <span class=\"token parameter variable\">-n</span> <span class=\"token string\">\"small\"</span> <span class=\"token parameter variable\">-d</span> <span class=\"token string\">\"{로컬 이미지 경로}\"</span>\n/home/ubuntu/resize-image/bash.sh <span class=\"token parameter variable\">-s</span> <span class=\"token number\">128</span> <span class=\"token parameter variable\">-n</span> <span class=\"token string\">\"x-small\"</span> <span class=\"token parameter variable\">-d</span> <span class=\"token string\">\"{로컬 이미지 경로}\"</span>\n\n<span class=\"token comment\"># 최적화가 완료된 파일을 S3로 업로드한다.</span>\naws s3 <span class=\"token function\">sync</span> <span class=\"token punctuation\">{</span>로컬 이미지 경로<span class=\"token punctuation\">}</span> s3://<span class=\"token punctuation\">{</span>S3 이미지 경로<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>정리</h2>\n<p>간단하게 배포 시나리오와 별개로 이미지 리사이징을 수행해봤다.</p>\n<p>개발 일정이 이미 어느정도 잡혀있고 코드상으로 추가하기 어려운 부분이라면 서버에서 배치로 돌리는것도 고려해보면 좋을 것 같다.</p>\n<ul>\n<li><a href=\"https://github.com/pium-official/resize-image\">github 이미지 리사이징을 위한 코드</a></li>\n</ul>\n<h2>Reference</h2>\n<ul>\n<li><a href=\"https://certbot.eff.org/instructions\">https://certbot.eff.org/instructions</a></li>\n<li><a href=\"https://sharp.pixelplumbing.com\">https://sharp.pixelplumbing.com</a></li>\n</ul>","frontmatter":{"title":"서버에서 이미지 리사이징하기","date":"October 03, 2023","update":"October 03, 2023","tags":["javascript","이미지","webp"],"series":null},"fields":{"slug":"/image-resize/","readingTime":{"minutes":7.915}}},"seriesList":{"edges":[{"node":{"id":"28f1d87e-d3fc-5567-8531-57649652864f","fields":{"slug":"/sprint-idea/"},"frontmatter":{"title":"구글 스프린트 기반 아이디어 도출"}}},{"node":{"id":"4a9246fb-171b-5973-88fc-864034e78afd","fields":{"slug":"/blog-starter/"},"frontmatter":{"title":"피움 블로그 생성과정"}}},{"node":{"id":"c826ce0e-1ea7-517c-8d19-84e90a59a798","fields":{"slug":"/jenkins-setting/"},"frontmatter":{"title":"젠킨스 설치하기"}}},{"node":{"id":"a387bf4f-567f-50e7-b6a7-99a1a1c8971b","fields":{"slug":"/jpa-notnull-nullable/"},"frontmatter":{"title":"@NotNull과 nullable = false는 어떤 차이가 있을까?"}}},{"node":{"id":"a78e224b-b711-5071-8e90-013d6f4bebc3","fields":{"slug":"/pium-deploy-step/"},"frontmatter":{"title":"피움의 배포과정"}}},{"node":{"id":"ce07fbab-1ed5-5f1e-8e2f-eb430879b56a","fields":{"slug":"/fe-tanstack-query/"},"frontmatter":{"title":"프론트엔드: Tanstack Query 사용에 대하여"}}},{"node":{"id":"159c943b-1a50-57dd-aa71-7557364752a5","fields":{"slug":"/ci-cd-setting/"},"frontmatter":{"title":"Jenkins와 Github Webhook을 이용해 CI/CD 구축하기"}}},{"node":{"id":"dea45a4a-bfde-5fbb-8a97-42d3a3e77a0b","fields":{"slug":"/jenkins-hook-by-label/"},"frontmatter":{"title":"PR 라벨로 젠킨스 빌드유발을 구분하기"}}},{"node":{"id":"1a03734e-d413-553f-9152-1dad2fc4acca","fields":{"slug":"/apply-https/"},"frontmatter":{"title":"내 서버에 HTTPS 설정하기"}}},{"node":{"id":"cecbc8b9-db00-562b-aa0b-06c406cfc44a","fields":{"slug":"/bundle-analyze/"},"frontmatter":{"title":"bundle-analyze를 통한 bundle 크기 분석"}}},{"node":{"id":"707f8ffb-1409-5c27-b15a-5661b235c226","fields":{"slug":"/db-drop-stop/"},"frontmatter":{"title":"Table Drop 못하게 막아버리기"}}},{"node":{"id":"fe4b591a-4dd5-5dd2-b18a-b318afd1e9e3","fields":{"slug":"/transactional-not-in-restassured/"},"frontmatter":{"title":"[트러블슈팅] @SpringbootTest의 RANDOM_PORT 환경에서 @Transactional 어노테이션을 사용했을 때, RestAssured GET 요청이 수행되지 않는 경우(트랜잭션 격리 이해하기)"}}},{"node":{"id":"80aa708e-ef8a-5c79-9644-cb8c04d55a63","fields":{"slug":"/acceptance-test-resolve/"},"frontmatter":{"title":"인수테스트 데이터 초기화하기"}}},{"node":{"id":"15def1d5-c20f-5d07-b46e-24a14661365f","fields":{"slug":"/react-setting-without-cra/"},"frontmatter":{"title":"webpack으로만 React 설정하기 (without CRA)"}}},{"node":{"id":"66383c86-e2c8-533a-90e0-2effae572742","fields":{"slug":"/stylelint-and-husky/"},"frontmatter":{"title":"stylelint와 husky를 통해 컨벤션 통일하기"}}},{"node":{"id":"ed5951d5-beda-5a8f-adb2-07c2fcb38d5e","fields":{"slug":"/OAuth2.0/"},"frontmatter":{"title":"내가 이해한 OAuth2.0"}}},{"node":{"id":"45eeb9a3-557d-5704-8fd9-925283e1e27b","fields":{"slug":"/restdocs-start/"},"frontmatter":{"title":"RestDocs로 API 문서화하기"}}},{"node":{"id":"663b560a-734d-51a9-a6dc-3c4f50716c74","fields":{"slug":"/spring-event-apply/"},"frontmatter":{"title":"Spring Event 적용하기"}}},{"node":{"id":"503e9e71-eda3-53d7-8142-7c309faf213e","fields":{"slug":"/why_we_applied_querydsl/"},"frontmatter":{"title":"피움 서비스의 Querydsl 도입 이유"}}},{"node":{"id":"55ae8038-3f65-5a59-8db3-c7405e7fc125","fields":{"slug":"/github-actions-cypress/"},"frontmatter":{"title":"피움 Cypress 자동화 구축기"}}},{"node":{"id":"709124d0-5b05-5530-804d-e90ec9856a13","fields":{"slug":"/querydsl_apply_procedure/"},"frontmatter":{"title":"피움 서비스의 Querydsl 적용 과정"}}},{"node":{"id":"5c865dcb-cefd-58be-8968-b5edf6c8080c","fields":{"slug":"/server-logging/"},"frontmatter":{"title":"Logback을 이용해 운영 환경 별 로그 남기기"}}},{"node":{"id":"8269f166-d041-533c-9d44-332d8d8c3dca","fields":{"slug":"/server-monitoring/"},"frontmatter":{"title":"CloudWatch를 이용한 모니터링 환경 구성"}}},{"node":{"id":"0faec7ad-3bd1-5f5e-9222-115f771df8ed","fields":{"slug":"/tanstack-query-cache-trouble-shooting/"},"frontmatter":{"title":"InfinityQuery에서 fetch가 제대로 이루어지지 않는다?!?!"}}},{"node":{"id":"c77f7199-7fc6-53a3-a1fb-0792e05655a7","fields":{"slug":"/OAuth2.0-backend/"},"frontmatter":{"title":"OAuth 2.0 로그인 구현하기 (카카오)"}}},{"node":{"id":"12e4480d-386b-5d0e-bd69-4209fed36066","fields":{"slug":"/OAuth-test-backend/"},"frontmatter":{"title":"외부 API 를 의존하는 OAuth 로그인 테스트하기"}}},{"node":{"id":"ff40e109-cc92-5d83-a213-ca9d07136d95","fields":{"slug":"/aws-s3-apply/"},"frontmatter":{"title":"AWS S3로 정적 이미지 배포하기"}}},{"node":{"id":"e343af80-72dd-5173-bbb5-5069a17d1200","fields":{"slug":"/search_in_spring_data_jpa/"},"frontmatter":{"title":"Spring Data Jpa를 활용한 검색 기능 개발하기"}}},{"node":{"id":"af344dd8-ea77-5fde-9452-a97952ce60be","fields":{"slug":"/submodule-apply/"},"frontmatter":{"title":"Git submodule을 이용한 민감정보 관리"}}},{"node":{"id":"08c9daf0-2344-52a9-8c68-31ac04c24ff0","fields":{"slug":"/tomcat-thread-config/"},"frontmatter":{"title":"톰캣 스레드 설정하기"}}},{"node":{"id":"dbe47289-01f4-571d-9506-fbb92016f547","fields":{"slug":"/optimize-frontend/"},"frontmatter":{"title":"피움 최적화하기"}}},{"node":{"id":"7b830fe6-e2df-564a-926e-7f7800380336","fields":{"slug":"/query-analysis/"},"frontmatter":{"title":"서비스 내에서 발생하는 쿼리를 분석하고 개선하기"}}},{"node":{"id":"eafed74f-ff11-5af1-a589-e9dd2ccb5c8e","fields":{"slug":"/http-cache/"},"frontmatter":{"title":"CloudFront와 HTTP 캐시"}}},{"node":{"id":"37437d15-a63e-52ef-b031-6ee1bc6fa8bc","fields":{"slug":"/image-resize/"},"frontmatter":{"title":"서버에서 이미지 리사이징하기"}}},{"node":{"id":"216f4636-4125-5765-83d8-a6a610692a41","fields":{"slug":"/dont-stop-deploy/"},"frontmatter":{"title":"무중단 배포 환경 구성하기"}}},{"node":{"id":"dd095976-5a96-51b5-9686-8956dc60cd24","fields":{"slug":"/hikaricp-connection-pool-setting/"},"frontmatter":{"title":"HikariCp Connection Pool 값 설정"}}},{"node":{"id":"625ad76f-acb1-56cc-9baa-3d6f1a954ac2","fields":{"slug":"/pwa/"},"frontmatter":{"title":"PWA를 도입해보자"}}},{"node":{"id":"6a12651c-e6b8-5fa6-9c57-766772d32680","fields":{"slug":"/serviceworker/"},"frontmatter":{"title":"Service Worker에 대한 대략적인 이해"}}},{"node":{"id":"ac7012e4-5b85-5040-b65e-c068968d7979","fields":{"slug":"/web-push/"},"frontmatter":{"title":"브라우저에서 알림 구현하기"}}},{"node":{"id":"b9709447-61dc-52f0-95a5-8670a3fbaaf4","fields":{"slug":"/installPrompt/"},"frontmatter":{"title":"홈화면에 추가 안내 prompt 만들기"}}},{"node":{"id":"09501eea-fa70-5c42-9ee1-f25a5ab08bb5","fields":{"slug":"/pium-apply-pwa/"},"frontmatter":{"title":"피움의 PWA 적용기"}}},{"node":{"id":"0a47c3f5-616d-564f-b5d1-1ac2eb9bcc54","fields":{"slug":"/update-ssl/"},"frontmatter":{"title":"만료된 SSL 인증서 갱신하기"}}}]},"previous":{"fields":{"slug":"/http-cache/"},"frontmatter":{"title":"CloudFront와 HTTP 캐시"}},"next":{"fields":{"slug":"/dont-stop-deploy/"},"frontmatter":{"title":"무중단 배포 환경 구성하기"}}},"pageContext":{"id":"37437d15-a63e-52ef-b031-6ee1bc6fa8bc","series":null,"previousPostId":"eafed74f-ff11-5af1-a589-e9dd2ccb5c8e","nextPostId":"216f4636-4125-5765-83d8-a6a610692a41"}},"staticQueryHashes":[],"slicesMap":{}}