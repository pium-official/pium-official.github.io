{"componentChunkName":"component---src-templates-post-jsx","path":"/optimize-frontend/","result":{"data":{"site":{"siteMetadata":{"title":"pium.log"}},"markdownRemark":{"id":"dbe47289-01f4-571d-9506-fbb92016f547","excerpt":"이 글은 우테코 피움팀 크루 '클린'가 작성했습니다. 이미지 최적화는 참새가 숟가락 얹었어요. 피움 최적화 하기 어찌어찌 서비스를 개시하긴 했지만, 여러 가지로 문제가 있었습니다. 첫 페이지 로드 시에 미리 이미지 크기를 설정해 놓지 않아서 layout shift가 발생하기도 하고 전체적인 번들 크기가 400kb가 넘기도 하며, 페이지 로드 후에 폰트가 …","html":"<blockquote>\n<p>이 글은 우테코 피움팀 크루 '<a href=\"https://github.com/hozzijeong\">클린</a>'가 작성했습니다. 이미지 최적화는 참새가 숟가락 얹었어요.</p>\n</blockquote>\n<h1>피움 최적화 하기</h1>\n<p>어찌어찌 서비스를 개시하긴 했지만, 여러 가지로 문제가 있었습니다. 첫 페이지 로드 시에 미리 이미지 크기를 설정해 놓지 않아서 layout shift가 발생하기도 하고 전체적인 번들 크기가 400kb가 넘기도 하며, 페이지 로드 후에 폰트가 적용되어서 깜빡이는 현상이 발생하기도 했습니다. http 헤더 설정도 의도적으로 되어 있지 않아서 캐시 기간도 모르고, CDN 적용도 되어있지 않아서 캐시 역시 제대로 되지 않았습니다. 이러한 문제점들이 모여서 결국 사용자의 데이터를 많이 잡아먹고 폰트나 버벅거림 등은 분명한 사용자 경험 저해 요소이기 때문에 이를 해결하기 위한 방안을 세웠습니다.</p>\n<p>우선적으로 명시적인 문제를 먼저 해결해야 했습니다. Lighthouse를 통해서 측정을 해본 결과는 다음과 같습니다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/b158393b248d33587d2b515e634e86b2/ced39/before_optimize_lighthouse.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 75.29411764705883%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAACmklEQVR42o1Uy27TQBTtH4Q0UiMl8XgefsRv5+G0SUsrUFQCKg81BRalQkJigUoQj3+ohMSCBfBHfAWIAi2REBsWlAWCHmacuMSFBZau5o7nzPGZe894Ttd1ZFHTdEQOQ92kqNZ0ND0Gk+vQBAOJLBBOQSWu4TI5EhimCdu2QQg54ZhjjIHLIDpDyxe4c9HG+qKJdiBwe2Ch3xIor4ao3uxAX3JxqSNw70odSUBxvr+O61tbUBxZ5AhjT+B630fkcrQCAzcuxAhtCUwCOJe70OsmziU2tvoBLEERNxrodruglOYJs6CUpSA1cmFgSYKJTuG7Hnq9HpjMk84SNjeH0IgOz3MRx3GekHOO2VB1EELmjEPTtDRXG1SenkZihBAwZf3UmM2z/TmFmcoaYSebszHLJxiKYrGIYuEMCoUCqtXqyXqOUJd1dG2OtZaB0x/KiNUJ6vU69vb28PT5M7x49RKDwQCVSiVVOjerzDY5rq3ZuLvhSPvwtFH8FKFGNMRRhPfjA7w+3sdX/MDj0UPMl+ZhGEae0JR+u7pqYWPFgiFz+g+FmvRcGIb4dHCI/e+fsf/zC548eITiLKGSqqJaqeLsyjKWe13UarX0HVO1mWkakc2JpMI3797i29ERfuEYu/d3USqVJoSO48DzfYRRjLi9iEbSRaOdoNnuyKPF8KMm3LApFdIJ4VThh8OPkmry5AhVjSxpDctxEbY66HSXETQ78FoJTN+DJe3BldLpkRWhUjgej5E9o9HoD6GQQN+yIORE6DXE8pYY0tSEETDHgFt3/rKM2jgcDrG9vY1bOztoJ0nq09SHCkCkFVIwn3R20gxJItf06VreqxTlchkLCwtpZKZPfw5BEMB13dz1+Z/IGimm5VA3R5XiNy4k2/uhPWRNAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='before optimize lighthouse' title='' src='/static/b158393b248d33587d2b515e634e86b2/ca1dc/before_optimize_lighthouse.png' srcset='/static/b158393b248d33587d2b515e634e86b2/e7570/before_optimize_lighthouse.png 170w,\n/static/b158393b248d33587d2b515e634e86b2/f46e7/before_optimize_lighthouse.png 340w,\n/static/b158393b248d33587d2b515e634e86b2/ca1dc/before_optimize_lighthouse.png 680w,\n/static/b158393b248d33587d2b515e634e86b2/02d09/before_optimize_lighthouse.png 1020w,\n/static/b158393b248d33587d2b515e634e86b2/9d567/before_optimize_lighthouse.png 1360w,\n/static/b158393b248d33587d2b515e634e86b2/ced39/before_optimize_lighthouse.png 1408w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>생각보다 성능이 높게 나와서 놀랐습니다. 이제부터 세부 항목들을 찬찬히 살펴보겠습니다. </p>\n<ol>\n<li>번들의 크기가 너무 크다. </li>\n<li>폰트 로딩에 많은 시간이 소요된다.</li>\n<li>파일들이 캐시되지 않는다</li>\n</ol>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/7c927f597b1478c26334b4f2dea0f05f/eb638/before_optimize_detail.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 80%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAACKklEQVR42p2U647aQAyF8yCFAAm5Te6EXLi2CFh2q7ba93+YUx+HUEBUlfrjaCYTe2x/dmIZ10VVligXC1RVdVNRFFjWNaIgQGjbKKZT5JMJxuMxbNWolz3GRM6p2WwGy5MLjTGI4xhJkiBNU10pnkdRhNDzYDxfbHJ4JkOQFKJSlGMexhLExmj0RYNZ8/kcjuOAqyeO1LB3JZie+b6KF4SqQtcgzlC0OwRBePO16MRUJxNb0h800eehlEFaqv2nZNqYtIAvF0VRCN8PYPkSOcsyLS0KIwRhqBEfFaixL3s/6FdPns0VE22KokQo/lYUGZzf3nF5/8Dx9Ib1ZifNaFE3HZp2dVPbrV+KtpvdHj9/fYrvtmcYS5SuE6e2Rbfq11o6zAZluTCT7F2xmz+JZ8wwlKoa8UnE3tKGCMc4NtrVRMqItcORljo0SRna9oPYVb5jD3gp95KhJwxzrNcbyY5aa7Z13WCxqJDnhYp8ntmSK32NidWHeyuSrI6nM/aHE/aXT7Sbr1hUS2UzqK4fed6L78ny4/sPTUrHJhdOTdPeeAxz6bqD3JeiTSlfGSeFzOmvDD02RtjxMu/K5JnXK5ErOXMdGmUROm/fbLfKgRH7uTT/FNlVgod7fvf8/pXh4XjCt8NRZ7BaNhKgFT7dnVZ/Fe3J8XS+9Awdx0WWZljJ/HVdd81yITOY9XMo2XryY5hOZ4LCeRDPOAHknCSpYEv6ppDjvcjwf/Ub64Ti79oh5LQAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='before optimize detail' title='' src='/static/7c927f597b1478c26334b4f2dea0f05f/ca1dc/before_optimize_detail.png' srcset='/static/7c927f597b1478c26334b4f2dea0f05f/e7570/before_optimize_detail.png 170w,\n/static/7c927f597b1478c26334b4f2dea0f05f/f46e7/before_optimize_detail.png 340w,\n/static/7c927f597b1478c26334b4f2dea0f05f/ca1dc/before_optimize_detail.png 680w,\n/static/7c927f597b1478c26334b4f2dea0f05f/02d09/before_optimize_detail.png 1020w,\n/static/7c927f597b1478c26334b4f2dea0f05f/9d567/before_optimize_detail.png 1360w,\n/static/7c927f597b1478c26334b4f2dea0f05f/eb638/before_optimize_detail.png 1422w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>위 이미지에서 볼 수 있듯이, <code class=\"language-text\">bundle.js</code>의 파일 크기가 무려 444kib이고, 폰트의 크기 역시 합치면 1mb에 달합니다. 또한 캐시 + TTL에서 보면 알 수 있듯이 캐시를 전혀 사용하지 않고, 매번 새 파일을 요철하고 있습니다. 이는 사용자의 데이터를 그만큼 사용하고, 느린 네트워크 환경에서 속도를 저하시키는 요인이 됩니다. </p>\n<p>추가적으로 하나의 큰 문제로, 피움 서비스 내부에서 사용하는 아이콘들에 문제가 있습니다. 피움에서는 모든 아이콘들을 SVG-in-JS방식으로 사용하고 있는데, <a href=\"https://kurtextrem.de/posts/svg-in-js\">SVG-in-JS와 결별 이라는 글</a>에서 이 방법은 자바스크립트 컴파일 하는 코드의 양을 오히려 늘리는 안티 패턴이라는 글을 봤습니다. 해당 글에서 제안하는 해결 방법은 색 변화 등 props들의 영향을 받지 않는 이미지의 경우에 img태그를 통해 이미지를 로드하고, 그게 아닌 경우에는 <code class=\"language-text\">SVGSprite</code>라는 기술을 사용해서 이미지를 로드 하는 것을 추천하고 있습니다.</p>\n<p>따라서 피움은 아래 4가지를 개선함으로써 최적화를 진행했습니다.</p>\n<ul>\n<li>요청 크기 줄이기</li>\n<li>같은 요청 두번 하지 않기</li>\n<li>이미지 최적화</li>\n<li>SVG-in-JS 개선</li>\n</ul>\n<h2>요청 크기 줄이기</h2>\n<h3>정적 배포 방식 변경하기</h3>\n<p>현재 <code class=\"language-text\">EC2</code>를 통해서 전달 받는 bundle의 크기는 444KB입니다. 문제는 이 파일을 어떻게 줄일 수 있을까? 입니다. webpack을 사용하면서 자동으로 압축을 해주기 때문에 analyze로 분석했을 때 줄일 수 있는 부분은 크게 보이지 않았습니다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/e7b9813dbbb68e6b3d7cac71d943dbb5/8fe6b/before_optimize_bundle.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 18.823529411764707%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA3UlEQVR42nWPbUvCYBSG9/9/RB+iIJKioA+tjBAkc/nYs7Q5tomuTXzfs8VwM2RXU7KC6MDFzeFwX3C0D/XOf6yjhE2SsnwL6Yln2vUHus0WkR+y2d4X6k9Hy8Mpe7Jg8s1+32bkDAhebab9IRNvQByMS1lMNl+SjWb8dmip6JG27R2ZdFm/eOSmy0o6ZGXmpseo9oRrdvF9n8VsTlEU7KaMlT0kbf04NKU/om6bJFUDp3KNcXCKdXJF/+yGzvEl5tEF8vAcqd8janUa+h1W+bYjJJYhGFcbxGVfffEJwFgh2pdxQBkAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='before optimize bundle' title='' src='/static/e7b9813dbbb68e6b3d7cac71d943dbb5/ca1dc/before_optimize_bundle.png' srcset='/static/e7b9813dbbb68e6b3d7cac71d943dbb5/e7570/before_optimize_bundle.png 170w,\n/static/e7b9813dbbb68e6b3d7cac71d943dbb5/f46e7/before_optimize_bundle.png 340w,\n/static/e7b9813dbbb68e6b3d7cac71d943dbb5/ca1dc/before_optimize_bundle.png 680w,\n/static/e7b9813dbbb68e6b3d7cac71d943dbb5/02d09/before_optimize_bundle.png 1020w,\n/static/e7b9813dbbb68e6b3d7cac71d943dbb5/9d567/before_optimize_bundle.png 1360w,\n/static/e7b9813dbbb68e6b3d7cac71d943dbb5/8fe6b/before_optimize_bundle.png 2270w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>현재 받는 parsed size가 pium에서 받는 444kb와 같다는 것을 알 수 있습니다. 아래 있는 Gzipped size가 있는데 이 사이즈는 141kb로 3배 좀 넘게 차이가 나는 크기입니다. 그렇다면 어떻게 Gzipped로 파일을 압축할 수 있을까요?</p>\n<blockquote>\n<p><strong>gzip</strong>은 <a href=\"https://ko.wikipedia.org/wiki/%ED%8C%8C%EC%9D%BC_%EC%95%95%EC%B6%95\">파일 압축</a>에 쓰이는 <a href=\"https://ko.wikipedia.org/wiki/%EC%9D%91%EC%9A%A9_%EC%86%8C%ED%94%84%ED%8A%B8%EC%9B%A8%EC%96%B4\">응용 소프트웨어</a>이다. gzip은 GNU zip의 준말이며, 초기 <a href=\"https://ko.wikipedia.org/wiki/%EC%9C%A0%EB%8B%89%EC%8A%A4\">유닉스</a> 시스템에 쓰이던 <a href=\"https://ko.wikipedia.org/wiki/%EB%8D%B0%EC%9D%B4%ED%84%B0_%EC%95%95%EC%B6%95\">압축</a> 프로그램을 대체하기 위한 <a href=\"https://ko.wikipedia.org/wiki/%EC%9E%90%EC%9C%A0_%EC%86%8C%ED%94%84%ED%8A%B8%EC%9B%A8%EC%96%B4\">자유 소프트웨어</a>이다. - <a href=\"https://ko.wikipedia.org/wiki/Gzip\">위키 백과</a></p>\n</blockquote>\n<p>피움은 Gzipped로 변경하는 방법을 서비스 정적 배포 방식의 변경으로 선택했습니다. 기존 배포 방식은 EC2에 빌드한 파일을 올리고 주소창에 도메인을 입력하면 DNS에서 일치하는 도메인을 찾은 뒤 Nginx에서 EC2 서버 인스턴스에 있는 프론트엔드 정적 파일을 배포하는 방식을 사용했었습니다. </p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/ed130895f0092532a0c668d39d0400e3/68327/before_optimize_structure.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 40%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABtElEQVR42m2Sy27TUBCG8z48EQ/AipeAJ0DdsmJVJLJDLBBSRERJpAhiItLQKHbSOvEtxj52fI9r5+McRy0sGOmXxnP5zz8z7iGtaRryIqcoCpI85YM5wk58jmUl40UX/x/aU6vaudRd3tvfOr+nyLbbLY7rEvgBun3L088vGZkzMpHg7T1838fzvL+QMdu22Ev/kJVY/Y+4P99xUoRhGBIEQcee5RnWbsdyvcIwjI6ouW8oy4LT6cSDPfiaprHZbLAdG8ty5aQtPVcqq8qS6RFmxT20DUVeSEKduaGxuJ1h3Ok4tiPHzCEV+MmGm/pX9+jxeORf67mOQ1VVvJG1/ey8k0OUMTen9O9e8Wl3Sd+4YPFjyeT7BOwbBtcXPFs+Z2WvqKu662nbc28v+O0j9g7XuoFuml1CjWmYKybGAG09ZrwakMTpo4qiKcnaCkvuMU3TTtCjQnP4lv2LJyTuhjCMECIkjmNiEbOc64yvJvJB+R1HRJGCkOQJB5lX61K1w+GQxWJxJiy9NdmX18xnU66+jtjJi6uiUBIfkkOnQEQh6nhCiA4qp6D+EGV1XbOTx1T7/AOt81KUrsbJiAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='before optimize structure' title='' src='/static/ed130895f0092532a0c668d39d0400e3/ca1dc/before_optimize_structure.png' srcset='/static/ed130895f0092532a0c668d39d0400e3/e7570/before_optimize_structure.png 170w,\n/static/ed130895f0092532a0c668d39d0400e3/f46e7/before_optimize_structure.png 340w,\n/static/ed130895f0092532a0c668d39d0400e3/ca1dc/before_optimize_structure.png 680w,\n/static/ed130895f0092532a0c668d39d0400e3/68327/before_optimize_structure.png 950w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>(빌드 후에 폴더와 파일들을 gzip으로 압축해서 배포하는 방법도 있었지만, 이때는 생각하지 못했습니다)</p>\n<p>정적 배포 방식을 EC2에서 S3 + cloudfront로 변경하는 데에는 단순히 gzip만 있는 것도 아닙니다. s3를 사용했을 때 장점을 요약하자면 아래와 같습니다.</p>\n<ul>\n<li>자동 확장, 축소하기 때문에 특정 크기 할당 필요가 없음</li>\n<li>서버리스이기 때문에 파일이 저장되는 서버를 관리할 필요가 없음</li>\n<li>애플리케이션에 서버가 필요하더라도 정적 콘텐츠에 대한 요청 처리 필요가 없기 때문에 해당 서버의 크기 줄이기 가능.</li>\n</ul>\n<p>EC2는 결국 컴퓨터이기 때문에 만약에 메모리 초과가 발생하거나 모종의 이유로 서버가 다운된다면 피움 페이지로 들어온 사용자들은 흰 화면만 보게 됩니다. 아무것도 모르는 사용자는 어떠한 에러 페이지도 보지 못한 채 서비스를 떠나게 될 가능성이 있습니다. 또한, 단순히 정적 파일만을 제공하고 있는데 굳이 컴퓨터 한 대를 사용할 필요도 없습니다.</p>\n<p>s3 + cloudfront를 사용한다면 CDN 캐시를 통해 사용자에게 좀 더 빠르게 서비스 제공이 가능하고, http 캐시 설정이 가능합니다. 또한 앞에서 얘기한 gzip으로 자동 압축도 해주기 때문에 굳이 압축된 파일을 저장하고 있을 필요도 없습니다. (아래와 같이 cloudfront 설정할 때 자동으로 객체 압축을 설정해 주면 됩니다.)</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 600px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/39c1cdf053e5b21e387c8cb3b5b0c054/dface/compress_cloudfront.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 35.29411764705882%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAq0lEQVR42q2PTwuCQBTE9/t/pG4dOihJB8NcKTxmulrktu3/aVevQYINDG948IbfI845KKVgjJkcs4yWcafhAWjr4GNYIMI5R5rukedHlCVFUZyQZQckSYqKUozKYVMyjNJOB796idYGz5Gj6zoIIQKJh7UWOtDaiczjree5iNCGt4wUoLQCY2ymWPrft8ILe2F77tEHwmG4Y61I3Qvs6gfa5orm1q4vxJ/1AcIfJRml40GyAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='compress cloudfront' title='' src='/static/39c1cdf053e5b21e387c8cb3b5b0c054/dface/compress_cloudfront.png' srcset='/static/39c1cdf053e5b21e387c8cb3b5b0c054/e7570/compress_cloudfront.png 170w,\n/static/39c1cdf053e5b21e387c8cb3b5b0c054/f46e7/compress_cloudfront.png 340w,\n/static/39c1cdf053e5b21e387c8cb3b5b0c054/dface/compress_cloudfront.png 600w' sizes='(max-width: 600px) 100vw, 600px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<blockquote>\n<p>CDN(Contents Delivery Network)은 콘텐츠 전송 네트워크를 나타내는 약자로, 웹 콘텐츠와 웹 애플리케이션을 효율적으로 제공하기 위한 분산 네트워크입니다. CDN은 전 세계의 다양한 위치에 위치한 서버와 캐시 노드를 사용하여 웹 콘텐츠를 저장하고 전송함으로써 웹 성능을 최적화하고 가용성을 향상 시킵니다.</p>\n</blockquote>\n<p>좀 더 자세한 내용은 쵸파가 작성한 <a href=\"https://blog.pium.life/http-cache/\">Cloudfront와 HTTP캐시</a>에 있습니다.</p>\n<h3>코드 스플리팅</h3>\n<p>다운로드 하는 번들의 크기를 줄인다고 해도 그 다운로도 된 번들의 코드 중에서 사용하지 않는 코드가 있다면 이 역시 불필요하게 번들의 크기를 늘리는 요인이 됩니다. <code class=\"language-text\">React</code>를 통해서 서비스를 개발한 피움은 <code class=\"language-text\">[SPA](https://en.wikipedia.org/wiki/Single-page_application)</code>라는 특징을 갖고 있기 떄문에 하나의 번들에 모든 JS 코드가 들어있습니다. 이 때문에 첫 로딩이 상대적으로 오래걸린다는 단점이 있는데, <code class=\"language-text\">l[azy</code>를 통한 동적 <code class=\"language-text\">import</code>](<a href=\"https://react-ko.dev/reference/react/lazy\">https://react-ko.dev/reference/react/lazy</a>)를 통해서 url에 알맞는 컴포넌트만 동적으로 불러올 수 있습니다.</p>\n<p>여기서 “어떤 페이지를 동적으로 불러 올까?” 라는것에 대해서 여러 이야기를 나눴습니다. 저는 모든 페이지를 동적 <code class=\"language-text\">import</code>를 통해서 파일을 불러오는게 맞다라고 생각했습니다. 그 이유는 사용자들이 어떤 페이지를 들어갈 지 모르는데, 굳이 불필요한 리소스 다운이 될 수 있다는 것이었습니다. 하지만 다른 팀원은 그렇게 전부 나눠버리면 <code class=\"language-text\">SPA</code>의 장점이 사라지지 않는가, 결국 처음에 로딩이 좀 걸리더라도 다른 페이지에서는 빠르게 이동하는게 장점인데 오히려 모두 나눠버린다면 페이지 로드에 시간이 걸려서 사용자 경험을 해칠 수도 있고, <code class=\"language-text\">React</code>를 사용하는 이유가 없지 않나? 였습니다. </p>\n<p>따라서 사용자가 많이 접근할 것 같이 않은 페이지를 동적으로 불러오고, 핵심 페이지라고 생각되는 부분들은 <code class=\"language-text\">bundle</code>에 한번에 넣어서 오기로 했습니다. 아직 페이지 방문 횟수에 대한 믿을만한 데이터가 존재하지 않아서 사용자가 많이 왔다 갔다 할 것 같지 않은 <code class=\"language-text\">login</code>, <code class=\"language-text\">loginAuth</code>, <code class=\"language-text\">myPage</code> 페이지 만을 동적으로 불러오도록 설정했습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token comment\">// router.tsx</span>\n<span class=\"token keyword\">const</span> Login <span class=\"token operator\">=</span> <span class=\"token function\">lazy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token comment\">/* webpackChunkName: \"Login\" */</span> <span class=\"token string\">'pages/Login'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> Authorization <span class=\"token operator\">=</span> <span class=\"token function\">lazy</span><span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token comment\">/* webpackChunkName: \"Authorization\" */</span> <span class=\"token string\">'pages/Login/Authorization'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> MyPage <span class=\"token operator\">=</span> <span class=\"token function\">lazy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">import</span><span class=\"token punctuation\">(</span><span class=\"token comment\">/* webpackChunkName: \"MyPage\" */</span> <span class=\"token string\">'pages/MyPage'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3>폰트 용량 줄이기</h3>\n<p>그 다음 용량을 많이 차지하는 파일이 폰트 용량이었습니다. 2가지 폰트(<a href=\"https://corp.gmarket.com/fonts/\">GmarketSans, GmarketSansBold</a>)를 사용했는데, 두 개 합쳐서 거의 1MB에 육박했습니다. 원래 폰트는 <a href=\"https://hangeul.naver.com/font\">NanumSquareRound</a> 였는데, 해당 폰트는 뒑, 뿗, 똟과 같이 사용되지 않는 한글을 지원하고 있지 않았습니다. 따라서 실제로 입력하게 된다면 공백이 나오기 때문에 사용성이 좋지 않다는 생각했습니다. 따라서 차선책이었던 GmarketSans를 적용했었습니다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/fdaebcea128a9b258506fe9e170c8f79/25af7/nanumsquareround_fail.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 45.294117647058826%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA00lEQVR42q2Pz0oCURjFP6htQYGBuhB6iBahCxFJpAzyJQJz4UOqjI7gULqZF6iJ4ULMv7i3+dmdXiAdD/w4cBbn+45cr4a030a0Xp/pbsZ0Ni/0txOuln1kdsvpvMXJvPlv5NzpUFn2uFzccea0uXC62EymN4fRWD/R8IbUVwNq7oC6+/jrD1Td+8L3RdSX4v3zg0x/Y/hB56bwQxHf9/HWHlmWUVZ5niNRFJEkyV9QEmMMEscxQRCQpmkR2CtlKArDMEQphda69GyxrbbIfncM7QAyDlpL+t795gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='nanumsquareround fail' title='' src='/static/fdaebcea128a9b258506fe9e170c8f79/ca1dc/nanumsquareround_fail.png' srcset='/static/fdaebcea128a9b258506fe9e170c8f79/e7570/nanumsquareround_fail.png 170w,\n/static/fdaebcea128a9b258506fe9e170c8f79/f46e7/nanumsquareround_fail.png 340w,\n/static/fdaebcea128a9b258506fe9e170c8f79/ca1dc/nanumsquareround_fail.png 680w,\n/static/fdaebcea128a9b258506fe9e170c8f79/02d09/nanumsquareround_fail.png 1020w,\n/static/fdaebcea128a9b258506fe9e170c8f79/9d567/nanumsquareround_fail.png 1360w,\n/static/fdaebcea128a9b258506fe9e170c8f79/25af7/nanumsquareround_fail.png 1608w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>하지만, GmarketSans가 자주 사용하지 않는 한글을 지원한다는 것 자체가 쓸데없는 리소스가 많다는 의미기도 했습니다. 그래서 기본 폰트를 사용하되, <code class=\"language-text\">font-display:swap</code>을 사용해서, 폰트 로드를 했을 때 해당 폰트가 존재하지 않는다면 대체 폰트를 보여주는 방식을 사용했습니다. </p>\n<p>font-display 속성은 폰트를 선언하는 @fontface 블록 안에서만 유효한 속성입니다. 따라서 사용자가 @fontface를 선언하는 css 파일에서 별도로 지정해줘야 합니다. 피움에서는 처음에 <code class=\"language-text\">cdn</code>으로 제공하는 폰트를 사용했었는데, 해당 폰트에 불필요한 폰트들도 존재하고 개인적으로 사용되는 폰트들도 아니어서 새로운 <code class=\"language-text\">.css</code>파일을 만들고 그 안에서 <a href=\"https://github.com/woowacourse-teams/2023-pium/pull/375/commits/a86981e758f85325cafede6cf315208daaa1da26#diff-48658425b08ff6807ec0e40ecb127dd74d3497168f1805453435d99baf78da1b\">폰트 확장자 설정</a>을 했습니다. </p>\n<p>하지만 <code class=\"language-text\">NanumSquareRound</code>에 큰 문제(?)가 있었습니다. <code class=\"language-text\">font-display:swap</code>을 설정했는데도 지원하지 않는 문자를 설정했는데 적용되지 않았습니다. 이게 무슨일인가… 내가 어떤 잘못을 했나? 라는 생각을 하면서 문제를 찾고 있었는데 옆에 있던 참새가 아주 엄청난 것을 알려줬습니다. 바로, 나눔 스퀘어 라운드에서는 지원하지 않는 글자들의 경우에 공백을 나타낸다는 것입니다…!!</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/b0e87d523015f1845c63ae4fb83902a7/6bde6/font_empty.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 40%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABSklEQVR42nWR2YrCYAyF//d/CtE38FKxqLjUuotLlapYdxTFGxUUz/AFKgzM5CbJyX7ifN9XoVBQvV7XZrNREAQaDAZaLpeqVqum8RuNhsXL5bIWi8UvrFQqab1eW8zRMJ1Oa7fbCdnv97rdbmavVivT+EmcAQlGLjKfz00zyHW7XXmeZ9O2262azaZGo5HiOLataTocDg2nQaVS+WKtVsswNqOWmKMYI4oi1Wo1a3a9XvV+vxWGoYrFom1AAUI8n89rNpt9tyYPAXPcn0qlbCIaPi+Xix6PhxVns1n1+33jCsHOZDKCKrDX62W16PF4LMcUtksIbrfbmkwmZoNBNhskp3IFMXI6nY6Ox6M973A4WMwx9X6/G2d/PeXz+ej5fCqXy9mpCfbvU+iMAcHn81m9Xs+4IDl5BD42OZzKVdPp1HKp4Xmn08liP0wMOpony3N9AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='font empty' title='' src='/static/b0e87d523015f1845c63ae4fb83902a7/ca1dc/font_empty.png' srcset='/static/b0e87d523015f1845c63ae4fb83902a7/e7570/font_empty.png 170w,\n/static/b0e87d523015f1845c63ae4fb83902a7/f46e7/font_empty.png 340w,\n/static/b0e87d523015f1845c63ae4fb83902a7/ca1dc/font_empty.png 680w,\n/static/b0e87d523015f1845c63ae4fb83902a7/02d09/font_empty.png 1020w,\n/static/b0e87d523015f1845c63ae4fb83902a7/9d567/font_empty.png 1360w,\n/static/b0e87d523015f1845c63ae4fb83902a7/6bde6/font_empty.png 2100w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>(둘, 둠, 둡 등의 사용되는 단어들은 존재하는데, 제공하지 않는 단어는 존재하긴 하지만 공백을 제공합니다. <a href=\"https://fontdrop.info/#/?darkmode=true\">fontdrop</a>)</p>\n<p> <code class=\"language-text\">NanumSquare</code>에도 같은 문제가 있었고, 그것을 해결한 방법이 있는 <a href=\"https://github.com/blood72/NanumSquare\">블로그에서</a> 제공한 방식을 따라서 참새가<code class=\"language-text\">NanumSquareRound</code>에서 제공하지 않는 공백들을 개인적으로 제거한 커스텀 폰트를 만들어서 사용할 수 있었습니다. (참새 고맙습니다.)</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 326px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/ede124abb2563cdb973f0e79ba719ad5/15a61/font_success.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 30.58823529411765%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAyUlEQVR42pWQ3QqCMACFe+/oHRIqoqeIIgiKbgpvMvq5qCCqi0VgmpYzdVN3misoutEOnItv7HyMlSBzjExMvDW4iPEbIQT+SYlJie5tFOzCM4a3JWgSKOac40QIbMtC8HgozhU6McWM7hX0HANdZwr9vlV8sS2UKxVUNQ21egOmaea+Wgp9GP5LSJiN0W2FgbtQHLoO+q0miD7GvNMGvV6LCef+QUH6vujKs1ik2fLTon+Yjad0J0dAkEYIZWORgKccTDb6KivQJ2JgziJYIhyKAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='font success' title='' src='/static/ede124abb2563cdb973f0e79ba719ad5/15a61/font_success.png' srcset='/static/ede124abb2563cdb973f0e79ba719ad5/e7570/font_success.png 170w,\n/static/ede124abb2563cdb973f0e79ba719ad5/15a61/font_success.png 326w' sizes='(max-width: 326px) 100vw, 326px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>참새 덕분에 지원하지 않는 폰트의 경우에 대체 폰트로 지정할 수 있었고, 용량이 더 작고 원래 선택 했었던 폰트로 되돌아 갈 수 있었습니다.</p>\n<h3>폰트 preload 하기</h3>\n<p><img src=\"/static/preload_fail-8e18dfcb051a4e6b8f5debc984905c78.gif\"></p>\n<p>용량과는 큰 상관이 없지만, 폰트 다운로드가 페이지 로드가 완료된 다음에 실행 되었기 때문에 영상과 같이 처음 로드 했을때 혹은 새로고침 했을 때 폰트가 깜빡하는 문제가 있었습니다. 이는 사용자 경험에 매우 좋지 못하다는 생각에 어떻게든 해결을 해야 하는 문제 중 하나 였습니다. </p>\n<p>폰트 <code class=\"language-text\">preload</code>설정은 생각보다 쉬웠습니다.(끝나고 보니 쉬웠습니다…) 처음에는 단순히 <code class=\"language-text\">link</code>태그에 <code class=\"language-text\">preload</code>만 추가하면 되는 줄 알았는데, css로 폰트를 다운 받고, 해당 폰트에 <code class=\"language-text\">preload</code>를 적용하면 되는 것이었습니다. 처음에는 폰트 CDN을 통해서 다운로드 받는 방식을 했었는데, 폰트의 캐시 설정도 되지 않고 저희의 통제를 벗어난 외부 폰트라는 생각에 한번에 처리할 수 있으면 좋겠다는 생각에 사용하는 폰트 자체를 다운받고, 해당 .css 확장자에 폰트 url을 설정함으로써 preload를 구현할 수 있었습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\">// index.html\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>link</span>\n  <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>/fonts/NanumSquareRoundMissingGlyph.woff2<span class=\"token punctuation\">\"</span></span>\n  <span class=\"token attr-name\">rel</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>preload<span class=\"token punctuation\">\"</span></span>\n  <span class=\"token attr-name\">as</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>font<span class=\"token punctuation\">\"</span></span>\n  <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>font/woff2<span class=\"token punctuation\">\"</span></span>\n  <span class=\"token attr-name\">crossorigin</span>\n<span class=\"token punctuation\">/></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>link</span> <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>/fonts/font.css<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">rel</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>stylesheet<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>text/css<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"css\"><pre class=\"language-css\"><code class=\"language-css\"><span class=\"token atrule\"><span class=\"token rule\">@font-face</span></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">font-family</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'NanumSquareRound'</span><span class=\"token punctuation\">;</span>\n  <span class=\"token property\">font-weight</span><span class=\"token punctuation\">:</span> 500<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">font-style</span><span class=\"token punctuation\">:</span> normal<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">font-display</span><span class=\"token punctuation\">:</span> swap<span class=\"token punctuation\">;</span>\n  <span class=\"token property\">src</span><span class=\"token punctuation\">:</span> <span class=\"token url\"><span class=\"token function\">url</span><span class=\"token punctuation\">(</span><span class=\"token string url\">'/fonts/NanumSquareRoundMissingGlyph.woff2'</span><span class=\"token punctuation\">)</span></span> <span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token string\">'woff2'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><img src=\"/static/preload_success-3233a1b8b4a39726e66a4121119c4ffa.gif\"></p>\n<p>대체 폰트 설정과 폰트 <code class=\"language-text\">preload</code>를 통해서 용량을 줄이고 사용자 경험을 좀 더 끌어 올릴 수 있었습니다. 궁극적으로 gzip압축, 코드 스플리팅, 폰트 용량 줄이기 이 3가지를 통해서 압축한 용량은 다음과 같습니다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/b615dcc1aee4628f2cf542cc3780ee8a/f4146/preload_fail.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 18.823529411764707%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAABAklEQVR42h2Ky06DQAAA+QgP3jRFunSJsEB5yVIK9Gk0Vfs0qdVoTYwe/AK/fSQ9TWYyxu57z+fvkdVhyfp1xdvPG8EsIHvS5OsB5aZGzX3s2kaO5Mn925BmOyF91pz9HQnvH0lKE9FIjLvNgpf3A8vdksVqwWa/xcsVYRXhlyHZVBM1CaIv6CWy9QJXK/JZ0T4xTprhFwVx7iIjgeGGA0y7jyWTliG965SLjofqD/GjilRPCeL61DpWgAqHCCchysZIpeleCqQTYj8M6TgKYzyZU4+mFGWNpwLi9AbLEkRxSk86VKMJuS4xzSuELU+f6ymqZkwQpdht18Ki+9VwvvvgH+NwhxUEno5IAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='preload fail' title='' src='/static/b615dcc1aee4628f2cf542cc3780ee8a/ca1dc/preload_fail.png' srcset='/static/b615dcc1aee4628f2cf542cc3780ee8a/e7570/preload_fail.png 170w,\n/static/b615dcc1aee4628f2cf542cc3780ee8a/f46e7/preload_fail.png 340w,\n/static/b615dcc1aee4628f2cf542cc3780ee8a/ca1dc/preload_fail.png 680w,\n/static/b615dcc1aee4628f2cf542cc3780ee8a/02d09/preload_fail.png 1020w,\n/static/b615dcc1aee4628f2cf542cc3780ee8a/9d567/preload_fail.png 1360w,\n/static/b615dcc1aee4628f2cf542cc3780ee8a/f4146/preload_fail.png 1618w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/41b74380599b4313f6e520656313e62a/9d567/preload_success.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 20%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA+0lEQVR42h2O226CQBRF+ZAmNt5AcRwZYAZwAAFtq29tU+0lpIn//w+rJ308++ysvYJiPNLee9JvS/KZoW+G/KvA3DLUu8aPDek1x/6UbN4Um1fF7ppQ/7Yk14z+PuDuT8RjweUSEhj3jPUv1O2Zw+FMWQ3s/ZHcNkyXCWl5YqUq6ZyZzBIeHrdMwwwn9yzKKeoL2nVMXIuZKgJfWHzTc+hOAmrZ6h3WiqHJCKM1lW8kS2i6I6v1hvl8SazEvOlYxUpEerK8YD+IhDYEeyvPuhWgQPtBAJ7EpCi1JYoiirISoJYxTxguWSzm6J2mlHwdx/99Zx0f440uN/wBM+eE92wl9wsAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='preload success' title='' src='/static/41b74380599b4313f6e520656313e62a/ca1dc/preload_success.png' srcset='/static/41b74380599b4313f6e520656313e62a/e7570/preload_success.png 170w,\n/static/41b74380599b4313f6e520656313e62a/f46e7/preload_success.png 340w,\n/static/41b74380599b4313f6e520656313e62a/ca1dc/preload_success.png 680w,\n/static/41b74380599b4313f6e520656313e62a/02d09/preload_success.png 1020w,\n/static/41b74380599b4313f6e520656313e62a/9d567/preload_success.png 1360w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>455 + 487 + 658 = <code class=\"language-text\">1542</code> → 99.9 + 40.7 + 232 = <code class=\"language-text\">372.2</code></p>\n<p>거의 4배 가까이 되는 용량을 줄 일 수 있었습니다. 여기에 추가적으로 <code class=\"language-text\">preload</code>를 통해서 사용자 경험 향상까지 시킬 수 있었습니다.</p>\n<h2>같은 요청 두 번 하지 않기</h2>\n<p>짐을 한번 가져왔는데, 그 짐을 다시 가져오는 것만큼 비효율적인 것은 없습니다. 이는 데이터 통신에도 똑같이 적용됩니다. 한번 데이터(짐)을 가져오고 나면 해당 데이터를 어딘가에 저장해 둘 수 있으면 리소스를 그만큼 줄일 수 있습니다. 그리고 프로그래밍에서는 이것을 캐시라고 합니다.</p>\n<blockquote>\n<p><strong>캐시</strong>(cache, <a href=\"https://ko.wikipedia.org/wiki/%EB%AC%B8%ED%99%94%EC%96%B4\">문화어</a>: 캐쉬, 고속완충기, 고속완충기억기)는 <a href=\"https://ko.wikipedia.org/wiki/%EC%BB%B4%ED%93%A8%ED%84%B0_%EA%B3%BC%ED%95%99\">컴퓨터 과학</a>에서 데이터나 값을 미리 복사해 놓는 임시 장소를 가리킨다. 캐시는 캐시의 접근 시간에 비해 원래 데이터를 접근하는 시간이 오래 걸리는 경우나 값을 다시 계산하는 시간을 절약하고 싶은 경우에 사용한다. 캐시에 데이터를 미리 복사해 놓으면 계산이나 접근 시간없이 더 빠른 속도로 데이터에 접근할 수 있다.</p>\n</blockquote>\n<p>저희는 캐시 설정을 할 수 있습니다. 코드 용량을 줄이기 위해 적용했던 s3+cloudFront를 통한 정적 배포에서 CDN 캐시 설정과 http 캐시 설정이 가능합니다.</p>\n<blockquote>\n<p><strong>HTTP 캐시</strong>는 <code class=\"language-text\">Cache-Control</code>에 값을 설정해 줌으로써 해당 리소스 파일의 캐시 주기를 설정해 줄 수 있습니다. HTTP 캐시에서는 <code class=\"language-text\">max-age</code>라는 설정 값을 통해 해당 리소스의 유효기간을 정할 수 있습니다. (Expires 역시 동일하지만, max-age가 우선시 됩니다.)만약에 설정한 캐시 만료 전에 같은 요청이 들어온다면, 메모리에 저장되어 있는 기존 값을 보여줌으로써 서버 요청을 최소화 할 수 있습니다.</p>\n</blockquote>\n<p>여기서 <strong>같은 요청</strong>이란 같은 DNS에서 같은 파일 명을 요청하는 것을 의미합니다. 하지만, 버전을 업데이트 하거나 새롭게 배포하는 경우에 동일한 이름의 파일이 업로드 될 수 있는데, 저희는 배포를 할 때 <code class=\"language-text\">index.html</code>파일을 제외하고 모든 파일명과 확장자 사이에 랜덤한 해시값을 넣음 으로써 서로 다른 파일임을 알려주는 캐시 버스팅을 사용했습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// webpack.config.js</span>\n<span class=\"token literal-property property\">output</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">path</span><span class=\"token operator\">:</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'dist'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">filename</span><span class=\"token operator\">:</span> <span class=\"token string\">'[name].[contenthash].bundle.js'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">chunkFilename</span><span class=\"token operator\">:</span> <span class=\"token string\">'[name].[chunkhash].chunk.bundle.js'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">assetModuleFilename</span><span class=\"token operator\">:</span> <span class=\"token string\">'assets/[name][ext]'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>HTTP 캐시 정책은 각자 서비스에 맞춰서 설정하면 됩니다. 피움에서는 이 HTTP 캐시 설정일을 한 달로 설정했습니다. 즉, 한 달 동안은 브라우저에서 메모리에 파일들을 저장해 뒀다가 한 달 뒤에는 다시 CDN으로부터 정적 파일 정보를 받아오는 것입니다. 모든 파일에 대해서 HTTP 캐시 설정을 했지만 <code class=\"language-text\">index.html</code> 파일에 대해서는 캐시 설정을 하지 않았습니다.</p>\n<p>왜냐하면 <code class=\"language-text\">index.html</code> 파일에는 해시값을 추가할 수 없기 때문입니다. 따라서 데이터 요청을 할 때 <code class=\"language-text\">index</code>파일은 매번 S3에서 가져오고, 나머지 파일들은 HTTP 캐시를 통해 최적화했습니다. index 파일의 경우에 CDN 캐시도 설정할 수 있었지만, 현재 I AM 권한이 없어서 CDN 캐시 자동 무효화를 할 수 없습니다. 따라서 CDN 캐시 설정을 하는 대신에 배포할 때마다 수동으로 무효화하기 vs 매번 S3에서 새로운 요청 하기 둘 중 하나를 선택했어야 했는데, <code class=\"language-text\">index</code> 파일의 경우 성능상 문제가 있지 않아서 매번 S3에서 받아오는 형식을 선택했습니다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/4c0a0e334e2041637f10407f69648c04/2ed29/before_cache.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 125.88235294117646%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAZCAYAAAAxFw7TAAAACXBIWXMAAAsTAAALEwEAmpwYAAADnUlEQVR42tVVx5LjRgzlZ9i1NQoUqcCcs0gqjuSxXeWb//9Hnh8gcma9Vb75sgcQ3Y38gGYbfZIhjjP4cYUwyhGEMermiLo9YawcNHWNrj+jO3J/uiJOcnh+RN2Uuony/cHHwXmR0Q8n+EGMiE5FwXF9+DQQp1XdoOl6jOc76Ya2G5BmJRKScHH2ss0RMZD4MN7fHzQaMDB6WbW4XK74eD5wv11xGgflRVEhy0lFrTwva9VN0gIhk8iLRknkRpyWODGD43BWZYkehFKGB2cqQ9ZCrheiKBvNTnQdN5hk7icZ9z7B5fbUEv0gwm7v4kClGRMhMRQuGT2ev+P58Scx7jXALJ/JKNMQLUF3nIBldIpJklUKvmBUlK0aljVlbFjT9Ch5FrGKjGV6XkSsj9SJCEUD49thizfHxsLZYenusXC5ZuoLJ+V5Qp7g7RDr+m0fY53n+OVY4NeuxCIXOfXdHVabLVZrC8Z6Y8PkxrR20LVwc8v1RN+tRbbf7WHa1LG4dzy1nX2sTRtGxTK/B35PDAVLAf9AA+lcxFmN4pRls7PTeIie2El3BbuA8ly6XPQ3HPuRG5mrWCkIQzapxXa30/OcY5OkvACJdP/Axu1Vr+sH5eNwQX5usf6jg5HVI29Bj6KqOQ4ZsixXh0VZwbIsjkdOZ6nuZdBt21YKwoiD3jM7F63YM+DbX3R4qit0w8gOy9AW6sSlkmQohpKhyAry4XRWDLdbmwMdaYZBEHDs3jWgmYcwhsrXW/J4fuDx2weFd81qzkYzZ3QxaLsjnW2VEpYvAXaEJaF+w2Q2fz9gHFWxZ9mDkqQvDkqei0PJuqwqzVD0xIE4DKNIoXIch0PeoiBUVpcyw9NFBVKW58uPgR0Lwq8MeW+btmPpBc7XG2/RQR16nqcBpPTrVLK9NtkUppvnpTZCopvmmkYOqqqZmlJQuWSAGsN41s5LIMFZIIjY5cv1rgFtBjKktJFY9MNrdKRc4XXTTCXnKjuyATpKE4Y+qxGHcZzgxj+W+JFzI2XtVdMxgxYNS5dx8Fi2ZGZuNjp/PiEQknOLQTbM3HE9wtToeT9eEFNPzo3laoPF0sRyZSoXkjsp53KV1rr+OjOnOytrIVmLzXq+y/L5kcTRzOf17Gje/1tuf8r/J4fWT+1wasZ/Gay4X66sz4a85F/NMuRR0tcrSl+vF/+D8iSm2fxgJUinFy/hEA9lhi5PlZosQZMmcPm/dPlEuEWFfwDCOgJT6XSM8AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='before cache' title='' src='/static/4c0a0e334e2041637f10407f69648c04/ca1dc/before_cache.png' srcset='/static/4c0a0e334e2041637f10407f69648c04/e7570/before_cache.png 170w,\n/static/4c0a0e334e2041637f10407f69648c04/f46e7/before_cache.png 340w,\n/static/4c0a0e334e2041637f10407f69648c04/ca1dc/before_cache.png 680w,\n/static/4c0a0e334e2041637f10407f69648c04/02d09/before_cache.png 1020w,\n/static/4c0a0e334e2041637f10407f69648c04/2ed29/before_cache.png 1214w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/686e5732e6b7ef2bd0d2833d29395b85/ca756/after_cache.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 121.76470588235296%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAYCAYAAAD6S912AAAACXBIWXMAAAsTAAALEwEAmpwYAAAD3klEQVR42rVVWZbjNgzUQeJN1r5Tuyx5kdvdnU5ukfvfoVJFP/fMJC+f+cADRYIACihQztD06IYr6m6GqbnuRoynM5I4RnDcIYpTlFWDiXsSrSVpXmGoW/TdhLIZUdcd8sLAmUyLIi8RpQZxUiBJcxgGmeYLA51wub7huj5wvtzR9hNtchRlbS/npUGUZIjjjIEz3i3gXNc3NO2AjsaKXDGAvk/zFct5xfl6x0Jn83JDzwCyG6fF2sheQRRY2jocxgXr2wdu93eb1eX2QEvYeVExkyc8ZSQxhKXvl87yyu6/bJS90zUGb49PQlptdn4Q2/QlYZTaqE84OeGv+Pj8AyuDy0kQJYi5L7tvyJephIXN4obcrAklZU0rU9u1DCtlxGzbdsTj/QsNm5fnho3oEdGZmpkzwyhmhl5Z4Fhl8OscuzRE2BoEJkExMsPa2AtV3SA0FXZRgIh6T+3lRGHK515RIggTHFwfzv7gY7s9YL8/UjxsNgf4noc4POK3jYvd3mUZAuziCFuPe5RdGGDja83zwMfm4GK7c7E/eHDUgCQrbUFt3ShFVbOLHSlREPZoi9+KbwWbVLakSW6lqlqkackG1qiazt51+vlOIs88rJGQU0mSWpK2/cgACekjMhtSQ50v6VxczTBMM+ve4XwmnW4Ldn/NCOeeXZ5W0uadFxfybOSk9HRQWQkIdV7ODFbherszqxhhGKJpWkx0GEUx5vOFzifWMEBRj3BObWMvKRM5rOvmF4eTzd6Q5FfCIz2iiAww6PuBZUrI3dneixgoMxOc21iQV3d8/P6Fz68/CW2w9WsJRw7PlxsKQr0/PmBIJe2VZcUBWAk/x42Um4hOGdbdiZBJjXlZbJY1oeiyLhRlCd/3OWYnWwY5TpiRICvDThmyBMM42rVsK9PBWWbW8P6wETs2om4aW6OWWcpIGQyEdFvvdl8ZFkXB+b6S3AUuDKT6yzbJW3Z5HGwE1UfRA2XAmgmevlVDZX2lwyfk0EIdxsmiEDKbIUkdLXT4in7iwcKOqcAyFnzVRfOrC+v9DWmW2aYIhbqbZZrvm3Xqez5SjqqjB1RDLck4w8ejD88LCCG0a50fXA+eH8CV5lkQkj58GHQurYHYu0cEPontHjlWHLuXaHwObmD1D/FxsOLZef1h91xL69s7xk+Hv172vg2kf17/19nLx//lMPyXw5fBPx0KsvuT/l7L3lXtk2eGenpUC+nXM/Ta0/qlt/unbHbH7/WWZ3K827rwDhEcsVsvbsZ/SMOnquFzpn+JXms9T/Zf0jx/SBOnamlrnPjbkMxcd5z5mE9XQr6m4wl/A6qt4RHNYj/5AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='after cache' title='' src='/static/686e5732e6b7ef2bd0d2833d29395b85/ca1dc/after_cache.png' srcset='/static/686e5732e6b7ef2bd0d2833d29395b85/e7570/after_cache.png 170w,\n/static/686e5732e6b7ef2bd0d2833d29395b85/f46e7/after_cache.png 340w,\n/static/686e5732e6b7ef2bd0d2833d29395b85/ca1dc/after_cache.png 680w,\n/static/686e5732e6b7ef2bd0d2833d29395b85/02d09/after_cache.png 1020w,\n/static/686e5732e6b7ef2bd0d2833d29395b85/ca756/after_cache.png 1296w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>빠른 3G환경에서 캐시를 사용하지 않았을 때는 로드되는데 까지 3.36초가 걸린 반면에, 캐시를 사용했을 때 로드되는데 까지 0.752초가 걸리는 것을 볼 수 있습니다.</p>\n<h2>이미지 최적화</h2>\n<p>사진은 정말 여러 곳에서 사용됩니다. 크게는 사전 식물이나 반려 식물의 상세 정보부터 작게는 검색창 아래쪽에 나타나는 검색 결과 목록처럼요. 하지만 이 사진들은 전부 '원본 자료'를 요청하고 있었습니다. 가로세로 32픽셀 크기인 곳에서도 원본 사진을 받아왔죠. 그래서 사이트 첫 로딩에 사용하는 자원이 많았습니다.</p>\n<p>따라서 작은 사진이 필요한 곳에서는 작은 해상도의 사진을 받아와서 통신 비용을 절약해보자! 라는 생각을 하게 되었죠. 처음에는 Amazon CloudFront의 Lambda@Edge 기능을 활용해서 클라이언트 측에서 특정 해상도의 사진을 요청하면 원본을 변형해서 주는 방법을 적용하고 싶었습니다. 하지만 아쉽게도 Lambda 권한을 허락받지 못해 이 방법을 사용할 수는 없었어요. 그래서 임시로 지금 저장되어있는 사전 식물의 사진들만이라도 수동으로 처리해보자는 결론을 내렸습니다.</p>\n<p>방법은 크게 세 단계로 나눌 수 있습니다.</p>\n<ol>\n<li>S3에 저장된 식물 사진을 로컬로 다운로드</li>\n<li>로컬에서 <code class=\"language-text\">node.js</code>를 이용해서 사진 변환</li>\n<li>변환한 사진을 다시 S3에 업로드</li>\n</ol>\n<p>저희는 권한이 없어서 S3에서 바로 자료를 받아올 수는 없어서 EC2를 중간 다리로 활용해 S3에서 EC2로, EC2에서 다시 로컬로 옮기는 방법을 썼어요.</p>\n<p>사진 변환은 가장 많이 사용되는 <code class=\"language-text\">sharp</code> 라이브러리를 썼습니다. 가로세로 64픽셀의 초소형과 256픽셀의 소형 사진을 png, webp 형식 두 가지로 변환했어요. 사용한 코드는 아래와 같습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> Sharp <span class=\"token keyword\">from</span> <span class=\"token string\">'sharp'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 이 패키지는 npm으로 설치가 필요해요</span>\n<span class=\"token keyword\">import</span> fs <span class=\"token keyword\">from</span> <span class=\"token string\">'fs'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> join <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'path'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token constant\">SMALL</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">width</span><span class=\"token operator\">:</span> <span class=\"token number\">256</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token constant\">X_SMALL</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">width</span><span class=\"token operator\">:</span> <span class=\"token number\">64</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token constant\">INPUT_DIR</span> <span class=\"token operator\">=</span> <span class=\"token string\">'./static'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">OUTPUT_DIR</span> <span class=\"token operator\">=</span> <span class=\"token string\">'./output'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getFileNames</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">dir</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readdirSync</span><span class=\"token punctuation\">(</span>dir<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">convertImageTo</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">filename<span class=\"token punctuation\">,</span> width<span class=\"token punctuation\">,</span> type<span class=\"token punctuation\">,</span> format</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> inputPath <span class=\"token operator\">=</span> <span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token constant\">INPUT_DIR</span><span class=\"token punctuation\">,</span> filename<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> filenameWithoutExt <span class=\"token operator\">=</span> filename<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> sharp <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Sharp</span><span class=\"token punctuation\">(</span>inputPath<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">width</span><span class=\"token operator\">:</span> imageWidth <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> sharp<span class=\"token punctuation\">.</span><span class=\"token function\">metadata</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>imageWidth <span class=\"token operator\">&lt;=</span> width<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>filename<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> image width(</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>imageWidth<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">) is smaller than target size(</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>width<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">).</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">await</span> sharp\n    <span class=\"token punctuation\">.</span><span class=\"token function\">resize</span><span class=\"token punctuation\">(</span>width<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">toFormat</span><span class=\"token punctuation\">(</span>format<span class=\"token punctuation\">.</span><span class=\"token function\">toLowerCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">quality</span><span class=\"token operator\">:</span> <span class=\"token number\">100</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">toFile</span><span class=\"token punctuation\">(</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token constant\">OUTPUT_DIR</span><span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>filenameWithoutExt<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">.</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>type<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">.</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>format<span class=\"token punctuation\">.</span><span class=\"token function\">toLowerCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> filenames <span class=\"token operator\">=</span> <span class=\"token function\">getFileNames</span><span class=\"token punctuation\">(</span><span class=\"token constant\">INPUT_DIR</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nfilenames<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">filename</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">await</span> <span class=\"token function\">convertImageTo</span><span class=\"token punctuation\">(</span>filename<span class=\"token punctuation\">,</span> <span class=\"token constant\">SMALL</span><span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">,</span> <span class=\"token string\">'small'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'png'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">await</span> <span class=\"token function\">convertImageTo</span><span class=\"token punctuation\">(</span>filename<span class=\"token punctuation\">,</span> <span class=\"token constant\">SMALL</span><span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">,</span> <span class=\"token string\">'small'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'webp'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  \n  <span class=\"token keyword\">await</span> <span class=\"token function\">convertImageTo</span><span class=\"token punctuation\">(</span>filename<span class=\"token punctuation\">,</span> <span class=\"token constant\">X_SMALL</span><span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">,</span> <span class=\"token string\">'x-small'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'png'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">await</span> <span class=\"token function\">convertImageTo</span><span class=\"token punctuation\">(</span>filename<span class=\"token punctuation\">,</span> <span class=\"token constant\">X_SMALL</span><span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">,</span> <span class=\"token string\">'x-small'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'webp'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>정말 단순무식하긴 하지만 가장 확실한 방법이었습니다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/1104986a77a57803c930431ea2016da5/277d6/image-resize.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 31.176470588235293%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABJ0AAASdAHeZh94AAAA60lEQVR42m2R63bCIBCE8/7PqMYYQ4xCIHIL0GS6EKttdc7hwP7gm9ndan84YrgHtMqDTTMuOpQ6a8VfcS7gnMN/KaXAWI9puqM6Ni24CeingAuBpEtgai7vkJYNvL4+WmvfgN57DMMArTWq3aEuwI4gV52BscBa6TH59ACuT6CU6g0YYyTgdQPu64YAc2m5oyNsxJlgzUiuemt9WbakUkrcbvxp8mOUEnXFWDGklk8lVU7HTYQJX+AE7SnlSPdv5RnZDzPMYCEEjDFbwryMWjg00pWEJ0qY6x23iMtrNZw+sb7HJ3UdwzhKfAOxVdA/D00DEgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='image resize' title='' src='/static/1104986a77a57803c930431ea2016da5/ca1dc/image-resize.png' srcset='/static/1104986a77a57803c930431ea2016da5/e7570/image-resize.png 170w,\n/static/1104986a77a57803c930431ea2016da5/f46e7/image-resize.png 340w,\n/static/1104986a77a57803c930431ea2016da5/ca1dc/image-resize.png 680w,\n/static/1104986a77a57803c930431ea2016da5/277d6/image-resize.png 715w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>그 결과 파일의 용량을 어마무시하게 줄일 수 있었어요!</p>\n<p>하지만 이 방법은 어디까지나 임시방편이라 나중에는 백엔드와의 협업으로 새로운 방법을 사용하는 게 맞겠다는 생각이 듭니다.</p>\n<h2>SVG-in-JS 개선</h2>\n<p>피움에서는 여러 가지 아이콘들을 사용하고 있습니다. 그래서 처음에는 <code class=\"language-text\">react-icons</code>를 통해서 아이콘을 좀 편하게 사용하려고 했었는데 <a href=\"https://blog.pium.life/bundle-analyze/\">다음과 같은 문제</a>가 있었습니다. 지금 돌이켜 보면 <code class=\"language-text\">typescript</code> 컴파일 옵션을  CommonJS로 했기 때문에 icons에 있는 하나의 모듈이 전부 다운로드 돼서 사용하지 않는 아이콘들까지 같이 import 하는 문제였습니다. 웹팩에서는 자동으로 트리 쉐이킹을 해주기 때문에 일어날 수 없는 문제인데 CommonJS로 받아오게 되면서 트리 쉐이킹이 적용되지 않았던 것입니다. 즉, <code class=\"language-text\">react-icons</code>를 삭제하지 않고 <code class=\"language-text\">tsconfig</code> 파일에서 <code class=\"language-text\">module</code>을 <code class=\"language-text\">esnext</code>나 <code class=\"language-text\">target</code>에 맞춰서 넣으면 되는 해결할 수 있는 문제였는데, 당시에는 이것을 몰라서 라이브러리를 삭제하고 <code class=\"language-text\">[icons](https://icones.js.org/collection/all?s=p)</code>라는 사이트에서 아이콘들을 리액트 컴포넌트로 받아서 렌더링 하는 방식으로 적용했습니다.</p>\n<p>그렇게 작업을 하고 있던 와중에 <a href=\"https://kurtextrem.de/posts/svg-in-js\">SVG-in-JS와의 결별</a> 이라는 글을 봤습니다. 글의 요지는 다음과 같습니다.</p>\n<ul>\n<li>SVG 코드가 JS로 들어있다면 불필요한 번들의 크기가 커진다. 즉 파싱 &#x26; 컴파일할 게 많아진다.</li>\n<li>자바 스크립트가 실행되는 동안 파싱된 내용이 힙 메모리 내에 존재할 텐데, 다른 어플들을 실행하고 있다면 힙 메모리에 영향을 미칠 수 있다.</li>\n</ul>\n<p>svg는 javascript코드가 아닌 xml코드에 가깝습니다. 하지만 그 코드를 JS 파서로 파싱하는 것 자체가 어색한 일 입니다. 따라서 bundle 크기 축소와 사용자 메모리 최적화를 위해서 리액트 컴포넌트 형식으로 선언한 icon 들을 svg로 따로 분리했습니다.</p>\n<p>피움에서 사용하는 아이콘의 개수는 거의 40개에 육박합니다. 그렇다고 40개가 넘는 아이콘들은 전부 정적 파일로 저장하게 된다면 파일 용량이 상당히 커지게 됩니다. 그것 또한 사용자 성능에 좋지 못한 요소가 될 수 있습니다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/e0953398c9aa150afab2e6310ef2e1aa/4b293/svg_algorithm.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 57.05882352941176%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABGklEQVR42qWT23KCMBCGeaHWKiGcCQmhRhTH2ou+/5Ns91/Eoa3TqfZiJ5tN+LKHn+gltTRbXHSUm0BFO1BSvdI6c7Q8/4tFy40qPWUMTJsgQMSek5ZWun0MuMm7C8RQYYcf8IeBMF1vBVi6vaz/A2ZTP+dYxlmuLnfW9wB1PQ0CEPjoHfYpZ9v4UQz+b8OKvk7Z8+rkA/jzMOArtqTsBXhHye5aFrKcM1QMwqBiVkFuBlJVLxVsbmQafdfhMqsJaCegNhKru5Eqd6DS7mX/pIw8dhOI5qMkzTKBVOLcS6xod6JRADB13EEFjT/yAweRmJJ2LYAoDQd+OFPTH6UcyMWFM9nwxv5O/iDHvt2eRJ94LIwf1A3vV61+AuDdclc+u/qNAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='svg algorithm' title='' src='/static/e0953398c9aa150afab2e6310ef2e1aa/ca1dc/svg_algorithm.png' srcset='/static/e0953398c9aa150afab2e6310ef2e1aa/e7570/svg_algorithm.png 170w,\n/static/e0953398c9aa150afab2e6310ef2e1aa/f46e7/svg_algorithm.png 340w,\n/static/e0953398c9aa150afab2e6310ef2e1aa/ca1dc/svg_algorithm.png 680w,\n/static/e0953398c9aa150afab2e6310ef2e1aa/02d09/svg_algorithm.png 1020w,\n/static/e0953398c9aa150afab2e6310ef2e1aa/9d567/svg_algorithm.png 1360w,\n/static/e0953398c9aa150afab2e6310ef2e1aa/4b293/svg_algorithm.png 1606w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>위 의사 결정 표(?)를 보면 SVG를 사용할 때 그 용도에 따라 어떻게 설정하는지에 대한 가이드라인이 나와 있습니다. 4kb 미만이면서 폴더 안에 있는 경우에는 inline으로 쓰지만, 4kb 이상이고 정적인 색을 가지고 있다면 img 태그, 그게 아니라면 <code class=\"language-text\">SVG sprite</code>와 <code class=\"language-text\">use</code> 키워드를 사용하라고 했습니다.</p>\n<p><code class=\"language-text\">SVG sprite</code>의 사용법은 간단합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>svg</span> <span class=\"token attr-name\">xmlns</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>http://www.w3.org/2000/svg<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>defs</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>symbol</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>account-circle<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">viewBox</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>0 0 24 24<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n\t\t\t//...\n\t\t\t</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>symbol</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n\t\t\t// + 필요한 만큼 존재\n\t\t</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>defs</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>svg</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>사용하고자 하는 <code class=\"language-text\">svg</code> 파일들의 <code class=\"language-text\">path</code>를 고유 <code class=\"language-text\">id</code>를 가진 <code class=\"language-text\">symbol</code>들로 선언합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">SvgFill</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> icon<span class=\"token punctuation\">,</span> size <span class=\"token operator\">=</span> <span class=\"token number\">24</span><span class=\"token punctuation\">,</span> color <span class=\"token operator\">=</span> theme<span class=\"token punctuation\">.</span>color<span class=\"token punctuation\">.</span>gray<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>rest <span class=\"token punctuation\">}</span><span class=\"token operator\">:</span> SvgIconsProps<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>svg</span> <span class=\"token attr-name\">fill</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>color<span class=\"token punctuation\">}</span></span> <span class=\"token attr-name\">width</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>size<span class=\"token punctuation\">}</span></span> <span class=\"token attr-name\">height</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>size<span class=\"token punctuation\">}</span></span> <span class=\"token spread\"><span class=\"token punctuation\">{</span><span class=\"token operator\">...</span>rest<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>use</span> <span class=\"token attr-name\">href</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">#</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>icon<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>svg</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>그다음에 <code class=\"language-text\">svg</code> 태그 안에 <code class=\"language-text\">&lt;use /></code>태그를 넣고, <code class=\"language-text\">href</code>에 <code class=\"language-text\">symbol</code>로 지정한 <code class=\"language-text\">id</code> 값을 할당하면 끝입니다. 여기서 해당 <code class=\"language-text\">svg</code>의 <code class=\"language-text\">props</code>들을 인자로 받아서 설정할 수 있습니다. 만약에 사용하고자 하는 색이나 크기가 있다면 다음과 같이 선언할 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">SvgFill</span></span>\n  <span class=\"token attr-name\">icon</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>flowerpot<span class=\"token punctuation\">\"</span></span>\n  <span class=\"token attr-name\">color</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>primaryColor<span class=\"token punctuation\">}</span></span>\n  <span class=\"token attr-name\">aria-label</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>화분<span class=\"token punctuation\">\"</span></span>\n  <span class=\"token attr-name\">aria-describedby</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>반려 식물이 담긴 화분의 재질<span class=\"token punctuation\">\"</span></span>\n  <span class=\"token attr-name\">size</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token number\">20</span><span class=\"token punctuation\">}</span></span>\n<span class=\"token punctuation\">/></span></span></code></pre></div>\n<p><code class=\"language-text\">svg</code>를 리액트 컴포넌트처럼 사용하기 위해서는 <code class=\"language-text\">webpack</code>에 플러그인을 하나 추가해 줘야 하는데, 바로 <code class=\"language-text\">svgr</code>입니다. </p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// webpack.config.js</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token literal-property property\">test</span><span class=\"token operator\">:</span> <span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">\\.svg$</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">include</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'src'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'src'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'types'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'module.d.ts'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">issuer</span><span class=\"token operator\">:</span> <span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">\\.[jt]sx?$</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">use</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'@svgr/webpack'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'url-loader'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></code></pre></div>\n<p>또한, <code class=\"language-text\">typescript</code>에서 <code class=\"language-text\">svg</code>의 타입이 보통은 <code class=\"language-text\">string</code>이기 때문에 해당 타입이 <code class=\"language-text\">ReactComponent</code>라고 모듈을 선언해 줘야 합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">declare</span> <span class=\"token keyword\">module</span> <span class=\"token string\">'*.svg'</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">import</span> React <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> ReactComponent<span class=\"token operator\">:</span> React<span class=\"token punctuation\">.</span>FunctionComponent<span class=\"token operator\">&lt;</span>React<span class=\"token punctuation\">.</span>SVGProps<span class=\"token operator\">&lt;</span>SVGSVGElement<span class=\"token operator\">>></span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> src<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> src<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>하지만 위 코드를 보면 약간 의아한 게 있습니다. <code class=\"language-text\">React Component</code>와 <code class=\"language-text\">src</code>를 같이 반환하고 있다는 것입니다. SVG Sprite를 사용하기 위해서는 svg 확장자를 리액트 컴포넌트처럼 사용해야 하는데, 그 반환 값을 커스텀 타입으로 지정해 준 것입니다. 하지만 아예 <code class=\"language-text\">ReactCompnent만</code>을 반환하게 한다면 <code class=\"language-text\">&lt;img/></code>태그에 <code class=\"language-text\">src</code> 속성에 정적인 <code class=\"language-text\">svg</code> 주소를 넣을 수 없는 문제가 있었습니다. 따라서 <code class=\"language-text\">React Component</code>와 <code class=\"language-text\">src</code> 모두 지원하기 위해서 2가지를 <code class=\"language-text\">export</code> 하도록 설정했습니다.</p>\n<p>하지만, 위처럼 2가지를 export 하도록 바꾸니 코드 스플리팅이 제대로 되지 않는 것 같았습니다. 만약에 정적인 데이터를 불러오기 위해서 <code class=\"language-text\">assets</code> 내부에 있는 <code class=\"language-text\">.svg</code>확장자를 불러오고 번들 크기 분석을 해봤는데, 평소보다 2배가 더 큰 용량을 차지하고 있는것을 볼 수 있었습니다.</p>\n<p>사용하지 않는 이미지를 불러오는 것을 보고 왜 트리 쉐이킹 안되지? 하는 생각을 했습니다 (애초에 이게 트리 쉐이킹이 맞는지도 잘 모르겠습니다.) 하지만 이미지를 svg가 아닌 png로 변경하니 바로 문제 해결이 됐습니다. 이미지 품질 자체에 문제가 있을까 걱정했지만, 정적으로 제공하는 이미지들이 해상도가 아주 중요한 이미지들이 아니기 때문에 문제가 없을 것으로 생각해서 png로 제공하기로 했습니다.</p>\n<p>그다음 문제는 SVG symbol들을 저장하는 코드의 위치였습니다. SVG Sprite를 사용하는 이유가 번들 크기를 줄이기 위해서인데, symbol들을 저장하는 소스 코드 파일 자체가 리액트 컴포넌트 형식으로 작성되어 있어서 이게 맞냐고 생각을 했습니다. 그래서 svg 확장자로 설정하고 CDN으로 받아오려고 시도해 봤지만, cors 문제로 인해 불가능했습니다.</p>\n<blockquote>\n<p>SVG <code class=\"language-text\">&lt;use></code> elements don’t currently have any way to ask for cross-origin permissions. They just don’t work cross-origin, at all. - <a href=\"https://oreillymedia.github.io/Using_SVG/extras/ch10-cors.html#:~:text=SVG%20%3Cuse%3E%20elements%20don%E2%80%99t%20currently%20have%20any%20way%20to%20ask%20for%20cross-origin%20permissions.%20They%20just%20don%E2%80%99t%20work%20cross-origin%2C%20at%20all.\">cors</a></p>\n</blockquote>\n<p>따라서 html에 직접 삽입하는 방법밖에 없었는데, 그렇게 된다면 icon이 추가될 때마다 <code class=\"language-text\">index</code>파일을 바꿔야 하는 번거로움이 있었습니다. SPA로 구현하고 있는 상황에서 불특정한 상황에 따라 <code class=\"language-text\">index</code> 파일이 바뀌는 게 괜한 거부감이 있어서 현재는 리액트 컴포넌트로 삽입하고 있는데, 이 방법이 맞는지는 여전히 의문이긴 합니다. (icon 같은 경우에는 그렇게 많이 바뀌는 것이 아니라 상관이 없을 것 같다는 생각이 있어서 그냥 넣어도 되지 않을까 생각하기도 합니다.)</p>\n<p>또 하나의 아쉬운 점은 SVG Sprite를 사용함으로써 파싱할 코드의 양이 줄어들어서 사용자에게 감동을 주는 정도로 변화가 있을까 생각했지만, 번들 크기는 30kb가 줄었고 (압축 전) 기능상 큰 변화는 없는 것 같아서 약간 아쉬운 결과를 남겼습니다. 최적화 수업 때 망치를 들면 뭐든지 못으로 보인다고 했는데 저는 오함마를 들고 서비스를 다지려고 하지 않았나 생각이 들었습니다.</p>","frontmatter":{"title":"피움 최적화하기","date":"September 21, 2023","update":"September 26, 2023","tags":["웹 최적화","bundle","정적 배포"],"series":null},"fields":{"slug":"/optimize-frontend/","readingTime":{"minutes":36.155}}},"seriesList":{"edges":[{"node":{"id":"28f1d87e-d3fc-5567-8531-57649652864f","fields":{"slug":"/sprint-idea/"},"frontmatter":{"title":"구글 스프린트 기반 아이디어 도출"}}},{"node":{"id":"4a9246fb-171b-5973-88fc-864034e78afd","fields":{"slug":"/blog-starter/"},"frontmatter":{"title":"피움 블로그 생성과정"}}},{"node":{"id":"c826ce0e-1ea7-517c-8d19-84e90a59a798","fields":{"slug":"/jenkins-setting/"},"frontmatter":{"title":"젠킨스 설치하기"}}},{"node":{"id":"a387bf4f-567f-50e7-b6a7-99a1a1c8971b","fields":{"slug":"/jpa-notnull-nullable/"},"frontmatter":{"title":"@NotNull과 nullable = false는 어떤 차이가 있을까?"}}},{"node":{"id":"a78e224b-b711-5071-8e90-013d6f4bebc3","fields":{"slug":"/pium-deploy-step/"},"frontmatter":{"title":"피움의 배포과정"}}},{"node":{"id":"ce07fbab-1ed5-5f1e-8e2f-eb430879b56a","fields":{"slug":"/fe-tanstack-query/"},"frontmatter":{"title":"프론트엔드: Tanstack Query 사용에 대하여"}}},{"node":{"id":"159c943b-1a50-57dd-aa71-7557364752a5","fields":{"slug":"/ci-cd-setting/"},"frontmatter":{"title":"Jenkins와 Github Webhook을 이용해 CI/CD 구축하기"}}},{"node":{"id":"dea45a4a-bfde-5fbb-8a97-42d3a3e77a0b","fields":{"slug":"/jenkins-hook-by-label/"},"frontmatter":{"title":"PR 라벨로 젠킨스 빌드유발을 구분하기"}}},{"node":{"id":"1a03734e-d413-553f-9152-1dad2fc4acca","fields":{"slug":"/apply-https/"},"frontmatter":{"title":"내 서버에 HTTPS 설정하기"}}},{"node":{"id":"cecbc8b9-db00-562b-aa0b-06c406cfc44a","fields":{"slug":"/bundle-analyze/"},"frontmatter":{"title":"bundle-analyze를 통한 bundle 크기 분석"}}},{"node":{"id":"707f8ffb-1409-5c27-b15a-5661b235c226","fields":{"slug":"/db-drop-stop/"},"frontmatter":{"title":"Table Drop 못하게 막아버리기"}}},{"node":{"id":"fe4b591a-4dd5-5dd2-b18a-b318afd1e9e3","fields":{"slug":"/transactional-not-in-restassured/"},"frontmatter":{"title":"[트러블슈팅] @SpringbootTest의 RANDOM_PORT 환경에서 @Transactional 어노테이션을 사용했을 때, RestAssured GET 요청이 수행되지 않는 경우(트랜잭션 격리 이해하기)"}}},{"node":{"id":"80aa708e-ef8a-5c79-9644-cb8c04d55a63","fields":{"slug":"/acceptance-test-resolve/"},"frontmatter":{"title":"인수테스트 데이터 초기화하기"}}},{"node":{"id":"15def1d5-c20f-5d07-b46e-24a14661365f","fields":{"slug":"/react-setting-without-cra/"},"frontmatter":{"title":"webpack으로만 React 설정하기 (without CRA)"}}},{"node":{"id":"66383c86-e2c8-533a-90e0-2effae572742","fields":{"slug":"/stylelint-and-husky/"},"frontmatter":{"title":"stylelint와 husky를 통해 컨벤션 통일하기"}}},{"node":{"id":"ed5951d5-beda-5a8f-adb2-07c2fcb38d5e","fields":{"slug":"/OAuth2.0/"},"frontmatter":{"title":"내가 이해한 OAuth2.0"}}},{"node":{"id":"45eeb9a3-557d-5704-8fd9-925283e1e27b","fields":{"slug":"/restdocs-start/"},"frontmatter":{"title":"RestDocs로 API 문서화하기"}}},{"node":{"id":"663b560a-734d-51a9-a6dc-3c4f50716c74","fields":{"slug":"/spring-event-apply/"},"frontmatter":{"title":"Spring Event 적용하기"}}},{"node":{"id":"55ae8038-3f65-5a59-8db3-c7405e7fc125","fields":{"slug":"/github-actions-cypress/"},"frontmatter":{"title":"피움 Cypress 자동화 구축기"}}},{"node":{"id":"503e9e71-eda3-53d7-8142-7c309faf213e","fields":{"slug":"/why_we_applied_querydsl/"},"frontmatter":{"title":"피움 서비스의 Querydsl 도입 이유"}}},{"node":{"id":"709124d0-5b05-5530-804d-e90ec9856a13","fields":{"slug":"/querydsl_apply_procedure/"},"frontmatter":{"title":"피움 서비스의 Querydsl 적용 과정"}}},{"node":{"id":"5c865dcb-cefd-58be-8968-b5edf6c8080c","fields":{"slug":"/server-logging/"},"frontmatter":{"title":"Logback을 이용해 운영 환경 별 로그 남기기"}}},{"node":{"id":"8269f166-d041-533c-9d44-332d8d8c3dca","fields":{"slug":"/server-monitoring/"},"frontmatter":{"title":"CloudWatch를 이용한 모니터링 환경 구성"}}},{"node":{"id":"0faec7ad-3bd1-5f5e-9222-115f771df8ed","fields":{"slug":"/tanstack-query-cache-trouble-shooting/"},"frontmatter":{"title":"InfinityQuery에서 fetch가 제대로 이루어지지 않는다?!?!"}}},{"node":{"id":"c77f7199-7fc6-53a3-a1fb-0792e05655a7","fields":{"slug":"/OAuth2.0-backend/"},"frontmatter":{"title":"OAuth 2.0 로그인 구현하기 (카카오)"}}},{"node":{"id":"12e4480d-386b-5d0e-bd69-4209fed36066","fields":{"slug":"/OAuth-test-backend/"},"frontmatter":{"title":"외부 API 를 의존하는 OAuth 로그인 테스트하기"}}},{"node":{"id":"ff40e109-cc92-5d83-a213-ca9d07136d95","fields":{"slug":"/aws-s3-apply/"},"frontmatter":{"title":"AWS S3로 정적 이미지 배포하기"}}},{"node":{"id":"e343af80-72dd-5173-bbb5-5069a17d1200","fields":{"slug":"/search_in_spring_data_jpa/"},"frontmatter":{"title":"Spring Data Jpa를 활용한 검색 기능 개발하기"}}},{"node":{"id":"af344dd8-ea77-5fde-9452-a97952ce60be","fields":{"slug":"/submodule-apply/"},"frontmatter":{"title":"Git submodule을 이용한 민감정보 관리"}}},{"node":{"id":"08c9daf0-2344-52a9-8c68-31ac04c24ff0","fields":{"slug":"/tomcat-thread-config/"},"frontmatter":{"title":"톰캣 스레드 설정하기"}}},{"node":{"id":"eafed74f-ff11-5af1-a589-e9dd2ccb5c8e","fields":{"slug":"/http-cache/"},"frontmatter":{"title":"CloudFront와 HTTP 캐시"}}},{"node":{"id":"dbe47289-01f4-571d-9506-fbb92016f547","fields":{"slug":"/optimize-frontend/"},"frontmatter":{"title":"피움 최적화하기"}}},{"node":{"id":"7b830fe6-e2df-564a-926e-7f7800380336","fields":{"slug":"/query-analysis/"},"frontmatter":{"title":"서비스 내에서 발생하는 쿼리를 분석하고 개선하기"}}},{"node":{"id":"37437d15-a63e-52ef-b031-6ee1bc6fa8bc","fields":{"slug":"/image-resize/"},"frontmatter":{"title":"서버에서 이미지 리사이징하기"}}},{"node":{"id":"216f4636-4125-5765-83d8-a6a610692a41","fields":{"slug":"/dont-stop-deploy/"},"frontmatter":{"title":"무중단 배포 환경 구성하기"}}},{"node":{"id":"dd095976-5a96-51b5-9686-8956dc60cd24","fields":{"slug":"/hikaricp-connection-pool-setting/"},"frontmatter":{"title":"HikariCp Connection Pool 값 설정"}}},{"node":{"id":"625ad76f-acb1-56cc-9baa-3d6f1a954ac2","fields":{"slug":"/pwa/"},"frontmatter":{"title":"PWA를 도입해보자"}}},{"node":{"id":"6a12651c-e6b8-5fa6-9c57-766772d32680","fields":{"slug":"/serviceworker/"},"frontmatter":{"title":"Service Worker에 대한 대략적인 이해"}}},{"node":{"id":"b9709447-61dc-52f0-95a5-8670a3fbaaf4","fields":{"slug":"/installPrompt/"},"frontmatter":{"title":"홈화면에 추가 안내 prompt 만들기"}}}]},"previous":{"fields":{"slug":"/http-cache/"},"frontmatter":{"title":"CloudFront와 HTTP 캐시"}},"next":{"fields":{"slug":"/query-analysis/"},"frontmatter":{"title":"서비스 내에서 발생하는 쿼리를 분석하고 개선하기"}}},"pageContext":{"id":"dbe47289-01f4-571d-9506-fbb92016f547","series":null,"previousPostId":"eafed74f-ff11-5af1-a589-e9dd2ccb5c8e","nextPostId":"7b830fe6-e2df-564a-926e-7f7800380336"}},"staticQueryHashes":[],"slicesMap":{}}